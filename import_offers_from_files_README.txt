Документация по скрипту import_offers_from_files.php

1. Назначение
Скрипт импортирует торговые предложения (ТП) для товаров каталога из CSV/XLSX файла и подтягивает цены из XML. 
Ключевые задачи:
- По данным из столбцов 3 и 18 формирует наименование модификации (склейка) и записывает его в свойство ТП с символьным кодом "modific" (Название свойства: "Наименование модификации").
- Поле NAME у ТП заполняется коротким названием из столбца 3 (без склейки).
- Цены ТП берутся из XML-файла catalogOven.xml по коду izd_code и записываются в базовый тип цены.
- ТП ищутся/обновляются по CODE/XML_ID (равным izd_code) c проверкой дублей и связкой с родительским товаром.

2. Где находится
Файл: /public_html/import_offers_from_files.php

3. Входные данные
3.1. Табличный файл (CSV или XLSX)
- Путь по умолчанию: /public_html/uploud-1c/1c-stocks.csv или /public_html/uploud-1c/1c-stocks.xlsx
- Колонки (1-based):
  - Колонка 2: код ТП (izd_code) — записывается в CODE и XML_ID элемента ТП
  - Колонка 3: краткое наименование модификации — записывается в NAME
  - Колонка 18: полное наименование модификации — используется для склейки с колонкой 3 и записью в свойство modific
- Склейка: name_long = trim( column3 + ' ' + column18 ), если обе части непустые
- Валидация строки: если любой из столбцов (2,3,18) пуст — строка пропускается
- CSV: разделитель определяется автоматически (";" или ",")

3.2. XML-файл цен
- Путь: /public_html/catalogOven.xml
- Ожидается структура, содержащая узлы <price> с: <izd_code> и <price>;
- Артикул товара (product id/артикул из 1С) берётся из родителя <product><id>.
- Скрипт строит соответствие izd_code → price и izd_code → article (id)

4. Выходные данные и изменения
- Для каждого ТП:
  - NAME = колонка 3 (краткое наименование)
  - Свойство modific = склейка колонок 3 + 18
  - CODE = izd_code; XML_ID = izd_code
  - Связь с товаром через свойство SKU (определяется автоматически через CCatalogSKU::GetInfoByProductIBlock)
  - Цена записывается/обновляется в базовый тип цены (CPrice)
- ТП создаются при отсутствии или обновляются при наличии; дубликаты фиксируются логом, обновляется первый найденный

5. Конфигурация (в коде)
- PRODUCT_IBLOCK_ID = 16 — ИБ товаров
- ARTICLE_PROPERTY_CODE = CML2_ARTICLE — свойство артикула у товара
- XLSX_BASENAME = 'uploud-1c/1c-stocks' — базовое имя файлов импорта
- Путь к CSV/XLSX формируется как DOCUMENT_ROOT + '/' + XLSX_BASENAME + '.csv/.xlsx'
- XML_PATH = '/catalogOven.xml'

6. Запуск
6.1. CLI (рекомендуется)
- Требуется установленный PHP CLI. Примеры:
  - /usr/local/bin/php8.2 import_offers_from_files.php --dry-run
  - /usr/local/bin/php8.2 import_offers_from_files.php --limit=100 --dry-run
  - /usr/local/bin/php8.2 import_offers_from_files.php
- Параметры CLI (парсятся в $_GET):
  - --file=<путь>            Явный путь к CSV/XLSX относительно корня сайта (начинается с '/') или относительный к DOCUMENT_ROOT
  - --basename=<имя>         Базовое имя без расширения (скрипт попробует .csv, затем .xlsx)
  - --dry-run                 Режим без записи изменений в БД
  - --limit=<N>               Обработать только первые N строк
  - --offset=<N>              Пропустить первые N строк

6.2. HTTP (менее предпочтительно)
- Вызов из браузера с GET-параметрами:
  - /import_offers_from_files.php?dry-run=Y
  - /import_offers_from_files.php?file=/uploud-1c/1c-stocks.xlsx

7. Логика обработки (пошагово)
1) Подготовка окружения Bitrix. При запуске из CLI скрипт выставляет $_SERVER['DOCUMENT_ROOT'] в директорию текущего файла.
2) Загрузка модулей iblock и catalog; проверка связки SKU для PRODUCT_IBLOCK_ID.
3) Загрузка XML-файла цен; построение справочников из него (izd_code → price, izd_code → article/id).
4) Чтение CSV/XLSX; построение массива строк вида: {izd_code, name_short (col3), name_long (col3 + ' ' + col18)}.
5) Резолв артикулов (article) по izd_code из XML. Группировка строк по артикулу товара.
6) Для каждого товара по артикулу: поиск или создание ТП.
   - Поиск существующего ТП по XML_ID/CODE и по связке с товаром
   - Если найден: Update(NAME, CODE, XML_ID) + SetPropertyValuesEx(modific) + upsertPrice()
   - Если не найден: Add() с NAME/CODE/XML_ID/связью + ensureCatalogProduct() + SetPropertyValuesEx(modific) + upsertPrice()
7) Итоговый лог: количество созданных/обновлённых/пропущенных, ошибки, режим (dry-run / apply)

8. Свойства и поля ТП
- NAME — краткое название (колонка 3)
- CODE — izd_code (из колонки 2)
- XML_ID — izd_code (из колонки 2)
- modific — свойство-строка, символьный код 'modific', содержит склейку колонок 3+18
- Связь с товаром — через свойство SKU (ID свойства берётся из CCatalogSKU::GetInfoByProductIBlock)

9. Вывод данных на сайте (шаблон)
- В шаблоне списка ТП: /local/components/dresscode/catalog.product.offers/templates/.default/template.php
- В колонке "Название" выводится значение свойства modific, при отсутствии — NAME.

10. Журналирование и сообщения
- Скрипт ведёт текстовый лог в stdout (консоль/браузер):
  - [OK] — успешные этапы
  - [WARN] — предупреждения (напр., не найдена цена для izd_code)
  - [ERR] — ошибки, из-за которых обработка прекращается
  - [ADD] — ТП создан
  - [UPD] — ТП обновлён (указаны NAME и modific)
  - [DUP] — найдены дубли ТП для одного izd_code; обновлён первый из них

11. Возврат и коды состояния
- При критической ошибке скрипт прерывается с HTTP-кодом 500 (в CLI просто выводит сообщение и exit).
- В штатном завершении печатает сводку и завершает с кодом 200 (в CLI — exit 0).

12. Зависимости и окружение
- Bitrix: модули iblock и catalog
- Доступ к БД и правам на изменения элементов и цен
- Доступность файлов: /uploud-1c/1c-stocks.csv|xlsx и /catalogOven.xml
- PHP CLI версии 7.4+ (желательно 8.x)

13. Частые проблемы и их решения
- "Bitrix prolog not found": запуск из неправильного каталога или некорректный DOCUMENT_ROOT. Запускайте из /public_html; в CLI скрипт выставляет DOCUMENT_ROOT автоматически, но если структура проекта отличается, подстройте путь к Bitrix.
- "Не найдено ни CSV, ни XLSX": убедитесь, что файл находится по умолчанию в /uploud-1c/ и называется 1c-stocks.xlsx или передайте параметр --file/--basename.
- "Не найдена цена" (WARN): в XML отсутствует узел <price> для указанного izd_code — такие строки пропускаются.
- Свойство modific не выводится на сайте: возможно, компонент не выбирает свойство; очистите кэш, проверьте шаблон и параметры компонента, при необходимости добавьте выборку свойства в result_modifier.php.

14. Примеры запуска
- Тест без записи: /usr/local/bin/php8.2 import_offers_from_files.php --dry-run
- Тест первых 50 строк: /usr/local/bin/php8.2 import_offers_from_files.php --limit=50 --dry-run
- Применение изменений: /usr/local/bin/php8.2 import_offers_from_files.php
- Явное указание файла: /usr/local/bin/php8.2 import_offers_from_files.php --file="/uploud-1c/1c-stocks.xlsx"
- Через basename: /usr/local/bin/php8.2 import_offers_from_files.php --basename="uploud-1c/1c-stocks"

15. Контрольная проверка после импорта
- В админке убедиться, что у ТП:
  - NAME соответствует колонке 3 файла
  - Свойство "Наименование модификации" (modific) содержит склейку 3+18
  - Цена установлена для базового типа
- На витрине в таблице ТП отображается значение из свойства modific (если есть), иначе NAME.
