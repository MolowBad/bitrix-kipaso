<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Документация: использование catalogOven.xml</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height: 1.6; color: #222; padding: 24px; }
    h1, h2, h3 { margin-top: 1.4em; }
    code, pre { background: #f6f8fa; padding: 2px 6px; border-radius: 4px; }
    pre { padding: 12px; overflow: auto; }
    .file { font-family: Consolas, Menlo, Monaco, monospace; font-size: 0.95em; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin: 12px 0; background: #fff; }
    .muted { color: #666; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #3730a3; margin-left: 6px; }
    ul { margin: 0.5em 0 0.5em 1.2em; }
    .path { color: #0b7285; }
  </style>
</head>
<body>
  <h1>Документация: использование файла catalogOven.xml</h1>
  <p>
    Центральный кэш с данными поставщика хранится в: <code class="file path">/public_html/catalogOven.xml</code>.
    Его обновляет специальный скрипт, а ряд рабочих сценариев (импорт, AJAX) читают из него цены, коды изделий, артикулы и др.
  </p>

  <h2>Обновление кэша</h2>
  <div class="card">
    <div class="file">/public_html/local/scripts/update_catalog_oven.php <span class="badge">обновление кэша</span></div>
    <p>
      Скачивает XML с официального URL поставщика, валидирует и атомарно обновляет 
      <code class="file">/public_html/catalogOven.xml</code>. Ведёт логи и создаёт бэкапы.
    </p>
    <ul>
      <li><b>Входные параметры (GET/CLI)</b>: <code>run=1</code> (запуск), <code>url=...</code> (нестандартный источник), <code>retries</code>, <code>timeout</code>, <code>dry</code>, <code>log</code>, <code>override_date</code></li>
      <li><b>Лог</b>: <code class="file">/public_html/upload/update_catalog_oven.log</code></li>
      <li><b>Бэкапы</b>: <code class="file">/public_html/upload/catalog_oven_backups/</code></li>
      <li><b>Блокировка запуска</b>: <code class="file">/public_html/upload/update_catalog_oven.lock</code></li>
      <li><b>Пример запуска</b>: <code>/local/scripts/update_catalog_oven.php?run=1</code></li>
    </ul>
  </div>

  <h2>Скрипты и файлы, которые ЧИТАЮТ catalogOven.xml</h2>

  <div class="card">
    <div class="file">/public_html/local/ajax/get_modification_price.php <span class="badge">AJAX</span></div>
    <p>
      Возвращает цену конкретной модификации товара по сочетанию <i>product_id</i> (из XML) и названия модификации.
      Читает <code class="file">/catalogOven.xml</code> потоково через <code>XMLReader</code>, сравнивает
      нормализованные названия модификаций (теги <code>&lt;name&gt;</code>/<code>&lt;n&gt;</code>) и отдаёт JSON.
    </p>
    <ul>
      <li><b>Вход</b>: <code>product_id</code>, <code>modification_name</code></li>
      <li><b>Выход</b>: JSON: <code>{ success, price, izd_code, modification_name, product_id }</code></li>
      <li><b>Путь к XML</b>: <code class="file">$_SERVER["DOCUMENT_ROOT"]."/catalogOven.xml"</code></li>
    </ul>
  </div>

  <div class="card">
    <div class="file">/public_html/import_offers_from_files.php <span class="badge">импорт ТП</span></div>
    <p>
      Импортирует торговые предложения из CSV/XLSX и подтягивает цены из <code class="file">catalogOven.xml</code>.
      Строит справочники: <code>izd_code → price</code> и <code>izd_code → article(id)</code>,
      создаёт/обновляет ТП (IBLOCK предложений), записывает цены в базовый тип.
    </p>
    <ul>
      <li><b>Читает XML</b>: <code class="file">/public_html/catalogOven.xml</code></li>
      <li><b>Ключевая логика</b>: сопоставление <code>izd_code</code> из файла и XML, обновление <code>NAME</code>, свойства <code>modific</code>, цены</li>
      <li><b>Документация</b>: <code class="file">/public_html/import_offers_from_files_README.txt</code></li>
    </ul>
  </div>

  <div class="card">
    <div class="file">/public_html/newPhpCatalog.php <span class="badge">импорт каталога</span></div>
    <p>
      Загружает из XML разделы и товары (категории, продукты, цены, изображения, характеристики и пр.).
      Использует данные из <code class="file">catalogOven.xml</code> для формирования структуры и свойств в ИБ <code>ID=16</code>.
      Внутри реализован сбор минимальных цен по товарам, сопоставление с артикулом/названием и запись свойств.
    </p>
    <ul>
      <li><b>Читает XML</b>: <code class="file">/public_html/catalogOven.xml</code></li>
      <li><b>Назначение</b>: импорт разделов/товаров, привязка картинок и свойств, попытки рассчёта итоговой цены</li>
    </ul>
  </div>

  <div class="card">
    <div class="file">/public_html/newPhpCatalogNew.php <span class="badge">импорт каталога</span></div>
    <p>
      Обновлённый вариант импорта каталога, также читает <code class="file">catalogOven.xml</code> для товаров/характеристик/документов.
      Содержит логику скачивания и прикрепления документов/сертификатов к товарам.
    </p>
    <ul>
      <li><b>Читает XML</b>: <code class="file">/public_html/catalogOven.xml</code></li>
      <li><b>Назначение</b>: импорт разделов/товаров, обработка документов/сертификатов, установка свойств</li>
    </ul>
  </div>

  <div class="card">
    <div class="file">Прочие варианты импортера <span class="badge">исторические версии</span></div>
    <p class="muted">
      В репозитории также присутствуют исторические/экспериментальные варианты импортера, которые обращаются к тому же файлу:
    </p>
    <ul>
      <li><code class="file">/public_html/newPhpCatalog — вариант с загрузкой фото.php</code></li>
      <li><code class="file">/public_html/newPhpCatalog — рабоя версия с загрузкой файлов.php</code></li>
      <li><code class="file">/public_html/newPhpCatalog(рабочая версия файла от 24.06).php</code></li>
    </ul>
    <p class="muted">Во всех указанных файлах путь к XML задаётся как <code>$_SERVER["DOCUMENT_ROOT"]."/catalogOven.xml"</code>, и выполняется проверка на существование файла перед парсингом.</p>
  </div>

  <h2>Конвенции и пути</h2>
  <ul>
    <li><b>Путь к кэшу</b>: <code class="file">/public_html/catalogOven.xml</code></li>
    <li><b>Обновление</b>: <code class="file">/public_html/local/scripts/update_catalog_oven.php?run=1</code></li>
    <li><b>Логи</b>: <code class="file">/public_html/upload/update_catalog_oven.log</code></li>
    <li><b>Бэкапы</b>: <code class="file">/public_html/upload/catalog_oven_backups/</code></li>
  </ul>
</body>
</html>
