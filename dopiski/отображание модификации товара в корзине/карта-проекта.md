# Отображение модификации товара в корзине (Mind Map)

## Поток данных
- Карточка товара (JS)
  - modification-cart.js
  - Формирует AJAX: `act=addCart`
  - Параметры: `id`, `q`, `modification`, `modification_price`
  - Fallback: `ajaxPath` → `/ajax.php`
- Сервер (ajax.php)
  - Функция `addToBasket(...)`
    - Поиск существующей позиции с той же модификацией
    - Создание/обновление элемента корзины
    - Установка цены
      - Если `modification_price` → `PRICE`, `BASE_PRICE`, `CUSTOM_PRICE='Y'`
      - Иначе `CCatalogProduct::GetOptimalPrice`
    - Порядок сохранения
      - `$item->setFields($fields)`
      - `$item->save()` (получить `BASKET_ID`)
      - `$propCollection->setProperty([MODIFICATION, MODIFICATION_PRICE])`
      - `$propCollection->save()`, повторное `$item->save()`
    - Логирование → `/upload/basket_debug.log`
    - Контрольная выборка из `BasketPropertyTable`
- Шаблоны корзины
  - `basket_table.php`
  - `basket_squares.php`
  - Чтение свойств
    - Прямая выборка из `Bitrix\\Sale\\Internals\\BasketPropertyTable` по `BASKET_ID`
    - Резерв: `$arElement['PROPS']`
    - Резерв-2: D7 API `getPropertyCollection()`
  - Отображение
    - Показывать блок при наличии `MODIFICATION`
    - Если есть `MODIFICATION_PRICE` — отобразить цену модификации

## Диагностика
- Эндпоинты
  - `act=listBasketItems`
    - Все элементы текущего FUSER с `PROPS`
  - `act=getBasketProps&basket_id=ID`
    - Свойства из `BasketPropertyTable`
  - `act=getBasketDebugLog&lines=N`
    - Последние N строк лога
- Лог `/upload/basket_debug.log`
  - Этапы сохранения
  - Проверка записей в БД (счётчик свойств)

## Типовые проблемы → решения
- Свойства не видны в корзине
  - Элемент создан до фикса порядка сохранения
  - Действие: удалить старую позицию и добавить заново
- Несовпадает `BASKET_ID`
  - Шаблон показывает другую позицию
  - Действие: сверить с `listBasketItems`
- Кеш мешает чтению
  - Тегированный кеш `sale_basket`
  - Действие: очистка кеша перед выборкой в шаблонах

## Расширение
- Новые свойства модификации
  - Добавить в массив `$propCollection->setProperty([...])`
  - Прочитать и вывести в шаблонах
- Локализация/формат цен
  - Приведение `MODIFICATION_PRICE` к числу при выводе

## Файлы и пути
- JS: `/local/components/dresscode/catalog.item/templates/detail/js/modification-cart.js`
- Сервер: `/ajax.php`
- Шаблоны:
  - `/local/templates/.default/components/dresscode/sale.basket.basket/standartOrder/view_templates/basket_table.php`
  - `/local/templates/.default/components/dresscode/sale.basket.basket/standartOrder/view_templates/basket_squares.php`
- Логи: `/upload/basket_debug.log`
