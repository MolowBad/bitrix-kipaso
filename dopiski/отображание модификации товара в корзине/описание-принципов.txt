Документация: Отображение модификации товара в корзине
Проект: Bitrix (sale + catalog), шаблоны dresscode
Дата: 2025-08-13

1. Цель
- Корректно сохранять свойства модификации при добавлении товара в корзину.
- Надёжно читать свойства и отображать блок модификации в шаблонах корзины.
- Исключать показ блока для товаров без модификаций.

2. Компоненты решения
2.1. Фронтенд (добавление в корзину)
- Файл: /local/components/dresscode/catalog.item/templates/detail/js/modification-cart.js
- Логика: при нажатии «Купить» формируется AJAX-запрос на ajax.php?act=addCart с параметрами:
  id (PRODUCT_ID), q (QUANTITY), modification (строка), modification_price (число).
- Fallback ajaxPath: если переменная ajaxPath не определена, используется "/ajax.php".

2.2. Сервер: ajax.php
- Файл: /ajax.php
- Основная функция: addToBasket(\Bitrix\Sale\Basket $basket, int $productId, float $quantity, string $currency, string $modification = '', ?float $modPrice = null)
- Ключевые моменты реализации:
  a) Поиск существующей позиции с тем же PRODUCT_ID и той же модификацией (если задана) и увеличение количества, иначе создание нового элемента.
  b) Установка цены:
     - Если передан modification_price → PRICE, BASE_PRICE и CUSTOM_PRICE='Y'.
     - Иначе вычисление цены через CCatalogProduct::GetOptimalPrice.
  c) Порядок сохранения (исправление):
     - Сначала $item->setFields($fields) и $item->save() — чтобы элемент получил валидный BASKET_ID.
     - Затем формируется массив свойств [MODIFICATION, MODIFICATION_PRICE] и устанавливается единым вызовом $propCollection->setProperty([...]).
     - Далее $propCollection->save() и повторное $item->save().
  d) Диагностика и логирование:
     - Запись в /upload/basket_debug.log этапов сохранения, включая проверку записей в Bitrix\Sale\Internals\BasketPropertyTable по BASKET_ID.
  e) Доп. диагностические эндпоинты:
     - act=listBasketItems — возвращает позиции корзины текущего пользователя с PROPS.
     - act=getBasketProps&basket_id=ID — возвращает свойства позиции напрямую из BasketPropertyTable.

2.3. Шаблоны корзины
- Файлы:
  /local/templates/.default/components/dresscode/sale.basket.basket/standartOrder/view_templates/basket_table.php
  /local/templates/.default/components/dresscode/sale.basket.basket/standartOrder/view_templates/basket_squares.php
- Чтение свойств:
  - Прямая выборка из Bitrix\Sale\Internals\BasketPropertyTable по BASKET_ID текущей позиции.
  - Резерв: поиск в $arElement["PROPS"].
  - Резерв-2: через D7 (Basket->getItemById()->getPropertyCollection()->getPropertyValues()).
- Отображение:
  - Блок показывается только если найдена MODIFICATION.
  - Если MODIFICATION_PRICE найден — выводится также цена модификации. Цена позиции берётся из $arElement["PRICE"].

3. Точки интеграции и сигнатуры
- addToBasket(..., string $modification = '', ?float $modPrice = null)
- Свойства:
  - CODE=MODIFICATION (string)
  - CODE=MODIFICATION_PRICE (float/decimal, хранится как строка, приводится при выводе)

4. Поток добавления товара
1) JS отправляет запрос на /ajax.php?act=addCart с параметрами id, q, modification, modification_price.
2) PHP (ajax.php): создаёт/обновляет элемент в корзине, сохраняет свойства и логирует результат.
3) В шаблоне корзины свойства читаются через BasketPropertyTable по BASKET_ID и отображаются.

5. Проверка и отладка
- Быстрая проверка текущих позиций и свойств:
  GET /ajax.php?act=listBasketItems
- Проверка свойств конкретной позиции:
  GET /ajax.php?act=getBasketProps&basket_id={ID}
- Хвост лога:
  GET /ajax.php?act=getBasketDebugLog&lines=200

6. Типовые проблемы и решения
- Свойства не видны в корзине: убедитесь, что элемент создан после фикса (сначала save(), затем setProperty/save()). Удалите старую позицию и добавьте снова.
- Разные BASKET_ID: проверяйте, что шаблон выводит актуальный ID. Сопоставляйте с listBasketItems.
- Кеш мешает чтению: в шаблонах предусмотрена очистка тегированного кеша sale_basket перед выборкой.

7. Безопасность и совместимость
- Используются стандартные ORM D7 и API Bitrix.
- Не сохраняются лишние данные, не выводятся ключи.
- Код совместим с PHP 7+ и модулем sale D7.

8. Как адаптировать под другие свойства
- Добавьте новые элементы в массив $set для $propCollection->setProperty([...]).
- В шаблоне добавьте соответствующие коды в выборку и вывод.

9. Контакты и поддержка
- Логи: /upload/basket_debug.log
- Основной обработчик: /ajax.php
- Шаблоны корзины: см. путь в пункте 2.3
