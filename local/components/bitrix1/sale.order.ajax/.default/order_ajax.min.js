BX.namespace("BX.Sale.OrderAjaxComponent"),BX.Sale&&BX.Sale.Input&&BX.Sale.Input.Utils&&(BX.Sale.Input.Utils.asMultiple=function(e){if(null==e||""===e)return[];if(e.constructor!==Array)return[e];for(var t,s=0,i=e.length;s<i;)null==(t=e[s])||""===t?(e.splice(s,1),--i):++s;return e.length?e:[""]}),BX.Sale.OrderAjaxComponent={initializePrimaryFields:function(){this.BXFormPosting=!1,this.regionBlockNotEmpty=!1,this.locationsInitialized=!1,this.locations={},this.cleanLocations={},this.locationsTemplate="",this.pickUpMapFocused=!1,this.options={},this.activeSectionId="",this.firstLoad=!0,this.initialized={},this.mapsReady=!1,this.lastSelectedDelivery=0,this.deliveryLocationInfo={},this.deliveryPagination={},this.deliveryCachedInfo=[],this.paySystemPagination={},this.validation={},this.hasErrorSection={},this.pickUpPagination={},this.timeOut={},this.isMobile=BX.browser.IsMobile(),this.isHttps="https:"===window.location.protocol,this.orderSaveAllowed=!1,this.socServiceHiddenNode=!1,this.selectedDeliveryID=0},init:function(e){this.initializePrimaryFields(),this.result=e.result||{},this.prepareLocations(e.locations),this.params=e.params||{},this.signedParamsString=e.signedParamsString||"",this.siteId=e.siteID||"",this.ajaxUrl=e.ajaxUrl||"",this.templateFolder=e.templateFolder||"",this.defaultBasketItemLogo=this.templateFolder+"/images/product_logo.png",this.defaultStoreLogo=this.templateFolder+"/images/pickup_logo.png",this.defaultDeliveryLogo=this.templateFolder+"/images/delivery_logo.svg",this.defaultPaySystemLogo=this.templateFolder+"/images/pay_system_logo.png",this.orderBlockNode=BX(e.orderBlockId),this.totalBlockNode=BX(e.totalBlockId),this.savedFilesBlockNode=BX("bx-soa-saved-files"),this.orderSaveBlockNode=BX("bx-soa-orderSave"),this.mainErrorsNode=BX("bx-soa-main-notifications"),this.authBlockNode=BX(e.authBlockId),this.authHiddenBlockNode=BX(e.authBlockId+"-hidden"),this.basketBlockNode=BX(e.basketBlockId),this.basketHiddenBlockNode=BX(e.basketBlockId+"-hidden"),this.regionBlockNode=BX(e.regionBlockId),this.regionHiddenBlockNode=BX(e.regionBlockId+"-hidden"),this.paySystemBlockNode=BX(e.paySystemBlockId),this.paySystemHiddenBlockNode=BX(e.paySystemBlockId+"-hidden"),this.deliveryBlockNode=BX(e.deliveryBlockId),this.deliveryHiddenBlockNode=BX(e.deliveryBlockId+"-hidden"),this.pickUpBlockNode=BX(e.pickUpBlockId),this.pickUpHiddenBlockNode=BX(e.pickUpBlockId+"-hidden"),this.propsBlockNode=BX(e.propsBlockId),this.propsHiddenBlockNode=BX(e.propsBlockId+"-hidden"),this.locationID=e.locationID||e.locationIDByIP,this.currency=e.currency,this.result.SHOW_AUTH&&(this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active"),this.authGenerateUser="Y"!==this.result.AUTH.new_user_registration_email_confirmation&&"Y"!==this.result.AUTH.new_user_phone_required),this.totalBlockNode&&(this.totalInfoBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total"),this.totalGhostBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total-ghost")),this.options.deliveriesPerPage=parseInt(e.params.DELIVERIES_PER_PAGE),this.options.paySystemsPerPage=parseInt(e.params.PAY_SYSTEMS_PER_PAGE),this.options.pickUpsPerPage=parseInt(e.params.PICKUPS_PER_PAGE),this.options.showWarnings=!!e.showWarnings,this.options.propertyValidation=!!e.propertyValidation,this.options.priceDiffWithLastTime=!1,this.options.pickUpMap=e.pickUpMap,this.options.propertyMap=e.propertyMap,this.options.totalPriceChanged=!1,this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection(),this.initOptions(),this.editOrder(),this.bindEvents(),this.orderBlockNode.removeAttribute("style"),this.basketBlockScrollCheck(),"Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("checkout"),"Y"===this.params.USER_CONSENT&&this.initUserConsent();e=this.orderSaveBlockNode.querySelector('[type="checkbox"]');if(e){let t=BX.findParent(BX.findParent(e),{class:"checkbox"});e.checked&&BX.addClass(t,"checked"),BX.UserConsent.onAccepted=function(){var e;this.current&&(e=this.current,this.saveConsent(this.current,function(){BX.onCustomEvent(e,this.events.accepted,[]),BX.onCustomEvent(this,this.events.accepted,[e]),this.isConsentSaved=!0,this.isFormSubmitted&&e.formNode&&!e.config.submitEventName&&BX.submit(e.formNode)}),BX.addClass(t,"checked"),this.current.inputNode.checked=!0,this.current=null)},BX.UserConsent.onRefused=function(){BX.onCustomEvent(this.current,this.events.refused,[]),BX.onCustomEvent(this,this.events.refused,[this.current]),this.current.inputNode.checked=!1,this.current=null,this.isFormSubmitted=!1,BX.removeClass(t,"checked")}}document.addEventListener("DOMContentLoaded",this.createFakeSelect),this.locationID&&document.addEventListener("DOMContentLoaded",this.changeLocation()),this.checkMinimumPrice(),$(".main-user-consent-request-announce-link").closest(".checkbox").click(function(){setTimeout(()=>{let e=document.querySelector(".main-user-consent-request-popup-buttons"),t=document.querySelector(".main-user-consent-request-popup-button-acc"),s=document.querySelector(".main-user-consent-request-popup-button-rej");var i=document.getElementById("bx-soa-order").classList.value;e?(i&&$(e).addClass(i),$(t).addClass("btn-simple btn-medium"),$(s).addClass("btn-simple btn-medium btn-border")):(e=document.querySelector(".main-user-consent-request-popup-buttons"),t=document.querySelector(".main-user-consent-request-popup-button-acc"),s=document.querySelector(".main-user-consent-request-popup-button-rej"))},10)}),console.log(this)},checkMinimumPrice:function(){this.switchOrderSaveButtons(Number(this.params.MIN_SUM_TO_PAYMENT)<=Number(this.result.TOTAL.ORDER_TOTAL_PRICE))},createFakeSelect:function(){var s=BX("bx-soa-order").querySelectorAll("select:not([multiple])");for(let e=0;e<s.length;e++){var o=[],r=s[e].querySelectorAll("option");let t=r[0].text,i=s[e].parentElement;BX.addClass(i,"select-input-container");for(let e=0;e<r.length;e++){r[e].selected&&(t=r[e].text);var l="select-fake-option-fake"+(r[e].selected?" option-fake-selected":"");o.push(BX.create("DIV",{props:{className:l},dataset:{value:r[e].value},text:r[e].text,events:{click:function(e){var t=i.querySelector("select");t.value=e.target.dataset.value,i.querySelector(".fake-select-value").innerText=e.target.innerText;var s=BX.findParent(e.target,{className:"list-options-fake"}).querySelector(".option-fake-selected");BX.removeClass(s,"option-fake-selected"),BX.addClass(e.target,"option-fake-selected"),BX.fireEvent(t,"change")}}}))}let a=BX.create("DIV",{props:{className:"list-options-fake"},children:o});var n=BX.create("DIV",{props:{className:"fake-select"},children:[BX.create("DIV",{props:{className:"fake-select-value"},text:t}),a],events:{click:function(e){var t=document.querySelectorAll(".list-options-fake"),s=BX.hasClass(a,"active");for(let e=0;e<t.length;e++)BX.removeClass(t[e],"active");s||(BX.addClass(a,"active"),BX.findParent(a,{className:"select-input-container"}))}}});BX.append(n,BX.findParent(s[e],"select-input-container"))}let t=document.querySelectorAll(".list-options-fake");document.addEventListener("click",function(e){if(!BX.hasClass(e.target,"fake-select-value"))for(let e=0;e<t.length;e++)BX.removeClass(t[e],"active")})},sendRequest:function(e,t){var s;this.startLoader()&&(this.firstLoad=!1,s={action:e=BX.type.isNotEmptyString(e)?e:"refreshOrderAjax",actionData:t,cancel:!1},BX.Event.EventEmitter.emit("BX.Sale.OrderAjaxComponent:onBeforeSendRequest",s),s.cancel?this.endLoader():"saveOrderAjax"===s.action?((e=BX("bx-soa-order-form"))&&(e.querySelector("input[type=hidden][name=sessid]").value=BX.bitrix_sessid()),BX.ajax.submitAjax(BX("bx-soa-order-form"),{url:this.ajaxUrl,method:"POST",dataType:"json",data:{via_ajax:"Y",action:"saveOrderAjax",sessid:BX.bitrix_sessid(),SITE_ID:this.siteId,signedParamsString:this.signedParamsString},onsuccess:BX.proxy(this.saveOrderWithJson,this),onfailure:BX.proxy(this.handleNotRedirected,this)})):BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:this.getData(s.action,s.actionData),onsuccess:BX.delegate(function(e){switch(e.redirect&&e.redirect.length&&(document.location.href=e.redirect),this.saveFiles(),s.action){case"refreshOrderAjax":this.refreshOrder(e);break;case"confirmSmsCode":case"showAuthForm":this.firstLoad=!0,this.refreshOrder(e),Array.isArray(e.order.ERROR)&&!e.order.ERROR.length&&location.reload();break;case"enterCoupon":e&&e.order?(this.deliveryCachedInfo=[],this.refreshOrder(e)):this.addCoupon(e);break;case"removeCoupon":e&&e.order?(this.deliveryCachedInfo=[],this.refreshOrder(e)):this.removeCoupon(e)}BX.cleanNode(this.savedFilesBlockNode),this.endLoader()},this),onfailure:BX.delegate(function(){this.endLoader()},this)}))},getData:function(e,t){var s={order:this.getAllFormData(),sessid:BX.bitrix_sessid(),via_ajax:"Y",SITE_ID:this.siteId,signedParamsString:this.signedParamsString};return"enterCoupon"!==(s[this.params.ACTION_VARIABLE]=e)&&"removeCoupon"!==e||(s.coupon=t),s},getAllFormData:function(){var e,t=BX("bx-soa-order-form"),s=BX.ajax.prepareForm(t);for(e in s.data)s.data.hasOwnProperty(e)&&""==e&&delete s.data[e];return s&&s.data?s.data:{}},refreshOrder:function(e){var t;return e.error?(this.showError(this.mainErrorsNode,e.error),this.animateScrollTo(this.mainErrorsNode,800,20)):e.order.SHOW_AUTH?(t=e.order.OK_MESSAGE&&e.order.OK_MESSAGE.length||e.order.SMS_AUTH&&"OK"===e.order.SMS_AUTH.TYPE?"bx-step-good":"bx-step-bad",this.addAnimationEffect(this.authBlockNode,t),BX.merge(this.result,e.order),this.editAuthBlock(),this.showAuthBlock(),this.showErrors(e.order.ERROR,!1),this.animateScrollTo(this.authBlockNode)):(this.isPriceChanged(e),t=this.getSelectedDelivery(),this.selectedDeliveryID==t.ID&&(this.deliveryCachedInfo=[]),this.result=e.order,this.prepareLocations(e.locations),this.locationsInitialized=!1,this.maxWaitTimeExpired=!1,this.pickUpMapFocused=!1,this.deliveryLocationInfo={},this.initialized={},this.clearHiddenBlocks(),this.initOptions(),this.editOrder(),this.mapsReady&&this.initMaps(),BX.saleOrderAjax&&BX.saleOrderAjax.initDeferredControl()),this.createFakeSelect(),this.checkMinimumPrice(),!0},saveOrderWithJson:function(e){var t=!1;e&&e.order&&((e=e.order).REDIRECT_URL?("Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("purchase",e.ID),(window.b24order=window.b24order||[]).push({id:e.ID,sum:this.result.TOTAL.ORDER_PRICE}),t=!0,location.href=e.REDIRECT_URL):e.SHOW_AUTH?(this.result.SHOW_AUTH=e.SHOW_AUTH,this.result.AUTH=e.AUTH,this.result.SMS_AUTH=e.SMS_AUTH,this.editAuthBlock(),this.showAuthBlock(),this.animateScrollTo(this.authBlockNode)):this.showErrors(e.ERROR,!0,!0)),t||this.handleNotRedirected()},handleNotRedirected:function(){this.endLoader(),this.disallowOrderSave()},startLoader:function(){return!0!==this.BXFormPosting&&(this.BXFormPosting=!0,this.loadingScreen||(this.loadingScreen=new BX.PopupWindow("loading_screen",null,{overlay:{backgroundColor:"white",opacity:1},events:{onAfterPopupShow:BX.delegate(function(){BX.cleanNode(this.loadingScreen.popupContainer),BX.removeClass(this.loadingScreen.popupContainer,"popup-window"),this.loadingScreen.popupContainer.appendChild(BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})),this.loadingScreen.popupContainer.removeAttribute("style"),this.loadingScreen.popupContainer.style.display="block"},this)}}),BX.addClass(this.loadingScreen.overlay.element,"bx-step-opacity")),this.loadingScreen.overlay.element.style.opacity="0",this.loadingScreen.show(),this.loadingScreen.overlay.element.style.opacity="0.6",!0)},endLoader:function(){this.BXFormPosting=!1,this.loadingScreen&&this.loadingScreen.isShown()&&this.loadingScreen.close()},htmlspecialcharsEx:function(e){return e.replace(/&amp;/g,"&amp;amp;").replace(/&lt;/g,"&amp;lt;").replace(/&gt;/g,"&amp;gt;").replace(/&quot;/g,"&amp;quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},saveFiles:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties)for(var e,t=this.result.ORDER_PROP.properties,s=0;s<t.length;s++)"FILE"==t[s].TYPE&&(e=this.orderBlockNode.querySelector('div[data-property-id-row="'+t[s].ID+'"]'))&&this.savedFilesBlockNode.appendChild(e)},animateScrollTo:function(e,t,s){var i,a;e&&(i=BX.GetWindowScrollPos().scrollTop,a=BX.pos(this.orderBlockNode),e=BX.pos(e).top-(this.isMobile?50:0),s&&(e-=parseInt(s)),e+window.innerHeight>a.bottom&&(e=a.bottom-window.innerHeight+17),new BX.easing({duration:t||800,start:{scroll:i},finish:{scroll:e},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(e){window.scrollTo(0,e.scroll)},this)}).animate())},checkKeyPress:function(e){if(13==e.keyCode){var t=e.target||e.srcElement;if(!t.getAttribute("data-send"))return(t=t.getAttribute("data-next"))&&(t=this.orderBlockNode.querySelector("input[name="+t+"]"))&&t.focus(),BX.PreventDefault(e)}},getSizeString:function(e,t){var s=1073741824;return e=parseInt(e),t=parseInt(t),s<e?parseFloat(e/s).toFixed(t)+" Gb":1048576<e?parseFloat(e/1048576).toFixed(t)+" Mb":1024<e?parseFloat(e/1024).toFixed(t)+" Kb":e+" B"},getFileAccepts:function(e){for(var t,s=[],i=e.split(","),a={json:"application/json",javascript:"application/javascript","octet-stream":"application/octet-stream",ogg:"application/ogg",pdf:"application/pdf",zip:"application/zip",gzip:"application/gzip",aac:"audio/aac",mp3:"audio/mpeg",gif:"image/gif",jpeg:"image/jpeg",png:"image/png",svg:"image/svg+xml",tiff:"image/tiff",css:"text/css",csv:"text/csv",html:"text/html",plain:"text/plain",php:"text/php",xml:"text/xml",mpeg:"video/mpeg",mp4:"video/mp4",quicktime:"video/quicktime",flv:"video/x-flv",doc:"application/msword",docx:"application/msword",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel"},o=0;o<i.length;o++)t=BX.util.trim(i[o]),s.push(a[t]||t);return s.join(",")},uniqueText:function(e,t){var s,i=[],a=(e=e||"").split(t=t||"<br>");for(a=BX.util.array_unique(a),s=0;s<a.length;s++)""!=a[s]&&i.push(BX.util.trim(a[s]));return i.join(t)},getImageSources:function(e,t){return!!(e&&t&&e[t])&&{src_1x:e[t+"_SRC"],src_2x:e[t+"_SRC_2X"],src_orig:e[t+"_SRC_ORIGINAL"]}},getErrorContainer:function(e){e&&e.appendChild(BX.create("DIV",{props:{className:"alert alert-danger"},style:{display:"none"}}))},showError:function(e,t,s){BX.type.isArray(t)&&(t=t.join("<br>"));var i=e.querySelector(".alert.alert-danger");i&&t.length&&(BX.cleanNode(i),i.appendChild(BX.create("DIV",{html:t})),!this.hasErrorSection[e.id]?(i.style.opacity=0,i.style.display="",new BX.easing({duration:300,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100},complete:function(){i.removeAttribute("style")}}).animate()):i.style.display="",s)&&BX.addClass(e,"bx-step-error")},showErrors:function(e,t,s){for(var i,a,o=this.orderBlockNode.querySelectorAll("div.alert.alert-danger"),r=0;r<o.length;r++)i=BX.findParent(o[r],{className:"bx-soa-section"}),BX.removeClass(i,"bx-step-error"),o[r].style.display="none",BX.cleanNode(o[r]);if(e&&!(BX.util.object_keys(e).length<1)){for(r in e)if(e.hasOwnProperty(r))switch(a=e[r],r.toUpperCase()){case"MAIN":this.showError(this.mainErrorsNode,a),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1;break;case"AUTH":"none"==this.authBlockNode.style.display?(this.showError(this.mainErrorsNode,a,!0),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1):this.showError(this.authBlockNode,a,!0);break;case"REGION":!s&&"true"!==this.regionBlockNode.getAttribute("data-visited")||(this.showError(this.regionBlockNode,a,!0),this.showError(this.regionHiddenBlockNode,a));break;case"DELIVERY":!s&&"true"!==this.deliveryBlockNode.getAttribute("data-visited")||(this.showError(this.deliveryBlockNode,a,!0),this.showError(this.deliveryHiddenBlockNode,a));break;case"PAY_SYSTEM":!s&&"true"!==this.paySystemBlockNode.getAttribute("data-visited")||(this.showError(this.paySystemBlockNode,a,!0),this.showError(this.paySystemHiddenBlockNode,a));break;case"PROPERTY":!s&&"true"!==this.propsBlockNode.getAttribute("data-visited")||(this.showError(this.propsBlockNode,a,!0),this.showError(this.propsHiddenBlockNode,a))}t&&this.scrollToError()}},showBlockErrors:function(e){var t,s,i=e.querySelector("div.alert.alert-danger");if(i){switch(BX.removeClass(e,"bx-step-error"),i.style.display="none",BX.cleanNode(i),e.id){case this.regionBlockNode.id:t=this.regionHiddenBlockNode,s=this.result.ERROR.REGION;break;case this.deliveryBlockNode.id:t=this.deliveryHiddenBlockNode,s=this.result.ERROR.DELIVERY;break;case this.paySystemBlockNode.id:t=this.paySystemHiddenBlockNode,s=this.result.ERROR.PAY_SYSTEM;break;case this.propsBlockNode.id:t=this.propsHiddenBlockNode,s=this.result.ERROR.PROPERTY}s&&BX.util.object_keys(s).length&&(this.showError(e,s,!0),this.showError(t,s))}},checkNotifications:function(){var e,t,s,i,a=this.mainErrorsNode.querySelector('[data-type="informer"]');a&&(this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?(e=(t=(t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active")).length&&"true"==t[t.length-1].getAttribute("data-visited"))?"success":"warning",t=(t?this.params.MESS_SUCCESS_PRELOAD_TEXT:this.params.MESS_FAIL_PRELOAD_TEXT).split("#ORDER_BUTTON#").join(this.params.MESS_ORDER),a.appendChild(BX.create("DIV",{props:{className:""},children:[BX.create("DIV",{props:{className:""},style:{position:"relative",paddingLeft:"48px"},children:[BX.create("DIV",{props:{className:"icon-"+e}}),BX.create("DIV",{html:t})]})]})),BX.addClass(a,"alert alert-"+e),a.style.display=""):BX.hasClass(a,"alert")&&(s=BX.GetWindowScrollPos().scrollTop,i=BX.pos(a),new BX.easing({duration:300,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.linear,step:function(e){a.style.opacity=e.opacity/100},complete:function(){s>i.top&&window.scrollBy(0,-(i.height+20)),a.style.display="none",BX.cleanNode(a),a.removeAttribute("class"),a.removeAttribute("style")}}).animate()))},checkPreload:function(e){var t;switch(e.id){case this.regionBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PERSON_TYPE;break;case this.paySystemBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PAY_SYSTEM;break;case this.deliveryBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.DELIVERY;break;case this.pickUpBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PICK_UP;break;default:t=!0}return t},checkBlockErrors:function(e){var t,s,i,a,o;if((t=BX(e.id+"-hidden"))&&(s=(i=t.querySelector("div.alert.alert-danger"))&&"none"!=i.style.display,i=t.querySelector("div.alert.alert-warning.alert-show"),!s))for(a=t.querySelectorAll("div.tooltip"),o=0;o<a.length;o++)if("opened"==a[o].getAttribute("data-state")){s=!0;break}return s?BX.addClass(e,"bx-step-error"):i?BX.addClass(e,"bx-step-warning"):BX.removeClass(e,"bx-step-error bx-step-warning"),!s},scrollToError:function(){var e,t,s=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active");for(e in s)if(s.hasOwnProperty(e)&&(t=s[e].querySelector(".alert.alert-danger"))&&"none"!=t.style.display){this.animateScrollTo(s[e]);break}},showWarnings:function(){for(var e=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active"),t=this.getSelectedDelivery(),s=0;s<e.length;s++)BX.removeClass(e[s],"bx-step-warning"),"false"==e[s].getAttribute("data-visited")&&BX.removeClass(e[s],"bx-step-completed");if(t&&t.CALCULATE_ERRORS?(BX.addClass(this.deliveryBlockNode,"bx-step-warning"),t="<strong>"+this.params.MESS_DELIVERY_CALC_ERROR_TITLE+"</strong>",this.params.MESS_DELIVERY_CALC_ERROR_TEXT.length&&(t+="<br><small>"+this.params.MESS_DELIVERY_CALC_ERROR_TEXT+"</small>"),this.showBlockWarning(this.deliveryBlockNode,t),this.showBlockWarning(this.deliveryHiddenBlockNode,t),this.activeSectionId!=this.deliveryBlockNode.id&&(BX.addClass(this.deliveryBlockNode,"bx-step-completed"),BX.bind(this.deliveryBlockNode.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this)))):BX.hasClass(this.deliveryBlockNode,"bx-step-warning")&&this.activeSectionId!=this.deliveryBlockNode.id&&BX.removeClass(this.deliveryBlockNode,"bx-step-warning"),this.result.WARNING&&this.options.showWarnings)for(s in this.result.WARNING)if(this.result.WARNING.hasOwnProperty(s))switch(s.toUpperCase()){case"DELIVERY":"true"===this.deliveryBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING[s],!0),this.showBlockWarning(this.deliveryHiddenBlockNode,this.result.WARNING[s],!0));break;case"PAY_SYSTEM":"true"===this.paySystemBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING[s],!0),this.showBlockWarning(this.paySystemHiddenBlockNode,this.result.WARNING[s],!0))}},notifyAboutWarnings:function(e){if(BX.type.isDomNode(e))switch(e.id){case this.deliveryBlockNode.id:this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING.DELIVERY,!0);break;case this.paySystemBlockNode.id:this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING.PAY_SYSTEM,!0)}},showBlockWarning:function(e,t,s){var i,a,o=e.querySelector(".alert.alert-danger"),r="";if(o){if(BX.type.isString(t))r=t;else for(i in t)t.hasOwnProperty(i)&&t[i]&&(r+=t[i]+"<br>");if(r){for(i in a=e.querySelectorAll(".alert.alert-warning"))if(a.hasOwnProperty(i)&&BX.type.isDomNode(a[i])&&-1!==a[i].innerHTML.indexOf(r))return;s=BX.create("DIV",{props:{className:"alert alert-warning"+(s?" alert-hide":" alert-show")},html:r}),BX.prepend(s,o.parentNode),BX.addClass(e,"bx-step-warning")}}},showPagination:function(e,t){if(t&&e){var s,i,a,o,r,l=[];switch(e){case"delivery":s=this.deliveryPagination;break;case"paySystem":s=this.paySystemPagination;break;case"pickUp":s=this.pickUpPagination}if(1<s.pages.length){for(l.push(BX.create("LI",{attrs:{"data-action":"prev","data-entity":e},props:{className:"bx-pag-prev"},html:1==s.pageNumber?"<span>"+this.params.MESS_NAV_BACK+"</span>":'<a href=""><span>'+this.params.MESS_NAV_BACK+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),i=0;i<s.pages.length;i++)o=(a=parseInt(i)+1)==s.pageNumber?"bx-active":"",l.push(BX.create("LI",{attrs:{"data-action":a,"data-entity":e},props:{className:o},html:'<a href=""><span>'+a+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}}));l.push(BX.create("LI",{attrs:{"data-action":"next","data-entity":e},props:{className:"bx-pag-next"},html:s.pageNumber==s.pages.length?"<span>"+this.params.MESS_NAV_FORWARD+"</span>":'<a href=""><span>'+this.params.MESS_NAV_FORWARD+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),r=BX.create("DIV",{props:{className:"bx-pagination"},children:[BX.create("DIV",{props:{className:"bx-pagination-container"},children:[BX.create("UL",{children:l})]})]}),t.appendChild(BX.create("DIV",{style:{clear:"both"}})),t.appendChild(r)}}},doPagination:function(e){var t=e.target||e.srcElement,t="LI"==t.tagName?t:BX.findParent(t,{tagName:"LI"}),s=t.getAttribute("data-action"),i=t.getAttribute("data-entity");return BX.hasClass(t,"bx-active")||("prev"!=s&&"next"!=s||(t=parseInt(BX.findParent(t).querySelector(".bx-active").getAttribute("data-action")),s="next"==s?++t:--t),"delivery"==i?this.showDeliveryItemsPage(s):"paySystem"==i?this.showPaySystemItemsPage(s):"pickUp"==i&&this.showPickUpItemsPage(s)),BX.PreventDefault(e)},showDeliveryItemsPage:function(e){this.getCurrentPageItems("delivery",e);var t,s,i,a,e=this.getSelectedDelivery();for(e&&e.ID&&(t=(t=this.deliveryBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]"))||BX.create("INPUT",{props:{type:"hidden",name:"DELIVERY_ID",value:e.ID}})),s=this.deliveryBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(s),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(s)),i=0;i<this.deliveryPagination.currentPage.length;i++)a=this.createDeliveryItem(this.deliveryPagination.currentPage[i]),s.appendChild(a);this.showPagination("delivery",s)},showPaySystemItemsPage:function(e){this.getCurrentPageItems("paySystem",e);var t,s,i,a,e=this.getSelectedPaySystem();for(e&&e.ID&&(t=(t=this.paySystemBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]"))||BX.create("INPUT",{props:{type:"hidden",name:"PAY_SYSTEM_ID",value:e.ID}})),s=this.paySystemBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(s),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(s)),i=0;i<this.paySystemPagination.currentPage.length;i++)a=this.createPaySystemItem(this.paySystemPagination.currentPage[i]),s.appendChild(a);this.showPagination("paySystem",s)},showPickUpItemsPage:function(e){this.getCurrentPageItems("pickUp",e),this.editPickUpList(!1)},getCurrentPageItems:function(e,t){if(e&&void 0!==t){var s,i;switch(e){case"delivery":s=this.deliveryPagination,i=this.options.deliveriesPerPage;break;case"paySystem":s=this.paySystemPagination,i=this.options.paySystemsPerPage;break;case"pickUp":s=this.pickUpPagination,i=this.options.pickUpsPerPage}s&&0<i&&(t<=0||t>s.pages.length||(s.pageNumber=t,s.currentPage=s.pages.slice(s.pageNumber-1,s.pageNumber)[0]))}},initPropsListForLocation:function(){var e,t,s,i;if(BX.saleOrderAjax&&this.result.ORDER_PROP&&this.result.ORDER_PROP.properties)for(BX.saleOrderAjax.cleanUp(),e=0;e<this.result.ORDER_PROP.properties.length;e++)if("LOCATION"==(s=this.result.ORDER_PROP.properties[e]).TYPE&&"Y"==s.MULTIPLE&&"Y"!=s.IS_LOCATION)for(t=0;t<this.locations[s.ID].length;t++)BX.saleOrderAjax.addPropertyDesc({id:s.ID+"_"+t,attributes:{id:s.ID+"_"+t,type:s.TYPE,valueSource:"DEFAULT"==s.SOURCE?"default":"form"}});else i={id:s.ID,type:s.TYPE,valueSource:"DEFAULT"==s.SOURCE?"default":"form"},!this.deliveryLocationInfo.city&&0<parseInt(s.INPUT_FIELD_LOCATION)&&(i.altLocationPropId=parseInt(s.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.city=s.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.loc||"Y"!=s.IS_LOCATION||(this.deliveryLocationInfo.loc=s.ID),this.deliveryLocationInfo.zip||"Y"!=s.IS_ZIP||(i.isZip=!0,this.deliveryLocationInfo.zip=s.ID),BX.saleOrderAjax.addPropertyDesc({id:s.ID,attributes:i})},bindEvents:function(){BX.bind(this.orderSaveBlockNode.querySelector("[data-save-button]"),"click",BX.proxy(this.clickOrderSaveAction,this)),BX.bind(window,"scroll",BX.proxy(this.totalBlockScrollCheck,this)),BX.bind(window,"resize",BX.throttle(function(){this.totalBlockResizeCheck(),this.alignBasketColumns(),this.basketBlockScrollCheck(),this.mapsReady&&this.resizeMapContainers()},50,this)),BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(this.sendRequest,this))},initFirstSection:function(){var e=this.orderBlockNode.querySelector(".bx-soa-section.bx-active");this.activeSectionId=e.id},initOptions:function(){var e,t,s;if(this.initPropsListForLocation(),this.propertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.fadedPropertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.options.propertyValidation&&this.initValidation(),this.initPagination(),this.options.showPreviewPicInBasket=!1,this.options.showDetailPicInBasket=!1,this.options.showPropsInBasket=!1,this.options.showPriceNotesInBasket=!1,this.result.GRID&&this.result.GRID.HEADERS)for(e=this.result.GRID.HEADERS,t=0;t<e.length;t++)"PREVIEW_PICTURE"===e[t].id&&(this.options.showPreviewPicInBasket=!0),"DETAIL_PICTURE"===e[t].id&&(this.options.showDetailPicInBasket=!0),"PROPS"===e[t].id&&(this.options.showPropsInBasket=!0),"NOTES"===e[t].id&&(this.options.showPriceNotesInBasket=!0);this.result.TOTAL&&(s=this.result.TOTAL,this.options.showOrderWeight=s.ORDER_WEIGHT&&0<parseFloat(s.ORDER_WEIGHT),this.options.showPriceWithoutDiscount=parseFloat(s.ORDER_PRICE)<parseFloat(s.PRICE_WITHOUT_DISCOUNT_VALUE),this.options.showDiscountPrice=s.DISCOUNT_PRICE&&0<parseFloat(s.DISCOUNT_PRICE),this.options.showTaxList=s.TAX_LIST&&s.TAX_LIST.length,this.options.showPayedFromInnerBudget=s.PAYED_FROM_ACCOUNT_FORMATED&&s.PAYED_FROM_ACCOUNT_FORMATED.length)},reachGoal:function(e,t){var s=this.params.YM_GOALS_COUNTER||"";"Y"==this.params.USE_YM_GOALS&&void 0!==window["yaCounter"+s]&&(e=this.getGoalId(e,t),window["yaCounter"+s].reachGoal(e))},getGoalId:function(e,t){if(!e)return"";if("initialization"==e)return this.params.YM_GOALS_INITIALIZE;if("order"==e)return this.params.YM_GOALS_SAVE_ORDER;var s="",i="edit"==e;if(!t||!t.id)return"";switch(t.id){case this.basketBlockNode.id:s=i?this.params.YM_GOALS_EDIT_BASKET:this.params.YM_GOALS_NEXT_BASKET;break;case this.regionBlockNode.id:s=i?this.params.YM_GOALS_EDIT_REGION:this.params.YM_GOALS_NEXT_REGION;break;case this.paySystemBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PAY_SYSTEM:this.params.YM_GOALS_NEXT_PAY_SYSTEM;break;case this.deliveryBlockNode.id:s=i?this.params.YM_GOALS_EDIT_DELIVERY:this.params.YM_GOALS_NEXT_DELIVERY;break;case this.pickUpBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PICKUP:this.params.YM_GOALS_NEXT_PICKUP;break;case this.propsBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PROPERTIES:this.params.YM_GOALS_NEXT_PROPERTIES}return s},isPriceChanged:function(e){var t=null===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY||""===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?this.result.TOTAL.ORDER_TOTAL_PRICE:this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY,e=null===e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?e.order.TOTAL.ORDER_TOTAL_PRICE:e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY;this.options.totalPriceChanged=parseFloat(t)!=parseFloat(e)},initValidation:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties){var e,t=this.result.ORDER_PROP.properties,s={};for(e in t)t.hasOwnProperty(e)&&(s[t[e].ID]=t[e]);this.validation.properties=s}},initPagination:function(){var e,t,s,i;if(this.result.DELIVERY)if(this.result.DELIVERY=this.getDeliverySortedArray(this.result.DELIVERY),0<this.options.deliveriesPerPage&&this.result.DELIVERY.length>this.options.deliveriesPerPage){for(e=this.result.DELIVERY.slice(),t=Math.ceil(e.length/this.options.deliveriesPerPage),s=[],i=0;i<t;i++)s.push(e.splice(0,this.options.deliveriesPerPage));for(this.deliveryPagination.pages=s,i=0;i<this.result.DELIVERY.length;i++)if("Y"==this.result.DELIVERY[i].CHECKED){this.deliveryPagination.pageNumber=Math.ceil(++i/this.options.deliveriesPerPage);break}this.deliveryPagination.pageNumber=this.deliveryPagination.pageNumber||1,this.deliveryPagination.currentPage=s.slice(this.deliveryPagination.pageNumber-1,this.deliveryPagination.pageNumber)[0],this.deliveryPagination.show=!0}else this.deliveryPagination.pageNumber=1,this.deliveryPagination.currentPage=this.result.DELIVERY,this.deliveryPagination.show=!1;if(this.result.PAY_SYSTEM)if(0<this.options.paySystemsPerPage&&this.result.PAY_SYSTEM.length>this.options.paySystemsPerPage){for(e=this.result.PAY_SYSTEM.slice(),t=Math.ceil(e.length/this.options.paySystemsPerPage),s=[],i=0;i<t;i++)s.push(e.splice(0,this.options.paySystemsPerPage));for(this.paySystemPagination.pages=s,i=0;i<this.result.PAY_SYSTEM.length;i++)if("Y"==this.result.PAY_SYSTEM[i].CHECKED){this.paySystemPagination.pageNumber=Math.ceil(++i/this.options.paySystemsPerPage);break}this.paySystemPagination.pageNumber=this.paySystemPagination.pageNumber||1,this.paySystemPagination.currentPage=s.slice(this.paySystemPagination.pageNumber-1,this.paySystemPagination.pageNumber)[0],this.paySystemPagination.show=!0}else this.paySystemPagination.pageNumber=1,this.paySystemPagination.currentPage=this.result.PAY_SYSTEM,this.paySystemPagination.show=!1},initPickUpPagination:function(){var e,t,s,i,a=!1,o=!1,r=0;if(0<=this.options.pickUpsPerPage&&this.result.DELIVERY)for(r=0;r<this.result.DELIVERY.length;r++)if("Y"===this.result.DELIVERY[r].CHECKED&&this.result.DELIVERY[r].STORE_MAIN){o=0<this.result.DELIVERY[r].STORE_MAIN.length,a=this.result.DELIVERY[r].STORE_MAIN.length>this.options.pickUpsPerPage,o&&(e=this.getPickUpInfoArray(this.result.DELIVERY[r].STORE_MAIN));break}if(o)if(0<this.options.pickUpsPerPage&&a){for(t=e.slice(),s=Math.ceil(t.length/this.options.pickUpsPerPage),i=[],r=0;r<s;r++)i.push(t.splice(0,this.options.pickUpsPerPage));for(this.pickUpPagination.pages=i,r=0;r<e.length;r++)if(!this.result.BUYER_STORE||e[r].ID==this.result.BUYER_STORE){this.pickUpPagination.pageNumber=Math.ceil(++r/this.options.pickUpsPerPage);break}this.pickUpPagination.pageNumber||(this.pickUpPagination.pageNumber=1),this.pickUpPagination.currentPage=i.slice(this.pickUpPagination.pageNumber-1,this.pickUpPagination.pageNumber)[0],this.pickUpPagination.show=!0}else this.pickUpPagination.pageNumber=1,this.pickUpPagination.currentPage=e,this.pickUpPagination.show=!1},prepareLocations:function(e){var t,s,i,a;if(this.locations={},this.cleanLocations={},BX.util.object_keys(e).length)for(s in e)if(e.hasOwnProperty(s)){for(i in this.locationsTemplate=e[s].template||"",t=[],(a=e[s].output).clean&&(this.cleanLocations[s]=BX.processHTML(a.clean,!1),delete a.clean),a)a.hasOwnProperty(i)&&t.push({output:BX.processHTML(a[i],!1),showAlt:e[s].showAlt,lastValue:e[s].lastValue,coordinates:e[s].coordinates||!1});this.locations[s]=t}},locationsCompletion:function(){var e,t,s,i,a,o;for(e in this.locationsInitialized=!0,this.fixLocationsStyle(this.regionBlockNode,this.regionHiddenBlockNode),this.fixLocationsStyle(this.propsBlockNode,this.propsHiddenBlockNode),this.locations)if(this.locations.hasOwnProperty(e)&&(t=this.orderBlockNode.querySelector('div[data-property-id-row="'+e+'"]'))){if(o=t.querySelector("div.bx-ui-sls-clear"),a=t.querySelector("div.bx-ui-slst-pool"),i=t.querySelector("input.bx-ui-sls-fake[type=text]"),a){s=a.querySelectorAll(".bx-ui-slst-input-block");for(let e=0;e<s.length;e++)BX.addClass(s[e],"select-area")}t.removeAttribute("style"),BX.addClass(a,"bx-sls"),this.bindValidation(e,t),o&&BX.bind(o,"click",function(e){var t,e=e.target||e.srcElement,e=BX.findParent(e,{tagName:"DIV",className:"form-group"});(t=e?e.querySelector("input.bx-ui-sls-fake[type=text]"):t)&&BX.fireEvent(t,"keyup")}),!this.firstLoad&&this.options.propertyValidation&&(a&&(o=this.validation.properties[e],a=this.getValidationData(o,t),o=BX.findParent(t,{className:"bx-soa-section"}))&&"true"==o.getAttribute("data-visited")&&this.isValidProperty(a),i)&&BX.fireEvent(i,"keyup")}this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?this.showActualBlock():this.result.SHOW_AUTH||this.changeVisibleContent(),this.checkNotifications()},fixLocationsStyle:function(e,t){if(e&&t){var s,e=this.activeSectionId==e.id?e:t,i=e.querySelectorAll("div.bx-sls div.dropdown-block.bx-ui-sls-input-block"),a=e.querySelectorAll("div.bx-slst div.dropdown-block.bx-ui-slst-input-block");if(i.length)for(s=0;s<i.length;s++)BX.addClass(i[s],"form-control");if(a.length)for(s=0;s<a.length;s++)BX.addClass(a[s],"form-control")}},clickOrderSaveAction:function(e){return!(Number(this.params.MIN_SUM_TO_PAYMENT)>Number(this.result.TOTAL.ORDER_TOTAL_PRICE))&&(this.isValidForm()&&(this.allowOrderSave(),"Y"===this.params.USER_CONSENT&&BX.UserConsent?BX.onCustomEvent("bx-soa-order-save",[]):this.doSaveAction()),BX.PreventDefault(e))},doSaveAction:function(){this.isOrderSaveAllowed()&&(this.reachGoal("order"),this.sendRequest("saveOrderAjax"))},clickNextAction:function(e){var t,s=e.target||e.srcElement,s=BX.findParent(s,{className:"bx-active"}),i=this.getNextSection(s);return this.reachGoal("next",s),this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!=i.next.getAttribute("data-visited")||(t=i.next.querySelector(".bx-soa-section-title-container"),BX.bind(t,"click",BX.proxy(this.showByClick,this)),(t=i.next.querySelector(".bx-soa-editstep"))&&(t.style.display=""),t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),i.next.id==t[t.length-1].id&&this.switchOrderSaveButtons(!0)),this.fade(s,i.next),this.show(i.next),BX.PreventDefault(e)},clickPrevAction:function(e){var t=e.target||e.srcElement,t=BX.findParent(t,{className:"bx-active"}),s=this.getPrevSection(t);return this.fade(t),this.show(s.next),this.animateScrollTo(s.next,800),BX.PreventDefault(e)},showAuthBlock:function(){var e=this.authBlockNode;BX(this.activeSectionId);this.show(e)},closeAuthBlock:function(){var e=this.authBlockNode,t=this.getNextSection(e).next;this.fade(e),BX.cleanNode(BX(t.id+"-hidden")),this.show(t)},shouldSkipSection:function(e){var t,s=!1;return s="Y"===this.params.SKIP_USELESS_BLOCK&&(e.id===this.pickUpBlockNode.id&&(t=this.getSelectedDelivery())&&(s=1===this.getPickUpInfoArray(t.STORE).length),e.id===this.deliveryBlockNode.id&&(s=this.result.DELIVERY&&1===this.result.DELIVERY.length&&0===this.result.DELIVERY[0].EXTRA_SERVICES.length&&!this.result.DELIVERY[0].CALCULATE_ERRORS),e.id===this.paySystemBlockNode.id)?this.result.PAY_SYSTEM&&1===this.result.PAY_SYSTEM.length&&"Y"!==this.result.PAY_FROM_ACCOUNT:s},getNextSection:function(e,t){if(!this.orderBlockNode||!e)return{};for(var s,i=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),a=0;a<i.length;a++)if(i[a].id===e.id&&i[a+1])return s=i[a+1],this.shouldSkipSection(s)?(this.markSectionAsCompleted(s),this.getNextSection(s,s)):{prev:e,next:s,skip:t};return{next:e}},markSectionAsCompleted:function(e){var t;this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!==e.getAttribute("data-visited")||(this.changeVisibleSection(e,!0),t=e.querySelector(".bx-soa-section-title-container"),BX.bind(t,"click",BX.proxy(this.showByClick,this))),e.setAttribute("data-visited","true"),BX.addClass(e,"bx-step-completed"),BX.remove(e.querySelector(".alert.alert-warning.alert-hide")),this.checkBlockErrors(e)},getPrevSection:function(e){if(!this.orderBlockNode||!e)return{};for(var t,s=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),i=0;i<s.length;i++)if(s[i].id===e.id&&s[i-1])return t=s[i-1],this.shouldSkipSection(t)?(this.markSectionAsCompleted(t),this.getPrevSection(t)):{prev:e,next:t};return{next:e}},addAnimationEffect:function(e,t,s){e&&t&&(this.timeOut[e.id]&&(clearTimeout(this.timeOut[e.id].timer),BX.removeClass(e,this.timeOut[e.id].className)),setTimeout(function(){BX.addClass(e,t)},10),this.timeOut[e.id]={className:t,timer:setTimeout(BX.delegate(function(){BX.removeClass(e,t),delete this.timeOut[e.id]},this),s||5e3)})},fade:function(t,s){if(t&&t.id&&this.activeSectionId==t.id){this.hasErrorSection[t.id]=!1;var e,i,a,o,r,l,n,c,p=t.offsetHeight;switch(t.id){case this.authBlockNode.id:this.authBlockNode.style.display="none",BX.removeClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editFadeBasketBlock();break;case this.regionBlockNode.id:this.editFadeRegionBlock();break;case this.paySystemBlockNode.id:BX.remove(this.paySystemBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadePaySystemBlock();break;case this.deliveryBlockNode.id:BX.remove(this.deliveryBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadeDeliveryBlock();break;case this.pickUpBlockNode.id:this.editFadePickUpBlock();break;case this.propsBlockNode.id:this.editFadePropsBlock()}BX.addClass(t,"bx-step-completed"),BX.removeClass(t,"bx-selected"),e=t.offsetHeight,t.style.height=p+"px",s&&(i=BX.GetWindowScrollPos().scrollTop,a=BX.pos(this.orderBlockNode),o=BX.pos(t),(c=BX(s.id+"-hidden")).style.left="-10000",c.style.position="absolute",this.orderBlockNode.appendChild(c),l=s.offsetHeight,n=c.offsetHeight+57,BX(t.id+"-hidden").parentNode.appendChild(c),c.removeAttribute("style"),c=e+n-p-l,0<(n=window.innerHeight-a.height-c)?r=a.top-n/2:(r=o.top>i?o.top:o.bottom+6-p+e)+window.innerHeight>a.bottom+25+c&&(r=a.bottom+25+c-window.innerHeight),r-=this.isMobile?50:0),new BX.easing({duration:s?800:600,start:{height:p,scrollTop:i},finish:{height:e,scrollTop:r},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){t.style.height=e.height+"px",s&&window.scrollTo(0,e.scrollTop)},complete:function(){t.style.height=""}}).animate(),this.checkBlockErrors(t)}},show:function(e){if(e&&e.id&&this.activeSectionId!=e.id){switch(this.activeSectionId=e.id,BX.removeClass(e,"bx-step-error bx-step-warning"),e.id){case this.authBlockNode.id:this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editActiveBasketBlock(!0),this.alignBasketColumns();break;case this.regionBlockNode.id:this.editActiveRegionBlock(!0);break;case this.deliveryBlockNode.id:this.editActiveDeliveryBlock(!0);break;case this.paySystemBlockNode.id:this.editActivePaySystemBlock(!0);break;case this.pickUpBlockNode.id:this.editActivePickUpBlock(!0);break;case this.propsBlockNode.id:this.editActivePropsBlock(!0)}"false"===e.getAttribute("data-visited")&&(this.showBlockErrors(e),this.notifyAboutWarnings(e)),e.setAttribute("data-visited","true"),BX.removeClass(e,"bx-step-completed")}},showByClick:function(e){var t=e.target||e.srcElement,s=BX.findParent(t,{className:"bx-active"}),t=BX(this.activeSectionId),i=BX.GetWindowScrollPos().scrollTop;return s&&!BX.hasClass(s,"bx-selected")&&(this.reachGoal("edit",s),t&&this.fade(t),this.show(s),setTimeout(BX.delegate(function(){BX.pos(s).top<i&&this.animateScrollTo(s,300)},this),320)),BX.PreventDefault(e)},showActualBlock:function(){for(var e=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),t=0;e[t];){if(e[t].id===this.regionBlockNode.id&&this.isValidRegionBlock(),e[t].id===this.propsBlockNode.id&&this.isValidPropertiesBlock(),!this.checkBlockErrors(e[t])||!this.checkPreload(e[t])){this.activeSectionId!==e[t].id&&(BX(this.activeSectionId)&&this.fade(BX(this.activeSectionId)),this.show(e[t]));break}BX.addClass(e[t],"bx-step-completed"),e[t].setAttribute("data-visited","true"),t++}},getBlockFooter:function(e){var t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),s=t[0],t=t[t.length-1],e=BX.findParent(e,{className:"bx-soa-section"}),i=!1,a=[];e&&"-1"==e.id.indexOf(s.id)&&a.push(BX.create("A",{props:{href:"javascript:void(0)",className:"pull-left btn btn-default btn-md"},html:this.params.MESS_BACK,events:{click:BX.proxy(this.clickPrevAction,this)}})),(i=e&&"-1"!=e.id.indexOf(t.id)?!0:i)||a.push(BX.create("A",{props:{href:"javascript:void(0)",className:"pull-right btn btn-default btn-md"},html:this.params.MESS_FURTHER,events:{click:BX.proxy(this.clickNextAction,this)}}))},getNewContainer:function(e){return BX.create("DIV",{props:{className:"bx-soa-section-content container-fluid"}})},switchOrderSaveButtons:function(e){var t=this.orderSaveBlockNode,s=this.totalBlockNode.querySelector(".bx-soa-cart-total-button-container");""==this.orderSaveBlockNode.style.display!=e&&(e?(t.style.opacity=0,t.style.display="",s&&(s.style.opacity=0,s.style.display=""),new BX.easing({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.linear,step:function(e){t.style.opacity=e.opacity/100,s&&(s.style.opacity=e.opacity/100)},complete:function(){t.removeAttribute("style"),s&&s.removeAttribute("style")}}).animate()):(t.style.display="none",s&&s.setAttribute("style","display: none !important")))},shouldBeSectionVisible:function(e,t){var s,i=!1;if(e&&e.length)for(;t<e.length;t++){if("true"==e[t].getAttribute("data-visited")){i=!0;break}if(!this.firstLoad&&(s=e[t].querySelector(".bx-soa-editstep"))&&"none"!==s.style.display){i=!0;break}}return i},changeVisibleContent:function(){for(var e,t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),s=!!this.result.IS_AUTHORIZED&&"Y"===this.params.USE_PRELOAD&&!0!==this.result.LAST_ORDER_DATA.FAIL,i=!0,a=0;a<t.length;a++)e=this.firstLoad&&s||this.shouldBeSectionVisible(t,a),this.changeVisibleSection(t[a],e),this.firstLoad&&i&&(e&&t[a+1]&&this.checkBlockErrors(t[a])&&(s&&this.checkPreload(t[a])||!s&&this.shouldSkipSection(t[a]))?(this.fade(t[a]),this.markSectionAsCompleted(t[a]),this.show(t[a+1])):i=!1);(!this.result.IS_AUTHORIZED||void 0!==this.result.LAST_ORDER_DATA.FAIL)&&"final_step"===this.params.SHOW_ORDER_BUTTON&&Number(this.params.MIN_SUM_TO_PAYMENT)<=Number(this.result.TOTAL.ORDER_TOTAL_PRICE)&&this.switchOrderSaveButtons(this.shouldBeSectionVisible(t,t.length-1))},changeVisibleSection:function(e,t){var s;e.id!==this.basketBlockNode.id&&(s=e.querySelector(".bx-soa-section-content"))&&(s.style.display=t?"":"none"),(s=e.querySelector(".bx-soa-editstep"))&&(s.style.display=t?"":"none"),(s=e.querySelector(".bx-soa-section-title-container"))&&!t&&BX.unbindAll(s)},clearHiddenBlocks:function(){BX.remove(BX.lastChild(this.authHiddenBlockNode)),BX.remove(BX.lastChild(this.basketHiddenBlockNode)),BX.remove(BX.lastChild(this.regionHiddenBlockNode)),BX.remove(BX.lastChild(this.paySystemHiddenBlockNode)),BX.remove(BX.lastChild(this.deliveryHiddenBlockNode)),BX.remove(BX.lastChild(this.pickUpHiddenBlockNode)),BX.remove(BX.lastChild(this.propsHiddenBlockNode))},editOrder:function(){if(this.orderBlockNode&&this.result){0<this.result.DELIVERY.length?(BX.addClass(this.deliveryBlockNode,"bx-active"),this.deliveryBlockNode.removeAttribute("style")):(BX.removeClass(this.deliveryBlockNode,"bx-active"),this.deliveryBlockNode.style.display="none"),this.orderSaveBlockNode.style.display=this.result.SHOW_AUTH?"none":"",this.checkPickUpShow();var e=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(t in e)e.hasOwnProperty(t)&&this.editSection(e[t]);this.editTotalBlock(),this.totalBlockFixFont(),this.showErrors(this.result.ERROR,!1),this.showWarnings();var t,s=this.orderBlockNode.querySelectorAll(".bx-soa-editstep");for(t in s)s.hasOwnProperty(t)&&BX.remove(s[t])}},editSection:function(e){if(e&&e.id){this.result.SHOW_AUTH&&e.id!=this.authBlockNode.id&&e.id!=this.basketBlockNode.id?e.style.display="none":e.id!=this.pickUpBlockNode.id&&(e.style.display="");e.querySelector(".bx-soa-section-title-container");var t=e.querySelector(".alert.alert-danger");switch(this.hasErrorSection[e.id]=t&&"none"!=t.style.display,e.id){case this.authBlockNode.id:this.editAuthBlock();break;case this.basketBlockNode.id:this.editBasketBlock(!0);break;case this.regionBlockNode.id:this.editRegionBlock(!0);break;case this.paySystemBlockNode.id:this.editPaySystemBlock(!0);break;case this.deliveryBlockNode.id:this.editDeliveryBlock(!0);break;case this.pickUpBlockNode.id:this.editPickUpBlock(!0);break;case this.propsBlockNode.id:this.editPropsBlock(!0)}e.setAttribute("data-visited","true")}},editAuthBlock:function(){var e,t;this.authBlockNode&&(t=this.authBlockNode.querySelector(".bx-soa-section-content"),BX.hasClass(t,"reg")?(e=t,t=BX.firstChild(this.authHiddenBlockNode)):e=BX.firstChild(this.authHiddenBlockNode),BX.cleanNode(t),BX.cleanNode(e),this.result.SHOW_AUTH?(this.getErrorContainer(t),this.editAuthorizeForm(t),this.editSocialContent(t),this.getAuthReference(t),this.getErrorContainer(e),this.editRegistrationForm(e),this.getAuthReference(e)):(BX.onCustomEvent("OnBasketChange"),this.closeAuthBlock()),this.result.OK_MESSAGE)&&this.result.OK_MESSAGE.length&&(this.toggleAuthForm({target:this.authBlockNode.querySelector("input[type=submit]")}),t=BX.create("DIV",{props:{className:"alert alert-success"},text:this.result.OK_MESSAGE.join()}),this.result.OK_MESSAGE="",BX.prepend(t,this.authBlockNode.querySelector(".bx-soa-section-content")))},editAuthorizeForm:function(e){var t=this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{attrs:{"data-next":"USER_PASSWORD"},props:{name:"USER_LOGIN",type:"text",value:this.result.AUTH.USER_LOGIN,maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),s=this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"USER_PASSWORD",type:"password",value:"",maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),i=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"checkbox"},children:[BX.create("LABEL",{props:{className:"bx-filter-param-label"},children:[BX.create("INPUT",{props:{type:"checkbox",name:"USER_REMEMBER",value:"Y"}}),BX.create("SPAN",{props:{className:"bx-filter-param-text"},text:BX.message("STOF_REMEMBER")})]})],events:{click:function(){BX.findChild(this,{tag:"input"},!0).checked?BX.addClass(this,"checked"):BX.removeClass(this,"checked")}}})]}),a=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_authorize",type:"hidden",name:"do_authorize",value:"N"}}),BX.create("INPUT",{props:{type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_ENTER")},events:{click:BX.delegate(function(e){return BX("do_authorize").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)},this)}})]}),t=BX.create("DIV",{props:{className:"bx-authform"},children:[BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_AUTH_REQUEST")}),t,s,i,a,BX.create("A",{props:{href:this.params.PATH_TO_AUTH+"?forgot_password=yes&back_url="+encodeURIComponent(document.location.href)},text:BX.message("STOF_FORGET_PASSWORD")})]});e.appendChild(BX.create("DIV",{props:{className:""},children:[t]}))},createAuthFormInputContainer:function(e,t,s){var i="";return s&&(i+='<span class="bx-authform-starrequired">*</span>'),e+=i,BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},html:e}),BX.create("DIV",{props:{className:"bx-authform-input-container"},children:[t]})]})},activatePhoneAuth:function(){this.result.SMS_AUTH&&new BX.PhoneAuth({containerId:"bx_register_resend",errorContainerId:"bx_register_error",interval:60,data:{signedData:this.result.SMS_AUTH.SIGNED_DATA},onError:function(e){var t=BX("bx_register_error"),s=BX.findChildByClassName(t,"errortext");s.innerHTML="";for(var i=0;i<e.errors.length;i++)s.innerHTML=s.innerHTML+BX.util.htmlspecialchars(e.errors[i].message)+"<br>";t.style.display=""}})},editRegistrationForm:function(e){var t,s;this.result.AUTH&&(t=[],(s=this.result.SMS_AUTH&&"OK"===this.result.SMS_AUTH.TYPE)?(t.push(BX.create("DIV",{props:{className:"alert alert-success"},text:BX.message("STOF_REG_SMS_REQUEST")})),t.push(BX.create("INPUT",{props:{type:"hidden",name:"SIGNED_DATA",value:this.result.SMS_AUTH.SIGNED_DATA||""}})),t.push(this.createAuthFormInputContainer(BX.message("STOF_SMS_CODE"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"SMS_CODE",type:"text",size:40,value:""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{name:"code_submit_button",type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_SEND")},events:{click:BX.delegate(function(e){return this.sendRequest("confirmSmsCode"),BX.PreventDefault(e)},this)}})]})),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{id:"bx_register_error"},style:{display:"none"}}),BX.create("DIV",{props:{id:"bx_register_resend"}})]}))):(t.push(BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_REG_REQUEST")})),t.push(this.createAuthFormInputContainer(BX.message("STOF_NAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_LAST_NAME"},props:{name:"NEW_NAME",type:"text",size:40,value:this.result.AUTH.NEW_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_LASTNAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_EMAIL"},props:{name:"NEW_LAST_NAME",type:"text",size:40,value:this.result.AUTH.NEW_LAST_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_EMAIL"),BX.create("INPUT",{attrs:{"data-next":"PHONE_NUMBER"},props:{name:"NEW_EMAIL",type:"text",size:40,value:this.result.AUTH.NEW_EMAIL||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"==this.result.AUTH.new_user_email_required)),"Y"===this.result.AUTH.new_user_phone_auth&&t.push(this.createAuthFormInputContainer(BX.message("STOF_PHONE"),BX.create("INPUT",{attrs:{"data-next":"captcha_word"},props:{name:"PHONE_NUMBER",type:"text",size:40,value:this.result.AUTH.PHONE_NUMBER||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"===this.result.AUTH.new_user_phone_required)),this.authGenerateUser&&(t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_N"},children:[BX.create("INPUT",{attrs:{checked:!this.authGenerateUser},props:{id:"NEW_GENERATE_N",type:"radio",name:"NEW_GENERATE",value:"N"}}),BX.message("STOF_MY_PASSWORD")],events:{change:BX.delegate(function(){this.authBlockNode.querySelector(".generated").style.display="",this.authGenerateUser=!1},this)}})),t.push(BX.create("BR")),t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_Y"},children:[BX.create("INPUT",{attrs:{checked:this.authGenerateUser},props:{id:"NEW_GENERATE_Y",type:"radio",name:"NEW_GENERATE",value:"Y"}}),BX.message("STOF_SYS_PASSWORD")],events:{change:BX.delegate(function(){this.authBlockNode.querySelector(".generated").style.display="none",this.authGenerateUser=!0},this)}}))),t.push(BX.create("DIV",{props:{className:"generated"},style:{display:this.authGenerateUser?"none":""},children:[this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{props:{name:"NEW_LOGIN",type:"text",size:30,value:this.result.AUTH.NEW_LOGIN||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_RE_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD_CONFIRM",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)]})),"Y"==this.result.AUTH.captcha_registration&&t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},children:[BX.create("SPAN",{props:{className:"bx-authform-starrequired"},text:"*"}),BX.message("CAPTCHA_REGF_PROMT"),BX.create("DIV",{props:{className:"bx-captcha"},children:[BX.create("INPUT",{props:{name:"captcha_sid",type:"hidden",value:this.result.AUTH.capCode||""}}),BX.create("IMG",{props:{src:"/bitrix/tools/captcha.php?captcha_sid="+this.result.AUTH.capCode,alt:""}})]})]}),BX.create("DIV",{props:{className:"bx-authform-input-container"},children:[BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"captcha_word",type:"text",size:"30",maxlength:"50",value:""},events:{keypress:BX.proxy(this.checkKeyPress,this)}})]})]})),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_register",name:"do_register",type:"hidden",value:"N"}}),BX.create("INPUT",{props:{type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_REGISTER")},events:{click:BX.delegate(function(e){return BX("do_register").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)},this)}}),BX.create("A",{props:{className:"btn btn-link",href:""},text:BX.message("STOF_DO_AUTHORIZE"),events:{click:BX.delegate(function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)},this)}})]}))),e.appendChild(BX.create("DIV",{props:{className:"col-md-12"},children:[BX.create("DIV",{props:{className:"bx-authform"},children:t})]})),s)&&this.activatePhoneAuth()},editSocialContent:function(e){var t,s;BX("bx-soa-soc-auth-services")&&(!(t=[])===this.socServiceHiddenNode&&(s=BX("bx-soa-soc-auth-services").querySelector(".bx-authform-social"),BX.type.isDomNode(s))&&(this.socServiceHiddenNode=s.innerHTML,BX.remove(s)),this.socServiceHiddenNode&&t.push(BX.create("DIV",{props:{className:"bx-authform-social"},html:'<h3 class="bx-title">'+BX.message("SOA_DO_SOC_SERV")+"</h3>"+this.socServiceHiddenNode})),"Y"===this.result.AUTH.new_user_registration&&t.push(BX.create("DIV",{props:{className:"bx-soa-reg-block"},children:[BX.create("P",{html:this.params.MESS_REGISTRATION_REFERENCE}),BX.create("A",{props:{className:"btn btn-default btn-lg"},text:BX.message("STOF_DO_REGISTER"),events:{click:BX.delegate(function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)},this)}})]})),e.appendChild(BX.create("DIV",{props:{className:""},children:t})))},getAuthReference:function(e){e.appendChild(BX.create("DIV",{props:{className:""},children:[BX.create("DIV",{props:{className:"bx-soa-reference col-xs-12"},children:[this.params.MESS_AUTH_REFERENCE_1,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_2,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_3]})]}))},toggleAuthForm:function(e){var t,s,i;e&&(e=e.target||e.srcElement,t=BX.findParent(e,{className:"bx-soa-section"}),s=BX.findParent(e,{className:"bx-soa-section-content"}),i=BX.firstChild(this.authHiddenBlockNode),new BX.easing({duration:100,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.opacity=e.opacity/100}}).animate(),this.authHiddenBlockNode.appendChild(s),BX.cleanNode(t),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-section-title-container"},children:[BX.create("h2",{props:{className:"bx-soa-section-title"},html:BX.hasClass(i,"reg")?this.params.MESS_REG_BLOCK_NAME:this.params.MESS_AUTH_BLOCK_NAME})]})),i.style.opacity=0,t.appendChild(i),setTimeout(function(){new BX.easing({duration:100,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){i.style.opacity=e.opacity/100},complete:function(){i.style.height="",i.style.opacity=""}}).animate()},110),this.animateScrollTo(t))},alignBasketColumns:function(){if(this.basketBlockNode){var e,t,s,i,a=0,o=BX.GetWindowInnerSize();if(580<o.innerWidth&&o.innerWidth<992){if((s=this.basketBlockNode.querySelectorAll(".bx-soa-basket-info")).length&&(!(t=s[0].querySelectorAll(".bx-soa-item-properties")).length||""==t[0].style.width)&&0<(o=t.length))for(i=parseInt(100/(4<o?4:o));a<s.length;a++)for(t=s[a].querySelectorAll(".bx-soa-item-properties"),e=0;e<t.length;e++)t[e].style.width=i+"%"}else if(!(t=this.basketBlockNode.querySelectorAll(".bx-soa-item-properties")).length||""!=t[0].style.width)for(;a<t.length;a++)t[a].style.width=""}},editBasketBlock:function(e){this.basketBlockNode&&this.basketHiddenBlockNode&&this.result.GRID&&(BX.remove(BX.lastChild(this.basketBlockNode)),BX.remove(BX.lastChild(this.basketHiddenBlockNode)),this.editActiveBasketBlock(e),this.editFadeBasketBlock(e),this.initialized.basket=!0)},editActiveBasketBlock:function(e){var t,s,e=e?this.basketBlockNode:this.basketHiddenBlockNode;this.initialized.basket?(this.basketHiddenBlockNode.appendChild(BX.lastChild(e)),e.appendChild(BX.firstChild(this.basketHiddenBlockNode))):(t=e.querySelector(".bx-soa-section-content"),s=BX.create("DIV",{props:{className:"bx-soa-item-table"}}),t?BX.cleanNode(t):(t=this.getNewContainer(),e.appendChild(t)),this.editBasketItems(s,!0),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden",minWidth:"100%"},children:[s]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCoupons(t),this.getBlockFooter(t),BX.bind(t.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editFadeBasketBlock:function(e){var t,s,e=e?this.basketHiddenBlockNode:this.basketBlockNode;this.initialized.basket?(this.basketHiddenBlockNode.appendChild(e.querySelector(".bx-soa-section-content")),this.basketBlockNode.appendChild(BX.firstChild(this.basketHiddenBlockNode))):(t=this.getNewContainer(),s=BX.create("DIV",{props:{className:"bx-soa-item-table"}}),this.editBasketItems(s,!1),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden"},children:[s]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCouponsFade(t),e.appendChild(t),this.alignBasketColumns(),this.basketBlockScrollCheck(),BX.bind(this.basketBlockNode.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editBasketItems:function(e,t){if(this.result.GRID.ROWS){var s,i=0;for(s in"Y"===this.params.SHOW_BASKET_HEADERS&&this.editBasketItemsHeader(e),this.result.GRID.ROWS)this.result.GRID.ROWS.hasOwnProperty(s)&&this.createBasketItem(e,this.result.GRID.ROWS[s],i++,!!t)}},editBasketItemsHeader:function(e){if(e){for(var t,s,i=[BX.create("DIV",{props:{className:"bx-soa-item-td"},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:BX.message("SOA_SUM_NAME")})]})],a=0,o=0;o<this.result.GRID.HEADERS.length;o++)"NAME"!==(s=this.result.GRID.HEADERS[o]).id&&"PREVIEW_PICTURE"!==s.id&&"PROPS"!==s.id&&"NOTES"!==s.id&&("DETAIL_PICTURE"!==s.id||this.options.showPreviewPicInBasket)&&(t=BX.util.in_array(s.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),i.push(BX.create("DIV",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(t?" bx-text-right":"")},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:s.name})]})),4==++a)&&this.result.GRID.HEADERS[o+1]&&(i.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),a=0);e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr"},children:i}))}},createBasketItem:function(e,t,s,i){var a,o,r,l=[],n=[],c=[],p=0;for((this.options.showPreviewPicInBasket||this.options.showDetailPicInBasket)&&l.push(this.createBasketItemImg(t.data)),l.push(this.createBasketItemContent(t.data)),o=0;o<this.result.GRID.HEADERS.length;o++)"NAME"!==(a=this.result.GRID.HEADERS[o]).id&&"PREVIEW_PICTURE"!==a.id&&"PROPS"!==a.id&&"NOTES"!==a.id&&("DETAIL_PICTURE"!==a.id||this.options.showPreviewPicInBasket)&&(n.push(this.createBasketItemColumn(a,t,i)),4==++p)&&this.result.GRID.HEADERS[o+1]&&(n.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),p=0);if(i)for(o=0;o<this.result.GRID.HEADERS_HIDDEN.length;o++)r=this.createBasketItemHiddenColumn(this.result.GRID.HEADERS_HIDDEN[o],t),BX.type.isArray(r)?c=c.concat(r):r&&c.push(r);l=[BX.create("DIV",{props:{className:"bx-soa-item-td"},style:{minWidth:"300px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-block"},children:l})]})].concat(n),e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr bx-soa-basket-info"+(0==s?" bx-soa-item-tr-first":"")},children:l})),c.length&&e.appendChild(BX.create("DIV",{props:{className:"bx-soa-item-tr bx-soa-item-info-container"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td"},children:[BX.create("A",{props:{href:"",className:"bx-soa-info-shower"},html:this.params.MESS_ADDITIONAL_PROPS,events:{click:BX.proxy(this.showAdditionalProperties,this)}}),BX.create("DIV",{props:{className:"bx-soa-item-info-block"},children:[BX.create("TABLE",{props:{className:"bx-soa-info-block"},children:c})]})]})]}))},showAdditionalProperties:function(e){var t,s=e.target||e.srcElement,i=s.nextSibling,a=BX.findParent(s,{className:"bx-soa-item-tr bx-soa-item-info-container"}),s=a.offsetHeight;return(BX.hasClass(i,"bx-active")?new BX.easing({duration:300,start:{opacity:100,height:s},finish:{opacity:0,height:45},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100,i.style.height=e.height+"px",a.style.height=e.height+"px"},complete:function(){BX.removeClass(i,"bx-active"),i.removeAttribute("style"),a.removeAttribute("style")}}):(i.style.opacity=0,BX.addClass(i,"bx-active"),t=i.offsetHeight+s,BX.removeClass(i,"bx-active"),i.style.paddingTop="16px",new BX.easing({duration:300,start:{opacity:0,height:s},finish:{opacity:100,height:t},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100,i.style.height=e.height+"px",a.style.height=e.height+"px"},complete:function(){BX.addClass(i,"bx-active"),i.removeAttribute("style")}}))).animate(),BX.PreventDefault(e)},createBasketItemImg:function(e){var t,s;if(e)return s=BX.create("DIV",{props:{className:"bx-soa-item-imgcontainer"}}),e.PREVIEW_PICTURE_SRC&&e.PREVIEW_PICTURE_SRC.length?t=this.getImageSources(e,"PREVIEW_PICTURE"):e.DETAIL_PICTURE_SRC&&e.DETAIL_PICTURE_SRC.length&&(t=this.getImageSources(e,"DETAIL_PICTURE")),t&&t.src_2x?s.setAttribute("style",'background-image: url("'+t.src_1x+'");background-image: -webkit-image-set(url("'+t.src_1x+'") 1x, url("'+t.src_2x+'") 2x)'):(t=t&&t.src_1x||this.defaultBasketItemLogo,s.setAttribute("style",'background-image: url("'+t+'");')),"Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(s=BX.create("A",{props:{href:e.DETAIL_PAGE_URL},children:[s]})),BX.create("DIV",{props:{className:"bx-soa-item-img-block"},children:[s]})},createBasketItemContent:function(e){var t,s=e.NAME||"",s=this.htmlspecialcharsEx(s),i=e.PROPS||[],a=[];if("Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(s='<a href="'+e.DETAIL_PAGE_URL+'">'+s+"</a>"),this.options.showPropsInBasket&&i.length)for(var o in i)i.hasOwnProperty(o)&&(t=i[o].NAME||"",o=i[o].VALUE||"",a.push(BX.create("DIV",{props:{className:"bx-soa-item-td-title"},style:{textAlign:"left"},text:t})),a.push(BX.create("DIV",{props:{className:"bx-soa-item-td-text"},style:{textAlign:"left"},text:o})));return BX.create("DIV",{props:{className:"bx-soa-item-content"},children:a.length?[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:s}),BX.create("DIV",{props:{className:"bx-scu-container"},children:a})]:[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:s})]})},createBasketItemColumn:function(e,t,s){if(e&&t){var i,a=t.columns[e.id]?t.columns:t.data,o=BX.util.in_array(e.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),r=BX.create("DIV",{props:{className:"bx-soa-item-td-text"}});if("PRICE_FORMATED"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:a.PRICE_FORMATED})),0<parseFloat(a.DISCOUNT_PRICE)&&(r.appendChild(BX.create("BR")),r.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:a.BASE_PRICE_FORMATED}))),this.options.showPriceNotesInBasket&&s&&(r.appendChild(BX.create("BR")),r.appendChild(BX.create("SMALL",{text:a.NOTES})));else if("SUM"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},html:a.SUM})),0<parseFloat(a.DISCOUNT_PRICE)&&(r.appendChild(BX.create("BR")),r.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:a.SUM_BASE_FORMATED})));else if("DISCOUNT"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:a.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id)i=this.getImageSources(t.data,e.id),s=BX.create("IMG",{props:{src:i&&i.src_1x||this.defaultBasketItemLogo}}),i&&i.src_1x&&i.src_orig&&BX.bind(s,"click",BX.delegate(function(e){this.popupShow(e,i.src_orig)},this)),r.appendChild(s);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))r.appendChild(BX.create("SPAN",{html:a[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===a.PREVIEW_TEXT_TYPE?r.appendChild(BX.create("SPAN",{html:a.PREVIEW_TEXT||""})):r.appendChild(BX.create("SPAN",{text:a.PREVIEW_TEXT||""}));else{var l=a[e.id],n=[];if(BX.type.isArray(l)){for(var c in l)l.hasOwnProperty(c)&&("image"==l[c].type?n.push(this.getImageContainer(l[c].value,l[c].source)):"linked"==l[c].type?(r.appendChild(BX.create("SPAN",{html:l[c].value_format})),r.appendChild(BX.create("BR"))):l[c].value&&(r.appendChild(BX.create("SPAN",{html:l[c].value})),r.appendChild(BX.create("BR"))));n.length&&r.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:n})]}))}else l&&r.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(l)}))}return BX.create("DIV",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(o?" bx-text-right":"")},children:[r]})}},createBasketItemHiddenColumn:function(e,t){if(e&&t){var s,i,a,o=t.columns[e.id]?t.columns:t.data,r=BX.create("TD",{props:{className:"bx-soa-info-text"}});if("PROPS"!==e.id){if("PRICE_FORMATED"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:o.PRICE_FORMATED})),0<parseFloat(o.DISCOUNT_PRICE)&&(r.appendChild(BX.create("BR")),r.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:o.BASE_PRICE_FORMATED})));else if("SUM"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},text:o.SUM}));else if("DISCOUNT"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:o.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id||"PREVIEW_PICTURE"===e.id)s=this.getImageSources(t.data,e.id),i=BX.create("IMG",{props:{src:s&&s.src_1x||this.defaultBasketItemLogo},style:{maxWidth:"50%"}}),s&&s.src_1x&&s.src_orig&&BX.bind(i,"click",BX.delegate(function(e){this.popupShow(e,s.src_orig)},this)),r.appendChild(i);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))r.appendChild(BX.create("SPAN",{html:o[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===o.PREVIEW_TEXT_TYPE?r.appendChild(BX.create("SPAN",{html:o.PREVIEW_TEXT||""})):r.appendChild(BX.create("SPAN",{text:o.PREVIEW_TEXT||""}));else{var l=o[e.id],n=[];if(BX.type.isArray(l)){for(a in l)if(l.hasOwnProperty(a))if("image"==l[a].type)n.push(this.getImageContainer(l[a].value,l[a].source));else{if("linked"==l[a].type)r.appendChild(BX.create("SPAN",{html:l[a].value_format}));else{if(!l[a].value)return;r.appendChild(BX.create("SPAN",{html:l[a].value}))}r.appendChild(BX.create("BR"))}n.length&&r.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:n})]}))}else{if(!l)return;r.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(l)}))}}return BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},html:e.name+":&#160;"}),r]})}var c,p,h=[],d=t.data.PROPS;if(d&&d.length){for(a in d)d.hasOwnProperty(a)&&(c=d[a].NAME||"",0!=(p=d[a].VALUE||"").length)&&h.push(BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},html:c+":&#160;"}),BX.create("TD",{props:{className:"bx-soa-info-text"},html:BX.util.htmlspecialchars(p)})]}));return h}}},popupShow:function(e,t,s){this.popup&&this.popup.destroy();var o=this;this.popup=new BX.PopupWindow("bx-soa-image-popup",null,{lightShadow:!0,offsetTop:0,offsetLeft:0,closeIcon:{top:"3px",right:"10px"},autoHide:!0,bindOptions:{position:"bottom"},closeByEsc:!0,zIndex:100,events:{onPopupShow:function(){BX.create("IMG",{props:{src:s||t},events:{load:function(){var e,t,s,i,a=BX("bx-soa-image-popup-content");a&&(e=BX.GetWindowInnerSize(),t=this.isMobile?.5:.9,BX.cleanNode(a),a.appendChild(this),s=a.offsetHeight,i=a.offsetWidth,s>e.innerHeight*t&&(a.style.height=e.innerHeight*t+"px",a.style.width=i*(e.innerHeight*t/s)+"px",s=a.offsetHeight,i=a.offsetWidth),i>e.innerWidth*t&&(a.style.width=e.innerWidth*t+"px",a.style.height=s*(e.innerWidth*t/i)+"px"),a.style.height=a.offsetHeight+"px",a.style.width=a.offsetWidth+"px",o.popup.adjustPosition())}}})},onPopupClose:function(){this.destroy()}},content:BX.create("DIV",{props:{id:"bx-soa-image-popup-content"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]})}),this.popup.show()},getImageContainer:function(t,s){return BX.create("LI",{props:{className:"bx-img-item"},children:[BX.create("DIV",{props:{className:"bx-scu-itemColorBlock"},children:[BX.create("DIV",{props:{className:"bx-img-itemColor"},style:{backgroundImage:'url("'+t+'")'}})],events:{click:BX.delegate(function(e){this.popupShow(e,t,s)},this)}})]})},editCoupons:function(e){var t=this.getCouponsList(!0),s=this.getCouponsLabel(!0),t=BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-input"},dataset:{word:this.params.MESS_COUPON_USE},children:[BX.create("INPUT",{props:{className:"form-control bx-ios-fix",type:"text",placeholder:this.params.COUPON_PLACEHOLDER},events:{change:BX.delegate(function(e){e=BX.getEventTarget(e);e&&e.value&&(this.sendRequest("enterCoupon",e.value),e.value="")},this)}})]}),BX.create("SPAN",{props:{className:"bx-soa-coupon-item"},children:t})]});e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon"},children:[s,t]}))},editCouponsFade:function(e){var t,s;this.result.COUPON_LIST.length<1||(t=this.getCouponsList(!1)).length&&(s=this.getCouponsLabel(!1),s=BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-list"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-item"},children:[s].concat(t)})]})]}),e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon bx-soa-coupon-item-fixed"},children:[s]})))},getCouponsList:function(e){for(var t=[],s=0;s<this.result.COUPON_LIST.length;s++)(e||!e&&"APPLIED"==this.result.COUPON_LIST[s].JS_STATUS)&&t.push(this.getCouponNode({text:this.result.COUPON_LIST[s].COUPON,desc:this.result.COUPON_LIST[s].JS_CHECK_CODE,status:this.result.COUPON_LIST[s].JS_STATUS},e));return t},getCouponNode:function(e,t){var s,i,a=BX.util.htmlspecialchars(e.text)||"",o=e.desc&&e.desc.length?e.desc.charAt(0).toUpperCase()+e.desc.slice(1):BX.message("SOA_NOT_FOUND");switch((e.status||"BAD").toUpperCase()){case"ENTERED":s="used",i="warning";break;case"BAD":s=i="danger";break;default:s=i="success"}return BX.create("STRONG",{attrs:{"data-coupon":a,className:"bx-soa-coupon-item-"+s},children:t?[a||"",BX.create("SPAN",{props:{className:"bx-soa-coupon-remove"},events:{click:BX.delegate(function(e){e=e.target||e.srcElement,e=BX.findParent(e,{tagName:"STRONG"});e&&e.getAttribute("data-coupon")&&this.sendRequest("removeCoupon",e.getAttribute("data-coupon"))},this)}}),BX.create("SPAN",{props:{className:"bx-soa-tooltip bx-soa-tooltip-coupon bx-soa-tooltip-"+i+" tooltip top"},children:[BX.create("SPAN",{props:{className:"tooltip-arrow"}}),BX.create("SPAN",{props:{className:"tooltip-inner"},text:o})]})]:[a]})},getCouponsLabel:function(e){return BX.create("DIV",{props:{className:"bx-soa-coupon-label"},children:e?[BX.create("DIV",{props:{className:"coupon_img"}}),BX.create("LABEL",{html:this.params.MESS_USE_COUPON})]:[this.params.MESS_COUPON]})},addCoupon:function(e){for(var t=this.orderBlockNode.querySelectorAll(".bx-soa-coupon:not(.bx-soa-coupon-item-fixed) .bx-soa-coupon-item"),s=0;s<t.length&&!t[s].querySelector('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');s++)t[s].appendChild(this.getCouponNode({text:e},!0,"bx-soa-coupon-item-danger"))},removeCoupon:function(e){var t,s=this.orderBlockNode.querySelectorAll('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');for(t in s)s.hasOwnProperty(t)&&BX.remove(s[t])},editRegionBlock:function(e){if(this.regionBlockNode&&this.regionHiddenBlockNode&&this.result.PERSON_TYPE)if(e&&(this.editActiveRegionBlock(!0),this.regionBlockNotEmpty)||this.editFadeRegionBlock(),this.initialized.region=!0,"Y"!==this.params.SHOW_QUICK_LOCATIONS){e=this.regionBlockNode.querySelector(".quick-locations");BX.addClass(e,"hidden")}else{var t=this.regionBlockNode.querySelectorAll(".quick-location-tag");for(let e=0;e<t.length;e++)e>=this.params.COUNT_QUICK_LOCATIONS&&(t[e].style.display="none")}},editActiveRegionBlock:function(e){var t,s,i,e=e?this.regionBlockNode:this.regionHiddenBlockNode;this.initialized.region?(BX.remove(BX.lastChild(e)),e.appendChild(BX.firstChild(this.regionHiddenBlockNode))):((t=e.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),e.appendChild(t)),this.getErrorContainer(t),e=BX.create("DIV",{props:{className:"bx_soa_location"}}),s=BX.create("DIV",{props:{className:"regionCol"}}),i=BX.create("DIV",{props:{className:"regionRow"}}),this.getPersonTypeControl(i),this.getProfilesControl(i),s.appendChild(i),this.getDeliveryLocationInput(s),this.result.SHOW_AUTH||(this.regionBlockNotEmpty?(BX.addClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display=""):(BX.removeClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display="none",this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection())),e.appendChild(s),t.appendChild(e),this.getBlockFooter(t))},editFadeRegionBlock:function(){var e=this.regionBlockNode.querySelector(".bx-soa-section-content");this.initialized.region?this.regionHiddenBlockNode.appendChild(e):(this.editActiveRegionBlock(!1),BX.remove(BX.lastChild(this.regionBlockNode))),e=this.getNewContainer(!0),this.regionBlockNode.appendChild(e),this.editActiveRegionBlock(!0)},editFadeRegionContent:function(e){if(e&&this.locationsInitialized){var t,s,i,a,o,r=this.getSelectedPersonType(),l=this.regionHiddenBlockNode.querySelector(".alert.alert-danger"),n="",c=[],p="";for(a in BX.cleanNode(e),l&&e.appendChild(l.cloneNode(!0)),r&&r.NAME&&1<this.result.PERSON_TYPE.length&&(n+="<strong>"+this.params.MESS_PERSON_TYPE+":</strong> "+BX.util.htmlspecialchars(r.NAME)+"<br>"),r&&(l="PROPS_FADE_LIST_"+r.ID,c=this.params[l]||[]),this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(a))if("Y"==this.result.ORDER_PROP.properties[a].IS_LOCATION&&this.result.ORDER_PROP.properties[a].ID==this.deliveryLocationInfo.loc)t=this.result.ORDER_PROP.properties[a];else if("Y"==this.result.ORDER_PROP.properties[a].IS_ZIP&&this.result.ORDER_PROP.properties[a].ID==this.deliveryLocationInfo.zip)for(i=this.result.ORDER_PROP.properties[a],o=0;o<c.length;o++)if(c[o]==i.ID){p=(s=BX("zipProperty"))&&s.value&&s.value.length?s.value:BX.message("SOA_NOT_SPECIFIED");break}r=this.getLocationString(this.regionHiddenBlockNode),t&&r.length&&(n+="<strong>"+BX.util.htmlspecialchars(t.NAME)+":</strong> "+BX.util.htmlspecialchars(r)+"<br>"),i&&p.length&&(n+="<strong>"+BX.util.htmlspecialchars(i.NAME)+":</strong> "+BX.util.htmlspecialchars(p)),e.innerHTML+=n,"true"==this.regionBlockNode.getAttribute("data-visited")&&((l=this.isValidRegionBlock()).length?(BX.addClass(this.regionBlockNode,"bx-step-error"),this.showError(this.regionBlockNode,l)):BX.removeClass(this.regionBlockNode,"bx-step-error")),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))}},getSelectedPersonType:function(){var e,t,s,i=this.result.PERSON_TYPE.length,a=1==i?(a=this.regionBlockNode.querySelector("input[type=hidden][name=PERSON_TYPE]"))||this.regionHiddenBlockNode.querySelector("input[type=hidden][name=PERSON_TYPE]"):2==i?(a=this.regionBlockNode.querySelector("input[type=radio][name=PERSON_TYPE]:checked"))||this.regionHiddenBlockNode.querySelector("input[type=radio][name=PERSON_TYPE]:checked"):(a=this.regionBlockNode.querySelector("select[name=PERSON_TYPE] > option:checked"))||this.regionHiddenBlockNode.querySelector("select[name=PERSON_TYPE] > option:checked");if(a)for(s in t=a.value,this.result.PERSON_TYPE)if(this.result.PERSON_TYPE[s].ID==t){e=this.result.PERSON_TYPE[s];break}return e},getDeliveryLocationInput:function(e){var t,s,i,a,o,r,l,n,c;for(a in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(a)&&"Y"==(t=this.result.ORDER_PROP.properties[a]).IS_LOCATION){s=t.ID,i=parseInt(t.INPUT_FIELD_LOCATION);break}if((l=this.locations[s])&&l[0]&&l[0].output)for(a in this.regionBlockNotEmpty=!0,c='<label class="bx-soa-custom-label" for="soa-property-'+parseInt(s)+'">'+BX.util.htmlspecialchars(t.NAME)+("Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"")+(t.DESCRIPTION.length?" <small>("+BX.util.htmlspecialchars(t.DESCRIPTION)+")</small>":"")+"</label>",r=l[0].output,c=BX.create("DIV",{attrs:{"data-property-id-row":s},props:{className:"form-group bx-soa-location-input-container"},style:{visibility:"hidden"},html:c+r.HTML}),e.appendChild(c),e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"RECENT_DELIVERY_VALUE",value:l[0].lastValue}})),r.SCRIPT)r.SCRIPT.hasOwnProperty(a)&&BX.evalGlobal(r.SCRIPT[a].JS);if(l&&l[0]&&l[0].showAlt&&0<i)for(a in this.result.ORDER_PROP.properties)if(parseInt(this.result.ORDER_PROP.properties[a].ID)==i){o=this.result.ORDER_PROP.properties[a];break}o&&(c=BX.create("DIV",{attrs:{"data-property-id-row":o.ID},props:{className:"form-group bx-soa-location-input-container"}}),l="Y"==o.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",l+=BX.util.htmlspecialchars(o.NAME),l=BX.create("LABEL",{attrs:{for:"altProperty"},props:{className:"bx-soa-custom-label"},html:l}),n=BX.create("INPUT",{props:{id:"altProperty",type:"text",placeholder:o.DESCRIPTION,autocomplete:"off",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+o.ID,value:o.VALUE}}),c.appendChild(l),c.appendChild(n),e.appendChild(c),this.bindValidation(o.ID,c)),this.getZipLocationInput(e)},getLocationString:function(e){if(!e)return"";var t,s,i,a=e.querySelector(".bx-ui-sls-route"),o="";if(a&&a.value&&a.value.length)o=a.value;else{for(s=(t=e.querySelectorAll(".bx-ui-combobox-fake.bx-combobox-fake-as-input")).length;s--;)0<=t[s].innerHTML.indexOf("...")||(0<=t[s].innerHTML.indexOf("---")?(i=BX("altProperty"))&&i.value.length&&(o+=i.value):(o.length&&(o+=", "),o+=t[s].innerHTML));0==o.length&&(o=BX.message("SOA_NOT_SPECIFIED"))}return o},getZipLocationInput:function(e){var t,s,i,a,o;for(s in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(s)&&"Y"==this.result.ORDER_PROP.properties[s].IS_ZIP){t=this.result.ORDER_PROP.properties[s];break}t&&(this.regionBlockNotEmpty=!0,(i=BX.create("DIV",{props:{className:"form-group bx-soa-location-input-container"}})).setAttribute("data-property-id-row",t.ID),a="Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",a+=BX.util.htmlspecialchars(t.NAME),a=BX.create("LABEL",{attrs:{for:"zipProperty"},props:{className:"bx-soa-custom-label"},html:a}),o=BX.create("INPUT",{props:{id:"zipProperty",type:"text",placeholder:t.DESCRIPTION,autocomplete:"off",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+t.ID,value:t.VALUE}}),i.appendChild(a),i.appendChild(o),e.appendChild(i),e.appendChild(BX.create("input",{props:{id:"ZIP_PROPERTY_CHANGED",name:"ZIP_PROPERTY_CHANGED",type:"hidden",value:this.result.ZIP_PROPERTY_CHANGED||"N"}})),this.bindValidation(t.ID,i))},getPersonTypeSortedArray:function(e){var t,s=[];for(t in e)e.hasOwnProperty(t)&&s.push(e[t]);return s.sort(function(e,t){return parseInt(e.SORT)-parseInt(t.SORT)})},getPersonTypeControl:function(e){if(this.result.PERSON_TYPE){this.result.PERSON_TYPE=this.getPersonTypeSortedArray(this.result.PERSON_TYPE);var t,s,i,a,o=this.result.PERSON_TYPE.length,r=[],l=[];if(1<o&&(c=BX.create("DIV",{props:{className:"regionItem"},children:[BX.create("LABEL",{props:{className:"bx-soa-custom-label"},html:this.params.MESS_PERSON_TYPE})]}),e.appendChild(c),e=c),2<o){for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&("Y"==(a=this.result.PERSON_TYPE[s]).CHECKED&&a.NAME,r.push(BX.create("OPTION",{props:{value:a.ID,selected:"Y"==a.CHECKED},text:a.NAME})),l.push(BX.create("DIV",{props:{className:"select-fake-option-fake"},dataset:{selected:"Y"==a.CHECKED?"Y":"N",value:a.ID},text:a.NAME,events:{click:function(e){var t=BX.findParent(e.target,{className:"select-input-container"}).querySelector("select");t.value=e.target.dataset.value,BX.fireEvent(t,"change")}}})),"Y"==a.CHECKED)&&(t=a.ID);var n=BX.create("SELECT",{props:{name:"PERSON_TYPE",className:"form-control select-input"},children:r,events:{change:BX.proxy(this.sendRequest,this)}}),c=BX.create("DIV",{props:{className:"select-input-container"},children:[n]});e.appendChild(BX.create("DIV",{props:{className:"bx-soa-location-input-container"},children:[i,c]})),this.regionBlockNotEmpty=!0}else if(2==o){for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&(a=this.result.PERSON_TYPE[s],i=BX.create("LABEL",{children:[BX.create("INPUT",{attrs:{checked:"Y"==a.CHECKED},props:{type:"radio",name:"PERSON_TYPE",value:a.ID}}),BX.util.htmlspecialchars(a.NAME)],events:{change:BX.proxy(this.sendRequest,this)},props:{className:"btn-person-type"+("Y"==a.CHECKED?" btn-person-type-checked":"")}}),e.appendChild(BX.create("DIV",{props:{className:"radio-inline"},children:[i]})),"Y"==a.CHECKED)&&(t=a.ID);this.regionBlockNotEmpty=!0}else for(s in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(s)&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE",value:this.result.PERSON_TYPE[s].ID}}));t&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE_OLD",value:t}}))}},getProfilesControl:function(e){var t,s=BX.util.object_keys(this.result.USER_PROFILES).length,i=[];if(s)if("Y"===this.params.ALLOW_USER_PROFILES&&(1<s||"Y"===this.params.ALLOW_NEW_PROFILE)){for(t in this.regionBlockNotEmpty=!0,s=BX.create("LABEL",{props:{className:"bx-soa-custom-label"},html:this.params.MESS_SELECT_PROFILE}),this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&i.unshift(BX.create("OPTION",{props:{value:this.result.USER_PROFILES[t].ID,selected:"Y"===this.result.USER_PROFILES[t].CHECKED},html:this.result.USER_PROFILES[t].NAME}));"Y"===this.params.ALLOW_NEW_PROFILE&&i.unshift(BX.create("OPTION",{props:{value:0},text:BX.message("SOA_PROP_NEW_PROFILE")}));var a=BX.create("INPUT",{props:{type:"hidden",value:"N",id:"profile_change",name:"profile_change"}}),o=BX.create("SELECT",{props:{className:"form-control select-input",name:"PROFILE_ID"},children:i,events:{change:BX.delegate(function(){BX("profile_change").value="Y",this.sendRequest()},this)}}),o=BX.create("DIV",{props:{className:"select-input-container"},children:[o]});e.appendChild(BX.create("DIV",{props:{className:"bx-soa-location-input-container"},children:[s,a,o]}))}else for(t in this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&"Y"===this.result.USER_PROFILES[t].CHECKED&&e.appendChild(BX.create("INPUT",{props:{name:"PROFILE_ID",type:"hidden",value:this.result.USER_PROFILES[t].ID}}))},editPaySystemBlock:function(e){this.paySystemBlockNode&&this.paySystemHiddenBlockNode&&this.result.PAY_SYSTEM&&(e?this.editActivePaySystemBlock(!0):this.editFadePaySystemBlock(),this.initialized.paySystem=!0)},editActivePaySystemBlock:function(e){var t=this.paySystemBlockNode,s=t.querySelector(".bx-soa-section-content");s?BX.cleanNode(s):(s=this.getNewContainer(),t.appendChild(s)),this.getErrorContainer(s),t=BX.create("DIV",{props:{className:"bx-soa-pp"}}),this.editPaySystemItems(t),s.appendChild(t),this.editPaySystemInfo(t),"Y"==this.params.SHOW_COUPONS_PAY_SYSTEM&&this.editCoupons(s),this.getBlockFooter(s)},editFadePaySystemBlock:function(){var e=this.paySystemBlockNode.querySelector(".bx-soa-section-content");this.initialized.paySystem?this.paySystemHiddenBlockNode.appendChild(e):(this.editActivePaySystemBlock(!1),BX.remove(BX.lastChild(this.paySystemBlockNode))),e=this.getNewContainer(!0),this.paySystemBlockNode.appendChild(e),this.editFadePaySystemContent(e),"Y"==this.params.SHOW_COUPONS_PAY_SYSTEM&&this.editCouponsFade(e)},editPaySystemItems:function(e){if(this.result.PAY_SYSTEM&&!(this.result.PAY_SYSTEM.length<=0)){for(var t,s=BX.create("DIV",{props:{className:" bx-soa-pp-item-container"}}),i=0;i<this.paySystemPagination.currentPage.length;i++)t=this.createPaySystemItem(this.paySystemPagination.currentPage[i]),s.appendChild(t);this.paySystemPagination.show&&this.showPagination("paySystem",s),e.appendChild(s)}},createPaySystemItem:function(e){var t,s="Y"==e.CHECKED,i=parseInt(e.ID),a=this.getImageSources(e,"PSA_LOGOTIP"),a=BX.create("img",{props:{className:"bx-soa-pp-company-image",src:a.src_1x||a||this.defaultPaySystemLogo}}),i=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[BX.create("INPUT",{props:{id:"ID_PAY_SYSTEM_ID_"+i,name:"PAY_SYSTEM_ID",type:"checkbox",className:"bx-soa-pp-company-checkbox",value:i,checked:s}}),a]});return"Y"==this.params.SHOW_PAY_SYSTEM_LIST_NAMES&&(t=BX.create("DIV",{props:{className:"bx-soa-pp-company-smalltitle"},text:e.NAME})),a=BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[i,t,BX.create("DIV",{props:{className:"delivery-check"}})],events:{click:BX.proxy(this.selectPaySystem,this)}}),s&&BX.addClass(a,"bx-selected"),a},editPaySystemInfo:function(e){var t,s,i,a,o,r,l;!this.result.PAY_SYSTEM||0==this.result.PAY_SYSTEM.length&&"Y"!=this.result.PAY_FROM_ACCOUNT||(t=BX.create("DIV",{props:{className:(this.result.PAY_SYSTEM.length," bx-soa-pp-desc-container")}}),BX.cleanNode(t),"Y"==this.result.PAY_FROM_ACCOUNT&&(s=this.getInnerPaySystem(t)),(i=this.getSelectedPaySystem())&&(o=this.getImageSources(i,"PSA_LOGOTIP"),o=BX.create("img",{props:{className:"bx-soa-pp-company-image",src:o.src_1x||o||this.defaultPaySystemLogo}}),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[o]})]}),"Y"==this.params.SHOW_PAY_SYSTEM_INFO_NAME&&(a=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:i.NAME})),r=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:i.DESCRIPTION})]}),i.PRICE&&0<parseFloat(i.PRICE)&&(l=BX.create("UL",{props:{className:"bx-soa-pp-list"},children:[BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PRICE+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},text:"~"+i.PRICE_FORMATTED})]})]})),o=BX.create("DIV",{children:[o,a,r,l]}),BX.addClass(t,"pay-checked"),i.DESCRIPTION||BX.addClass(t,"hidden")),s&&o&&BX.create("HR",{props:{className:"bxe-light"}}),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[o]})),e.appendChild(t),s&&e.appendChild(s),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-info"}})))},getInnerPaySystem:function(){var e,t,s,i,a,o;if(this.result.CURRENT_BUDGET_FORMATED&&this.result.PAY_CURRENT_ACCOUNT&&this.result.INNER_PAY_SYSTEM)return o=this.params.ONLY_FULL_PAY_FROM_ACCOUNT&&"Y"==this.params.ONLY_FULL_PAY_FROM_ACCOUNT,e=this.result.PAY_CURRENT_ACCOUNT&&"Y"==this.result.PAY_CURRENT_ACCOUNT,a=this.result.INNER_PAY_SYSTEM,"Y"==this.params.SHOW_PAY_SYSTEM_INFO_NAME&&(t=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:a.NAME})),s=this.getImageSources(a,"LOGOTIP"),BX.create("img",{props:{className:"bx-soa-pp-company-image",src:s.src_1x||s||this.defaultPaySystemLogo}}),s=BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[BX.create("INPUT",{props:{type:"checkbox",className:"bx-soa-pp-company-checkbox",name:"PAY_CURRENT_ACCOUNT",value:"Y",checked:e}})],events:{click:BX.proxy(this.selectPaySystem,this)}})]}),a.DESCRIPTION&&a.DESCRIPTION.length&&(i=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:a.DESCRIPTION})]})),a=BX.create("INPUT",{props:{type:"hidden",name:"PAY_CURRENT_ACCOUNT",value:"N"}}),o=this.params.MESS_INNER_PS_BALANCE+' <b class="wsnw">'+this.result.CURRENT_BUDGET_FORMATED+"</b><br>"+(o?BX.message("SOA_PAY_ACCOUNT3"):""),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:o}),BX.create("LABEL",{props:{className:"bx-soa-pp-inner-ps"+(e?" bx-selected":"")},children:[a,s,BX.create("DIV",{children:[t,i,o]})]})},editFadePaySystemContent:function(e){var t,s=this.getSelectedPaySystem(),i=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-danger"),a=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show"),o="";i?e.appendChild(i.cloneNode(!0)):this.getErrorContainer(e),a&&a.innerHTML&&e.appendChild(a.cloneNode(!0)),this.isSelectedInnerPayment()&&(o=(o=o+'<div class="bx-soa-pp-company-selected"><img src="'+((t=this.getImageSources(this.result.INNER_PAY_SYSTEM,"LOGOTIP"))&&t.src_1x||this.defaultPaySystemLogo)+'" style="height:18px;" alt="">')+"<strong>"+this.result.INNER_PAY_SYSTEM.NAME+"</strong><br></div>"),(o=s&&s.NAME?(o=o+'<div class="bx-soa-pp-company-selected"><img src="'+((t=this.getImageSources(s,"PSA_LOGOTIP"))&&t.src_1x||this.defaultPaySystemLogo)+'" style="height:18px;" alt="">')+"<strong>"+BX.util.htmlspecialchars(s.NAME)+"</strong></div>":o).length||(o="<strong>"+BX.message("SOA_PS_SELECT_ERROR")+"</strong>"),e.innerHTML+=o,e.appendChild(BX.create("DIV",{style:{clear:"both"}})),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))},getSelectedPaySystem:function(){var e,t,s=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_SYSTEM_ID]:checked"),i=null;if(s=(s=s||this.paySystemHiddenBlockNode.querySelector("input[type=checkbox][name=PAY_SYSTEM_ID]:checked"))||this.paySystemHiddenBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]"))for(e=s.value,t=0;t<this.result.PAY_SYSTEM.length;t++)if(this.result.PAY_SYSTEM[t].ID==e){i=this.result.PAY_SYSTEM[t];break}return i},isSelectedInnerPayment:function(){var e=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]");return(e=e||this.paySystemHiddenBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]"))&&e.checked},selectPaySystem:function(e){if(this.orderBlockNode&&e){var t=e.target||e.srcElement,s=this.paySystemBlockNode.querySelector("div.bx-soa-pp-inner-ps"),i=this.paySystemBlockNode.querySelector("input[type=checkbox][name=PAY_CURRENT_ACCOUNT]"),a=this.result.TOTAL&&0===parseFloat(this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY),o=BX.hasClass(t,"bx-soa-pp-inner-ps")?t:BX.findParent(t,{className:"bx-soa-pp-inner-ps"}),r=BX.hasClass(t,"bx-soa-pp-company")?t:BX.findParent(t,{className:"bx-soa-pp-company"});if(o)"INPUT"==t.nodeName&&(i.checked=!i.checked),i.checked?(BX.removeClass(s,"bx-selected"),i.checked=!1):(BX.addClass(s,"bx-selected"),i.checked=!0);else if(r){if(BX.hasClass(r,"bx-selected"))return BX.PreventDefault(e);i&&i.checked&&a?(BX.addClass(r,"bx-selected"),r.querySelector("input[type=checkbox]").checked=!0,BX.removeClass(s,"bx-selected"),i.checked=!1):(o=this.paySystemBlockNode.querySelector(".bx-soa-pp-company.bx-selected"),BX.addClass(r,"bx-selected"),r.querySelector("input[type=checkbox]").checked=!0,o&&(BX.removeClass(o,"bx-selected"),o.querySelector("input[type=checkbox]").checked=!1))}this.sendRequest()}},editDeliveryBlock:function(e){this.deliveryBlockNode&&this.deliveryHiddenBlockNode&&this.result.DELIVERY&&(e?this.editActiveDeliveryBlock(!0):this.editFadeDeliveryBlock(),this.checkPickUpShow(),this.initialized.delivery=!0)},editActiveDeliveryBlock:function(e){var e=e?this.deliveryBlockNode:this.deliveryHiddenBlockNode,t=e.querySelector(".bx-soa-section-content");t?BX.cleanNode(t):(t=this.getNewContainer(),e.appendChild(t)),this.getErrorContainer(t),e=BX.create("DIV",{props:{className:"bx-soa-pp "}}),this.editDeliveryItems(e),t.appendChild(e),this.editDeliveryInfo(e),"Y"==this.params.SHOW_COUPONS_DELIVERY&&this.editCoupons(t),this.getBlockFooter(t)},editDeliveryItems:function(e){if(this.result.DELIVERY&&!(this.result.DELIVERY.length<=0)){for(var t,s=BX.create("DIV",{props:{className:" bx-soa-pp-item-container"}}),i=0;i<this.deliveryPagination.currentPage.length;i++)t=this.createDeliveryItem(this.deliveryPagination.currentPage[i]),s.appendChild(t);this.deliveryPagination.show&&this.showPagination("delivery",s),e.appendChild(s)}},editDeliveryInfo:function(e){var t,s,i,a,o,r,l,n,c;this.result.DELIVERY&&(t=BX.create("DIV",{props:{className:" bx-soa-pp-desc-container"}}),BX.cleanNode(t),s=this.getSelectedDelivery(),o=this.getImageSources(s,"LOGOTIP"),o=BX.create("img",{props:{className:"bx-soa-pp-company-image",src:o.src_1x||o||this.defaultDeliveryLogo}}),i="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?s.NAME:s.OWN_NAME,"Y"==this.params.SHOW_DELIVERY_INFO_NAME&&(a=BX.create("DIV",{props:{className:"bx-soa-pp-company-subTitle"},text:i})),i=BX.create("DIV",{props:{className:"bx-soa-pp-company-logo"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"},children:[o]})]}),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:s.DESCRIPTION}),s.CALCULATE_DESCRIPTION?BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:s.CALCULATE_DESCRIPTION}):null]}),0<=s.PRICE&&(l=BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PRICE+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},children:this.getDeliveryPriceNodes(s)})]})),s.PERIOD_TEXT&&s.PERIOD_TEXT.length&&(n=BX.create("LI",{children:[BX.create("DIV",{props:{className:"bx-soa-pp-list-termin"},html:this.params.MESS_PERIOD+":"}),BX.create("DIV",{props:{className:"bx-soa-pp-list-description"},html:s.PERIOD_TEXT})]})),r=BX.create("DIV",{style:{clear:"both"}}),l=BX.create("UL",{props:{className:"bx-soa-pp-list"},children:[l,n]}),(n=this.getDeliveryExtraServices(s)).length&&(c=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:n})),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[i,a,o,l,r,c]})),e.appendChild(t),"Y"!=this.params.DELIVERY_NO_AJAX&&(this.deliveryCachedInfo[s.ID]=s),this.selectedDeliveryID!=s.ID)&&(this.selectedDeliveryID=s.ID)},getDeliveryPriceNodes:function(e){e=void 0!==e.DELIVERY_DISCOUNT_PRICE&&parseFloat(e.DELIVERY_DISCOUNT_PRICE)!=parseFloat(e.PRICE)?parseFloat(e.DELIVERY_DISCOUNT_PRICE)>parseFloat(e.PRICE)?[e.DELIVERY_DISCOUNT_PRICE_FORMATED]:[e.DELIVERY_DISCOUNT_PRICE_FORMATED,BX.create("BR"),BX.create("SPAN",{props:{className:"bx-price-old"},html:e.PRICE_FORMATED})]:e.PRICE?[e.PRICE_FORMATED]:this.params.MESS_PRICE_FREE;return e},getDeliveryExtraServices:function(e){var t,s,i,a,o=[];for(t in e.EXTRA_SERVICES)e.EXTRA_SERVICES.hasOwnProperty(t)&&(a=e.EXTRA_SERVICES[t]).canUserEditValue&&(-1==a.editControl.indexOf("this.checked")?(s=BX.create("LABEL",{html:BX.util.htmlspecialchars(a.name)+(a.price?" ("+a.priceFormatted+")":"")}),(i=document.createElement("div")).innerHTML=a.editControl,i.querySelector("select")&&(a.editControl='<div class="input-container">'+a.editControl+"</div>"),i=BX.create("DIV",{props:{className:"form-group bx-soa-pp-field"},html:(a.description&&a.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(a.description)+"</div>":"")+a.editControl}),BX.prepend(s,i),(s=(s=i.querySelector("input[type=text]"))||i.querySelector("select"))&&BX.addClass(s,"form-control")):i=BX.create("DIV",{props:{className:"checkbox"+("Y"===a.value?" checked":"")},children:[BX.create("LABEL",{html:a.editControl+BX.util.htmlspecialchars(a.name)+(a.price?" ("+a.priceFormatted+")":"")+(a.description&&a.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(a.description)+"</div>":"")})]}),o.push(i));return o},editFadeDeliveryBlock:function(){var e=this.deliveryBlockNode.querySelector(".bx-soa-section-content");this.initialized.delivery?this.deliveryHiddenBlockNode.appendChild(e):(this.editActiveDeliveryBlock(!1),BX.remove(BX.lastChild(this.deliveryBlockNode))),e=this.getNewContainer(!0),this.deliveryBlockNode.appendChild(e),this.editFadeDeliveryContent(e),"Y"==this.params.SHOW_COUPONS_DELIVERY&&this.editCouponsFade(e)},createDeliveryItem:function(e){var t="Y"==e.CHECKED,s=parseInt(e.ID),i=[BX.create("INPUT",{props:{id:"ID_DELIVERY_ID_"+s,name:"DELIVERY_ID",type:"checkbox",className:"bx-soa-pp-company-checkbox",value:s,checked:t}})],a=this.deliveryCachedInfo[s],o=this.getImageSources(e,"LOGOTIP"),o=BX.create("img",{props:{className:"bx-soa-pp-company-image",src:o.src_1x||o||this.defaultDeliveryLogo}}),o=(i.push(o),[]);return"Y"==this.params.SHOW_DELIVERY_LIST_NAMES&&o.push(BX.create("DIV",{props:{className:"bx-soa-pp-company-smalltitle"},text:"N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?e.NAME:e.OWN_NAME})),0<=e.PRICE||void 0!==e.DELIVERY_DISCOUNT_PRICE?o.push(BX.create("DIV",{props:{className:"bx-soa-pp-delivery-cost"},html:0==e.PRICE?this.params.MESS_PRICE_FREE:void 0!==e.DELIVERY_DISCOUNT_PRICE?e.DELIVERY_DISCOUNT_PRICE_FORMATED:e.PRICE_FORMATED})):a&&(0<=a.PRICE||void 0!==a.DELIVERY_DISCOUNT_PRICE)?o.push(BX.create("DIV",{props:{className:"bx-soa-pp-delivery-cost"},html:0==e.PRICE?this.params.MESS_PRICE_FREE:void 0!==a.DELIVERY_DISCOUNT_PRICE?a.DELIVERY_DISCOUNT_PRICE_FORMATED:a.PRICE_FORMATED})):o.push(BX.create("DIV",{props:{className:"bx-soa-pp-delivery-cost bx-soa-pp-delivery-calculate"},html:this.params.CALCULATE})),i.push(BX.create("DIV",{props:{className:"delivery-text"},children:o})),i.push(BX.create("DIV",{props:{className:"delivery-check"}})),o=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container"+(e.CALCULATE_ERRORS||a&&a.CALCULATE_ERRORS?" bx-bd-waring":"")},children:i}),e=BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[o],events:{click:BX.proxy(this.selectDelivery,this)}}),t&&BX.addClass(e,"bx-selected"),t&&this.result.LAST_ORDER_DATA.PICK_UP&&(this.lastSelectedDelivery=s),e},editFadeDeliveryContent:function(e){var t,s,i,a=this.getSelectedDelivery(),o="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?a.NAME:a.OWN_NAME,r=this.deliveryHiddenBlockNode.querySelector("div.alert.alert-danger"),l=this.deliveryHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show");if(r&&r.innerHTML?e.appendChild(r.cloneNode(!0)):this.getErrorContainer(e),l&&l.innerHTML&&e.appendChild(l.cloneNode(!0)),a&&a.NAME){if(l=(r=this.getImageSources(a,"LOGOTIP"))&&r.src_1x||this.defaultDeliveryLogo,s=[BX.create("IMG",{props:{src:l,alt:""},style:{height:"18px"}}),BX.create("STRONG",{text:o})],"Y"==this.params.DELIVERY_FADE_EXTRA_SERVICES&&BX.util.object_keys(a.EXTRA_SERVICES).length)for(i in s.push(BX.create("BR")),a.EXTRA_SERVICES)a.EXTRA_SERVICES.hasOwnProperty(i)&&(t=a.EXTRA_SERVICES[i]).value&&"N"!=t.value&&t.canUserEditValue&&(s.push(BX.create("BR")),s.push(BX.create("STRONG",{text:t.name+": "})),s.push(t.viewControl));e.appendChild(BX.create("DIV",{props:{className:" bx-soa-pp-company-selected"},children:s})),e.appendChild(BX.create("DIV",{props:{className:" bx-soa-pp-price"},children:this.getDeliveryPriceNodes(a)}))}else e.appendChild(BX.create("STRONG",{text:BX.message("SOA_DELIVERY_SELECT_ERROR")}));e.appendChild(BX.create("DIV",{style:{clear:"both"}})),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))},selectDelivery:function(e){if(this.orderBlockNode){var t=e.target||e.srcElement,t=BX.hasClass(t,"bx-soa-pp-company")?t:BX.findParent(t,{className:"bx-soa-pp-company"}),s=this.deliveryBlockNode.querySelector(".bx-soa-pp-company.bx-selected");if(BX.hasClass(t,"bx-selected"))return BX.PreventDefault(e);t&&(e=t.querySelector("input[type=checkbox]"),BX.addClass(t,"bx-selected"),e.checked=!0),s&&(t=s.querySelector("input[type=checkbox]"),BX.removeClass(s,"bx-selected"),t.checked=!1),this.sendRequest()}},getSelectedDelivery:function(){var e,t,s=this.deliveryBlockNode.querySelector("input[type=checkbox][name=DELIVERY_ID]:checked"),i=!1;if(s=(s=s||this.deliveryHiddenBlockNode.querySelector("input[type=checkbox][name=DELIVERY_ID]:checked"))||this.deliveryHiddenBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]"))for(t in e=s.value,this.result.DELIVERY)if(this.result.DELIVERY[t].ID==e){i=this.result.DELIVERY[t];break}return i},activatePickUp:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&(this.pickUpBlockNode.style.display="",this.pickUpBlockNode.querySelector("h2.bx-soa-section-title").innerHTML=this.params.PICKUP_NAME,BX.hasClass(this.pickUpBlockNode,"bx-active")||(BX.addClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display=""))},deactivatePickUp:function(){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&(BX.removeClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display="none")},editPickUpBlock:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&this.result.DELIVERY&&(this.initialized.pickup=!1,e?this.editActivePickUpBlock(!0):this.editFadePickUpBlock(),this.initialized.pickup=!0)},editActivePickUpBlock:function(e){var t,e=e?this.pickUpBlockNode:this.pickUpHiddenBlockNode;this.initialized.pickup?(BX.remove(BX.lastChild(e)),e.appendChild(BX.firstChild(this.pickUpHiddenBlockNode)),"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps&&!this.maps.maxWaitTimeExpired&&(this.maps.maxWaitTimeExpired=!0,this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()),this.maps&&!this.pickUpMapFocused&&(this.pickUpMapFocused=!0,setTimeout(BX.proxy(this.maps.pickUpMapFocusWaiter,this.maps),200))):((t=e.querySelector(".bx-soa-section-content"))||(t=this.getNewContainer(),e.appendChild(t)),BX.cleanNode(t),e=BX.create("DIV",{props:{className:"pickup-container"}}),this.editPickUpMap(e),this.editPickUpLoader(e),t.appendChild(BX.create("DIV",{props:{className:"bx_soa_pickup "},children:[e]})),"Y"==this.params.SHOW_PICKUP_MAP&&"Y"==this.params.SHOW_NEAREST_PICKUP||(this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()),this.getBlockFooter(t))},editFadePickUpBlock:function(){var e=this.pickUpBlockNode.querySelector(".bx-soa-section-content");this.initialized.pickup?this.pickUpHiddenBlockNode.appendChild(e):(this.editActivePickUpBlock(!1),BX.remove(BX.lastChild(this.pickUpBlockNode))),e=this.getNewContainer(),this.pickUpBlockNode.appendChild(e),this.editFadePickUpContent(e)},editFadePickUpContent:function(e){var t,s,i=this.getSelectedPickUp(),a="";i&&("Y"==this.params.SHOW_STORES_IMAGES&&(t=this.getImageSources(i,"IMAGE_ID"),a+='<img src="'+(s=t.src_1x||this.defaultStoreLogo)+'" class="bx-soa-pickup-preview-img">'),a+="<strong>"+BX.util.htmlspecialchars(i.TITLE)+"</strong>",i.ADDRESS&&(a+="<br><strong>"+BX.message("SOA_PICKUP_ADDRESS")+":</strong> "+BX.util.htmlspecialchars(i.ADDRESS)),i.PHONE&&(a+="<br><strong>"+BX.message("SOA_PICKUP_PHONE")+":</strong> "+BX.util.htmlspecialchars(i.PHONE)),i.SCHEDULE&&(a+="<br><strong>"+BX.message("SOA_PICKUP_WORK")+":</strong> "+BX.util.htmlspecialchars(i.SCHEDULE)),i.DESCRIPTION&&(a+="<br><strong>"+BX.message("SOA_PICKUP_DESC")+":</strong> "+BX.util.htmlspecialchars(i.DESCRIPTION)),e.innerHTML=a,"Y"==this.params.SHOW_STORES_IMAGES)&&BX.bind(e.querySelector(".bx-soa-pickup-preview-img"),"click",BX.delegate(function(e){this.popupShow(e,t&&t.src_orig||s)},this))},getPickUpInfoArray:function(e){if(!e||e.length<=0)return[];for(var t=[],s=0;s<e.length;s++)this.result.STORE_LIST[e[s]]&&t.push(this.result.STORE_LIST[e[s]]);return t},getSelectedPickUp:function(){var e,t,s,i=BX("BUYER_STORE"),a=this.result.STORE_LIST;if(i&&!(e=a[i.value])&&(t=this.getSelectedDelivery().STORE))for(s in t)if(t.hasOwnProperty(s)){e=a[t[s]],i.setAttribute("value",t[s]);break}return e},checkPickUpShow:function(){var e,t=this.getSelectedDelivery();(e=t&&t.STORE&&t.STORE.length?this.getPickUpInfoArray(t.STORE):e)&&console.log(this.params.SHOW_MAP_FOR_DELIVERIES),e&&e.length?(e="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?t.NAME:t.OWN_NAME,t.STORE_MAIN=t.STORE,this.activatePickUp(e),this.editSection(this.pickUpBlockNode)):this.deactivatePickUp()},geoLocationSuccessCallback:function(e){var t,s=this.getSelectedDelivery();(t=s&&s.STORE?this.getPickUpInfoArray(s.STORE):t)&&t.length>=this.options.pickUpMap.minToShowNearestBlock&&this.editPickUpRecommendList(e.geoObjects.get(0)),this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},geoLocationFailCallback:function(){this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},initMaps:function(){var e,t;this.maps=BX.Sale.OrderAjaxComponent.Maps.init(this),this.maps&&(this.mapsReady=!0,this.resizeMapContainers(),"Y"===this.params.SHOW_PICKUP_MAP&&BX("pickUpMap")&&(e=(t=this.getSelectedDelivery())&&t.STORE&&t.STORE.length?this.getPickUpInfoArray(t.STORE):e)&&e.length&&(t=this.getSelectedPickUp(),this.maps.initializePickUpMap(t),"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps.showNearestPickups(BX.proxy(this.geoLocationSuccessCallback,this),BX.proxy(this.geoLocationFailCallback,this)),this.maps.buildBalloons(e)),"Y"===this.params.SHOW_MAP_IN_PROPS)&&BX("propsMap")&&(t=this.getPropertyMapData(),this.maps.initializePropsMap(t))},getPropertyMapData:function(){var e,t,s,i,a,o=this.options.propertyMap.defaultMapPosition;for(t in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(t)&&"Y"==(s=this.result.ORDER_PROP.properties[t]).IS_LOCATION){e=s.ID;break}return this.locations[e]&&this.locations[e][0]&&this.locations[e][0].coordinates&&(s=this.locations[e][0].coordinates,i=parseFloat(s.LONGITUDE),a=parseFloat(s.LATITUDE),isNaN(i)||isNaN(a)||0==i||0==a||(o.lon=i,o.lat=a)),o},resizeMapContainers:function(){var e,t=BX("pickUpMap"),s=BX("propsMap");"Y"===this.params.SHOW_PICKUP_MAP&&t&&(e=BX.findParent(t),document.documentElement.clientWidth<1366&&400<=document.documentElement.clientWidth?t.style.height="280px":document.documentElement.clientWidth<400?t.style.height="240px":t.style.height="345px",t.style.width="0px",t.style.width=e.clientWidth+"px"),"Y"===this.params.SHOW_MAP_IN_PROPS&&s&&(e=BX.findParent(s),document.documentElement.clientWidth<1366?s.style.height="280px":document.documentElement.clientWidth<400?s.style.height="240px":s.style.height="345px",s.style.width="0px",s.style.width=e.clientWidth+"px")},editPickUpMap:function(e){"Y"===this.params.SHOW_PICKUP_MAP&&e.appendChild(BX.create("DIV",{props:{id:"pickUpMap"},style:{width:"100%",marginBottom:"18px"}}))},editPickUpLoader:function(e){e.appendChild(BX.create("DIV",{props:{id:"pickUpLoader",className:"text-center"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]}))},editPickUpList:function(e){if(console.log(e),this.pickUpPagination.currentPage&&this.pickUpPagination.currentPage.length){BX.remove(BX("pickUpLoader"));var t,s,i,a,o,r,l=BX.create("DIV",{props:{className:"bx-soa-pickup-list main"}}),n=BX("BUYER_STORE"),c=!1;if(n&&(t=n.value),(a=(a=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.recommend"))||this.pickUpHiddenBlockNode.querySelector(".bx-soa-pickup-list.recommend"))&&a.querySelector(".bx-soa-pickup-list-item.bx-selected"))c=!0;else if((o=this.getSelectedDelivery())&&o.STORE)for(i=0;i<o.STORE.length;i++)o.STORE[i]==t&&(c=!0);for(i=0;i<this.pickUpPagination.currentPage.length;i++)(r=this.pickUpPagination.currentPage[i]).ID!=t&&0!=parseInt(t)&&c||(t=n.value=r.ID,c=!0),r=this.createPickUpItem(r,{selected:r.ID==t}),l.appendChild(r);e?(s=(s=this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup>.pickup-container"))||this.pickUpBlockNode.querySelector(".bx_soa_pickup>.pickup-container")).appendChild(l):(s=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.main"),BX.insertAfter(l,s),BX.remove(s)),this.pickUpPagination.show&&this.showPagination("pickUp",l)}},pickUpFinalAction:function(){var e,t=this.getSelectedDelivery();t&&(e=this.lastSelectedDelivery!==parseInt(t.ID),this.lastSelectedDelivery=parseInt(t.ID)),e&&this.pickUpBlockNode.id!==this.activeSectionId&&BX.removeClass(this.pickUpBlockNode,"bx-step-completed"),this.maps&&this.maps.pickUpFinalAction()},getStoreInfoHtml:function(e){var t="";return e.DESCRIPTION&&(t+=BX.util.htmlspecialchars(e.DESCRIPTION)+"<br>"),e.SCHEDULE&&(t+=BX.util.htmlspecialchars(e.SCHEDULE)+"<br>"),e.PHONE&&(t+=BX.util.htmlspecialchars(e.PHONE)+"<br>"),t},createPickUpItem:function(e,t){t=t||{};var s,i,a,o,r="bx-soa-pickup-l-item-detail",l="bx-soa-pickup-l-item-btn";return"Y"===this.params.SHOW_STORES_IMAGES?(i=this.getImageSources(e,"IMAGE_ID"),(o=i&&i.src_1x)?s=BX.create("IMG",{props:{src:o,className:"bx-soa-pickup-l-item-img"},events:{click:BX.delegate(function(e){this.popupShow(e,i&&i.src_orig||o)},this)}}):r+=" no-image"):(r+=" no-image",l+=" no-image"),a=this.getStoreInfoHtml(e),e=BX.create("DIV",{props:{className:"bx-soa-pickup-list-item",id:"store-"+e.ID},children:[BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-name"},text:e.TITLE}),BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-adress"},children:t.distance?[BX.util.htmlspecialchars(e.ADDRESS)," ( ~"+t.distance+" "+BX.message("SOA_DISTANCE_KM")+" ) "]:[BX.util.htmlspecialchars(e.ADDRESS)]}),BX.create("DIV",{props:{className:r},children:[s,BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-desc"},html:a})]}),BX.create("DIV",{props:{className:l},children:[BX.create("A",{props:{href:"",className:"btn btn-sm"+(t.selected?" btn-default":"")},html:t.selected?this.params.MESS_SELECTED_PICKUP:this.params.MESS_SELECT_PICKUP,events:{click:BX.delegate(function(e){e.preventDefault(),this.selectStore(e),this.clickNextAction(e)},this)}})]})],events:{click:BX.proxy(this.selectStore,this)}}),t.selected&&BX.addClass(e,"bx-selected"),e},editPickUpRecommendList:function(e){if(this.maps&&this.maps.canUseRecommendList()&&e){BX.remove(BX("pickUpLoader"));for(var t,s,i,a=BX.create("DIV",{props:{className:"bx-soa-pickup-list recommend"}}),o=BX("BUYER_STORE"),r=this.getSelectedDelivery(),l=this.maps.getRecommendedStoreIds(e),n=0;n<l.length;n++)t=l[n],i=this.getPickUpInfoArray([t])[0],0===n&&parseInt(r.ID)!==this.lastSelectedDelivery&&(o.value=parseInt(t)),s=this.maps.getDistance(e,t),i=this.createPickUpItem(i,{selected:o.value===t,distance:s}),a.appendChild(i),r.STORE_MAIN&&r.STORE_MAIN.splice(r.STORE_MAIN.indexOf(t),1);(this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup>.pickup-container")||this.pickUpBlockNode.querySelector(".bx_soa_pickup>.pickup-container")).appendChild(a)}},selectStore:function(e){var t,s,i,a,o,r,l,n=BX("BUYER_STORE");if(BX.type.isString(e)){if(!(t=BX("store-"+e))){for(i=0;i<this.pickUpPagination.pages.length;i++)for(o=this.pickUpPagination.pages[i],a=0;a<o.length;a++)if(o[a].ID==e){this.showPickUpItemsPage(++i);break}t=BX("store-"+e)}}else r=e.target||e.srcElement,t=BX.hasClass(r,"bx-soa-pickup-list-item")?r:BX.findParent(r,{className:"bx-soa-pickup-list-item"});if(t&&n&&!BX.hasClass(t,"bx-selected")){c=this.pickUpBlockNode.querySelector(".bx-selected"),s=t.id.substr("store-".length),BX.removeClass(c,"bx-selected"),c=t.clientHeight,t.style.overflow="hidden",BX.addClass(t,"bx-selected"),l=t.clientHeight,t.style.height=c+"px",new BX.easing({duration:300,start:{height:c,opacity:0},finish:{height:l,opacity:100},transition:BX.easing.transitions.quad,step:function(e){t.style.height=e.height+"px"},complete:function(){t.removeAttribute("style")}}).animate(),n.setAttribute("value",s),this.maps&&this.maps.selectBalloon(s);var c,p=BX.findParent(t).querySelectorAll(".bx-soa-pickup-l-item-btn .btn");for(let e=0;e<p.length;e++)p[e].innerText=this.params.MESS_SELECT_PICKUP,BX.removeClass(p[e],"btn-default");BX.hasClass(r,"btn")?(r.innerText=this.params.MESS_SELECTED_PICKUP,BX.addClass(r,"btn-default")):((c=BX.findParent(r).querySelector(".btn")).innerText=this.params.MESS_SELECTED_PICKUP,BX.addClass(c,"btn-default"))}},getDeliverySortedArray:function(e){function t(e,t){var s=parseInt(e.SORT)-parseInt(t.SORT);return 0==s?e.OWN_NAME.toLowerCase()>t.OWN_NAME.toLowerCase()?1:e.OWN_NAME.toLowerCase()<t.OWN_NAME.toLowerCase()?-1:0:s}var s,i=[],a=[];for(s in e)e.hasOwnProperty(s)&&("L"===this.params.SHOW_NOT_CALCULATED_DELIVERIES&&e[s].CALCULATE_ERRORS?a:i).push(e[s]);return i.sort(t),a.sort(t),i.concat(a)},editPropsBlock:function(e){this.propsBlockNode&&this.propsHiddenBlockNode&&this.result.ORDER_PROP&&(e?this.editActivePropsBlock(!0):this.editFadePropsBlock(),this.initialized.props=!0)},editActivePropsBlock:function(e){var t,s,i,e=e?this.propsBlockNode:this.propsHiddenBlockNode,a=!1;if(this.initialized.props)BX.remove(BX.lastChild(e)),e.appendChild(BX.firstChild(this.propsHiddenBlockNode)),this.maps&&setTimeout(BX.proxy(this.maps.propsMapFocusWaiter,this.maps),200);else{if((t=e.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),e.appendChild(t)),this.getErrorContainer(t),e=BX.create("DIV",{props:{className:""}}),(s=this.getSelectedDelivery())&&"Y"===this.params.SHOW_MAP_IN_PROPS&&this.params.SHOW_MAP_FOR_DELIVERIES&&this.params.SHOW_MAP_FOR_DELIVERIES.length)for(i=0;i<this.params.SHOW_MAP_FOR_DELIVERIES.length;i++)if(parseInt(s.ID)===parseInt(this.params.SHOW_MAP_FOR_DELIVERIES[i])){a=!0;break}this.editPropsItems(e),a&&this.editPropsMap(e),"Y"!==this.params.HIDE_ORDER_DESCRIPTION&&this.editPropsComment(e),t.appendChild(e),this.getBlockFooter(t)}},editFadePropsBlock:function(){var e=this.propsBlockNode.querySelector(".bx-soa-section-content");this.initialized.props?this.propsHiddenBlockNode.appendChild(e):(this.editActivePropsBlock(!1),BX.remove(BX.lastChild(this.propsBlockNode))),e=this.getNewContainer(),this.propsBlockNode.appendChild(e),this.editFadePropsContent(e)},editFadePropsContent:function(e){if(e&&this.locationsInitialized){var t,s,i,a,o,r,l=this.propsHiddenBlockNode.querySelector(".alert"),n=this.getSelectedPersonType();if(BX.cleanNode(e),l&&e.appendChild(l.cloneNode(!0)),n&&(l="PROPS_FADE_LIST_"+n.ID,t=this.params[l]),t&&0!==t.length)for(a=this.fadedPropertyCollection.getGroupIterator();s=a();)for(o=s.getIterator();i=o();)for(r=0;r<t.length;r++)t[r]==i.getId()&&"Y"!=i.getSettings().IS_ZIP&&this.getPropertyRowNode(i,e,!0);else e.innerHTML+="<strong>"+BX.message("SOA_ORDER_PROPS")+"</strong>";"true"===this.propsBlockNode.getAttribute("data-visited")&&(n=this.isValidPropertiesBlock()).length&&this.showError(this.propsBlockNode,n),BX.bind(e.querySelector(".alert.alert-danger"),"click",BX.proxy(this.showByClick,this)),BX.bind(e.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))}},editPropsItems:function(e){if(this.result.ORDER_PROP&&this.propertyCollection){for(var t,s,i,a=BX.create("DIV",{props:{className:"bx-soa-customer"}}),o=this.propertyCollection.getGroupIterator(),a=a||this.propsBlockNode.querySelector(".bx-soa-customer");t=o();)for(i=t.getIterator();s=i();)this.deliveryLocationInfo.loc!=s.getId()&&this.deliveryLocationInfo.zip!=s.getId()&&this.deliveryLocationInfo.city!=s.getId()&&this.getPropertyRowNode(s,a,!1);e.appendChild(a)}},getPropertyRowNode:function(e,t,s){var i=BX.create("DIV"),a="",o=e.getType()||"",r=e.getDescription()||"";switch(s?i.innerHTML="<strong>"+BX.util.htmlspecialchars(e.getName())+":</strong> ":(BX.addClass(i,"form-group bx-soa-customer-field"),a+=BX.util.htmlspecialchars(e.getName()).trim(),e.isRequired()&&(a+='<span class="bx-authform-starrequired">*</span> '),r.length&&"STRING"!=o&&"NUMBER"!=o&&"DATE"!=o&&(a+=" <small>("+BX.util.htmlspecialchars(r)+")</small>"),r=BX.create("LABEL",{attrs:{for:"soa-property-"+e.getId()},props:{className:"bx-soa-custom-label"},html:a}),i.setAttribute("data-property-id-row",e.getId()),i.appendChild(r)),o){case"LOCATION":this.insertLocationProperty(e,i,s);break;case"DATE":this.insertDateProperty(e,i,s);break;case"FILE":this.insertFileProperty(e,i,s);break;case"STRING":this.insertStringProperty(e,i,s);break;case"ENUM":this.insertEnumProperty(e,i,s);break;case"Y/N":this.insertYNProperty(e,i,s);break;case"NUMBER":this.insertNumberProperty(e,i,s)}t.appendChild(i)},insertLocationProperty:function(e,t,s){var i,a,o,r,l,n,c,p,h=[];if(e.getId()in this.locations)if(s){if(i=this.propsHiddenBlockNode.querySelector('[data-property-id-row="'+e.getId()+'"]'))for(a=i.querySelectorAll("div.bx-soa-loc"),c=0;c<a.length;c++)o=this.getLocationString(a[c]),h.push(o.length?BX.util.htmlspecialchars(o):BX.message("SOA_NOT_SELECTED"));t.innerHTML+=h.join("<br>")}else{for(n=BX.create("DIV",{props:{className:"soa-property-container"}}),i=this.locations[e.getId()],c=0;c<i.length;c++)for(p in r=i[c]?i[c].output:{},l=BX.create("DIV",{props:{className:"bx-soa-loc"},html:r.HTML}),e.isMultiple()&&(l.style.marginBottom="search"==this.locationsTemplate?"5px":"20px"),n.appendChild(l),r.SCRIPT)r.SCRIPT.hasOwnProperty(p)&&BX.evalGlobal(r.SCRIPT[p].JS);e.isMultiple()&&n.appendChild(BX.create("DIV",{attrs:{"data-prop-id":e.getId()},props:{className:"btn btn-sm btn-default btn-border"},text:BX.message("ADD_DEFAULT"),events:{click:BX.proxy(this.addLocationProperty,this)}})),t.appendChild(n)}},addLocationProperty:function(e){var t,s,e=e.target||e.srcElement,i=e.getAttribute("data-prop-id"),a=BX.previousSibling(e),o=0,r=BX.util.getRandomString(5);if(BX.hasClass(a,"bx-soa-loc")&&("search"==this.locationsTemplate?(s=a.querySelector("input[type=text][class=dropdown-field]"))&&(o=parseInt(s.name.substring(s.name.indexOf("[")+1,s.name.indexOf("]")))+1):(s=a.querySelectorAll("input[type=hidden]")).length&&(s=s[s.length-1],o=parseInt(s.name.substring(s.name.indexOf("[")+1,s.name.indexOf("]")))+1)),this.cleanLocations[i]){for(t in a=BX.create("DIV",{props:{className:"bx-soa-loc"},style:{marginBottom:"search"==this.locationsTemplate?"5px":"20px"},html:this.cleanLocations[i].HTML.split("#key#").join(o).replace(/sls-\d{5}/g,"sls-"+r)}),e.parentNode.insertBefore(a,e),BX.saleOrderAjax.addPropertyDesc({id:i+"_"+o,attributes:{id:i+"_"+o,type:"LOCATION",valueSource:"form"}}),this.cleanLocations[i].SCRIPT)this.cleanLocations[i].SCRIPT.hasOwnProperty(t)&&BX.evalGlobal(this.cleanLocations[i].SCRIPT[t].JS.split("_key__").join("_"+o).replace(/sls-\d{5}/g,"sls-"+r));BX.saleOrderAjax.initDeferredControl()}},insertDateProperty:function(e,t,s){var i,a,o,r;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],i=s.querySelectorAll("input[type=text]"),o=0;o<i.length;o++)i[o].value&&i[o].value.length&&a.push(i[o].value);t.innerHTML+=this.valuesToString(a)}}else{for(s=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(s),t.appendChild(s),r=s.querySelectorAll("input[type=text]"),o=0;o<r.length;o++)this.alterDateProperty(e.getSettings(),r[o]);this.alterProperty(e.getSettings(),s),this.bindValidation(e.getId(),s)}},insertFileProperty:function(e,t,s){var i,a,o,r,l;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],i=s.querySelectorAll("a"),o=0;o<i.length;o++)r=i[o].innerHTML,BX.addClass(i[o],"file-link"),r.length&&a.push(r);t.innerHTML+=this.valuesToString(a)}}else{if(s=this.savedFilesBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]'))for(l=s.querySelector("div.soa-property-container"),i=s.querySelectorAll("a"),o=0;o<i.length;o++)r=i[o].innerHTML,BX.addClass(i[o],"file-link");if(l)t.appendChild(l);else for(l=BX.create("DIV",{props:{className:"soa-property-container soa-property-files"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),i=l.querySelectorAll("a"),o=0;o<i.length;o++)r=i[o].innerHTML,BX.addClass(i[o],"file-link")}},insertStringProperty:function(e,t,s){var i,a,o;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(a=[],(i=0==(i=s.querySelectorAll("input[type=text]")).length?s.querySelectorAll("textarea"):i).length)for(o=0;o<i.length;o++)i[o].value.length&&a.push(i[o].value);t.innerHTML+=this.valuesToString(a)}}else s=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(s),t.appendChild(s),this.alterProperty(e.getSettings(),s),this.bindValidation(e.getId(),s)},insertEnumProperty:function(e,t,s){var i,a,o,r;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(a=[],(i=s.querySelectorAll("input[type=radio]")).length)for(o=0;o<i.length;o++)i[o].checked&&a.push(i[o].nextSibling.nodeValue);if((i=s.querySelectorAll("option")).length)for(o=0;o<i.length;o++)i[o].selected&&a.push(i[o].innerHTML);t.innerHTML+=this.valuesToString(a)}}else r=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(r),t.appendChild(r),this.bindValidation(e.getId(),r);s=r.querySelector("select");if(s)if(s.hasAttribute("multiple")){BX.addClass(r,"select-multiple-area");let i=s.querySelectorAll("option");var l=[];for(let s=0;s<i.length;s++)l.push(BX.create("DIV",{props:{className:"select-multiple-fake-option"},html:i[s].innerHTML,events:{click:function(e){if(!e.ctrlKey&&"touch"!==e.pointerType){var t=document.querySelectorAll(".select-multiple-fake-option");for(let e=0;e<i.length;e++)i[e].selected=!1,BX.removeClass(t[e],"selected-option")}BX.toggleClass(this,"selected-option"),BX.hasClass(this,"selected-option")?i[s].selected=!0:i[s].selected=!1}}}));r.appendChild(BX.create("DIV",{props:{className:"select-multiple-fake"},children:l}))}else BX.addClass(r,"select-area");var n=r.querySelectorAll("[type=checkbox]");if(n.length)for(o=0;o<n.length;o++){let e=BX.findParent(BX.findParent(n[o]));BX.addClass(e,"checkbox"),e.onclick=function(){e.querySelector('[type="checkbox"]').checked?BX.addClass(e,"checked"):BX.removeClass(e,"checked")}}var c=r.querySelectorAll("[type=radio]");if(c.length)for(o=0;o<c.length;o++){let t=BX.findParent(BX.findParent(c[o]));BX.addClass(t,"radio"),t.onclick=function(){if(t.querySelector('[type="radio"]').checked){var e=BX.findParent(t).querySelectorAll("[type=radio]");for(o=0;o<e.length;o++)BX.removeClass(BX.findParent(BX.findParent(e[o])),"checked");BX.addClass(t,"checked")}else BX.removeClass(t,"checked")}}},insertYNProperty:function(e,t,s){var i,a,o;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],i=s.querySelectorAll("input[type=checkbox]"),o=0;o<i.length;o+=2)a.push(i[o].checked?BX.message("SOA_YES"):BX.message("SOA_NO"));t.innerHTML+=this.valuesToString(a)}}else{var r=BX.create("LABEL",{props:{className:"soa-property-container checkbox_property"}});e.appendTo(r),t.appendChild(r),this.alterProperty(e.getSettings(),r),this.bindValidation(e.getId(),r),BX.addClass(t,"YNContainer"),t.querySelector("input[type=checkbox]").setAttribute("id","soa-property-"+e.getId()),t.onclick=function(){t.querySelector('[type="checkbox"]').checked?BX.addClass(r,"checked"):BX.removeClass(r,"checked")}}},insertNumberProperty:function(e,t,s){var i,a,o;if(s){if(s=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],i=s.querySelectorAll("input[type=text]"),o=0;o<i.length;o++)i[o].value.length&&a.push(i[o].value);t.innerHTML+=this.valuesToString(a)}}else s=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(s),t.appendChild(s),this.alterProperty(e.getSettings(),s),this.bindValidation(e.getId(),s)},valuesToString:function(e){e=e.join(", ");return e.length?BX.util.htmlspecialchars(e):BX.message("SOA_NOT_SELECTED")},alterProperty:function(c,p){var e,t,s,i,a,o,r,l,n=BX.findChildren(p,{tagName:"DIV"});if(n&&n.length)for(e=0;e<n.length;e++)n[e].style.margin="5px 0";for((t=(t=p.querySelector("input[type=text]"))||p.querySelector("textarea"))&&(t.id="soa-property-"+c.ID,"Y"==c.IS_ADDRESS&&t.setAttribute("autocomplete","off"),"Y"==c.IS_EMAIL&&(t.setAttribute("autocomplete","off"),t.setAttribute("type","text")),"Y"==c.IS_PAYER&&t.setAttribute("autocomplete","off"),"Y"==c.IS_PHONE&&(t.setAttribute("autocomplete","off"),t.setAttribute("type","text"),t.setAttribute("inputmode","tel"),"Y"===this.params.USE_MASKED)&&$(t).masked({mask:this.params.MASKED_FORMAT}),c.PATTERN)&&c.PATTERN.length&&t.removeAttribute("pattern"),s=p.querySelectorAll("input[type=text]"),e=0;e<s.length;e++)s[e].placeholder=c.DESCRIPTION,BX.addClass(s[e],"form-control bx-soa-customer-input bx-ios-fix");for(s=p.querySelectorAll("input[type=tel]"),e=0;e<s.length;e++)s[e].placeholder=c.DESCRIPTION,BX.addClass(s[e],"form-control bx-soa-customer-input bx-ios-fix");for(s=p.querySelectorAll("input[type=email]"),e=0;e<s.length;e++)s[e].placeholder=c.DESCRIPTION,BX.addClass(s[e],"form-control bx-soa-customer-input bx-ios-fix");for(s=p.querySelectorAll("select"),e=0;e<s.length;e++)BX.addClass(s[e],"form-control"),BX.addClass(BX.findParent(s[e]),"selectArea");for(s=p.querySelectorAll("textarea"),e=0;e<s.length;e++)s[e].placeholder=c.DESCRIPTION,BX.addClass(s[e],"form-control bx-ios-fix");for(i=p.querySelectorAll("label"),e=0;e<i.length;e++)BX.remove(i[e]);if("FILE"==c.TYPE){if(c.ACCEPT&&c.ACCEPT.length)for(o=p.querySelectorAll("input[type=file]"),r=this.getFileAccepts(c.ACCEPT),e=0;e<o.length;e++)o[e].setAttribute("accept",r);for(l=p.querySelectorAll("a"),e=0;e<l.length;e++)BX.bind(l[e],"click",function(e){e=e.target||e.srcElement,e=e&&e.nextSibling&&e.nextSibling.nextSibling;e&&BX.fireEvent(e,"change")})}for(a=p.querySelectorAll("input[type=button]"),e=0;e<a.length;e++)BX.addClass(a[e],"btn btn-default btn-sm"),"Y"==c.MULTIPLE&&e==a.length-1||"FILE"==c.TYPE&&(BX.prepend(a[e],a[e].parentNode),a[e].style.marginRight="10px");a.length&&(a=a[a.length-1],BX.bind(a,"click",BX.delegate(function(e){var t,s,i,e=e.target||e.srcElement,e=BX.findParent(e,{tagName:"div",className:"soa-property-container"}),a=e.querySelector("label"),o=e.querySelectorAll("input[type=button]"),r=e.querySelectorAll("input[type=text]"),l=e.querySelectorAll("textarea"),n=BX.findChildren(e,{tagName:"DIV"});if(n&&n.length)for(t=0;t<n.length;t++)n[t].style.margin="5px 0";if(this.bindValidation(c.ID,e),o.length&&o[o.length-2]&&(BX.prepend(o[o.length-2],o[o.length-2].parentNode),o[o.length-2].style.marginRight="10px",BX.addClass(o[o.length-2],"btn btn-default btn-sm")),a&&BX.remove(a),r.length&&(r[r.length-1].placeholder=c.DESCRIPTION,BX.addClass(r[r.length-1],"form-control bx-soa-customer-input bx-ios-fix"),"DATE"==c.TYPE&&this.alterDateProperty(c,r[r.length-1]),c.PATTERN)&&c.PATTERN.length&&r[r.length-1].removeAttribute("pattern"),l.length&&(l[l.length-1].placeholder=c.DESCRIPTION,BX.addClass(l[l.length-1],"form-control bx-ios-fix")),"FILE"==c.TYPE){if(c.ACCEPT&&c.ACCEPT.length)for(s=p.querySelectorAll("input[type=file]"),i=this.getFileAccepts(c.ACCEPT),t=0;t<s.length;t++)s[t].setAttribute("accept",i);o=e.querySelectorAll("a"),BX.bind(o[o.length-1],"click",function(e){var e=e.target||e.srcElement,t=e&&e.nextSibling&&e.nextSibling.nextSibling;t&&setTimeout(function(){BX.fireEvent(t,"change")},10)})}},this)))},alterDateProperty:function(t,e){var s,i=BX.findParent(e,{tagName:"DIV"});BX.addClass(i,"input-group"),s=BX.create("DIV",{props:{className:"input-group-addon"},children:[BX.create("I",{props:{className:"bx-calendar"}})]}),i.querySelector("input[type=text]").addEventListener("click",function(){s.click()}),BX.addClass(i.querySelector("input[type=text]"),"input-with-addon"),BX.insertAfter(s,e),BX.remove(i.querySelector("input[type=button]")),BX.bind(s,"click",BX.delegate(function(e){e=e.target||e.srcElement,e=BX.findParent(e,{tagName:"DIV",className:"input-group"});BX.calendar({node:e.querySelector(".input-group-addon"),field:e.querySelector("input[type=text]").name,form:"",bTime:"Y"==t.TIME,bHideTime:!1})},this))},isValidForm:function(){if(!this.options.propertyValidation)return!0;var e,t,s=this.isValidRegionBlock(),i=this.isValidPropertiesBlock(),a=!1;if(s.length&&(a=!0,this.animateScrollTo(this.regionBlockNode,800,50)),i.length&&!a)if(this.activeSectionId==this.propsBlockNode.id){for(e=this.propsBlockNode.querySelectorAll("div.tooltip"),t=0;t<e.length;t++)if("opened"==e[t].getAttribute("data-state")){this.animateScrollTo(BX.findParent(e[t],{className:"form-group bx-soa-customer-field"}),800,50);break}}else this.animateScrollTo(this.propsBlockNode,800,50);return s.length&&(this.showError(this.regionBlockNode,s),BX.addClass(this.regionBlockNode,"bx-step-error")),i.length&&(this.activeSectionId!==this.propsBlockNode.id&&this.showError(this.propsBlockNode,i),BX.addClass(this.propsBlockNode,"bx-step-error")),!(s.length+i.length)},isValidRegionBlock:function(){if(!this.options.propertyValidation)return[];for(var e,t=this.orderBlockNode.querySelectorAll(".bx-soa-location-input-container[data-property-id-row]"),s=[],i=0;i<t.length;i++)e=t[i].getAttribute("data-property-id-row"),e=this.validation.properties[e],e=this.getValidationData(e,t[i]),s=s.concat(this.isValidProperty(e,!0));return s},isValidPropertiesBlock:function(e){if(!this.options.propertyValidation)return[];for(var t,s,i=this.orderBlockNode.querySelectorAll(".bx-soa-customer-field[data-property-id-row]"),a=[],o=0;o<i.length;o++)s=i[o].getAttribute("data-property-id-row"),e&&this.locations[s]||(t=i[o].querySelector(".soa-property-container"))&&(s=this.validation.properties[s],s=this.getValidationData(s,t),a=a.concat(this.isValidProperty(s,!0)));return a},isValidProperty:function(e,t){var s,i,a=[];if(e&&e.inputs){for(i=0;i<e.inputs.length;i++)(s=e.func(e.inputs[i],!!t)).length&&(a[i]=s.join("<br>"));this.showValidationResult(e.inputs,a)}return a},bindValidation:function(e,t){if(this.validation.properties&&this.validation.properties[e]){var s,i,e=this.validation.properties[e],a=this.getValidationData(e,t);if(a&&a.inputs&&a.action)for(s=0;s<a.inputs.length;s++)if(BX.type.isElementNode(a.inputs[s]))BX.bind(a.inputs[s],a.action,BX.delegate(function(){this.isValidProperty(a)},this));else for(i=0;i<a.inputs[s].length;i++)BX.bind(a.inputs[s][i],a.action,BX.delegate(function(){this.isValidProperty(a)},this))}},getValidationData:function(s,e){if(s&&e){var t,i={};switch(s.TYPE){case"STRING":i.action="change",i.func=BX.delegate(function(e,t){return this.validateString(e,s,t)},this),(t=e.querySelectorAll("input[type=text], input[type=email], input[type=tel]")).length?i.inputs=t:(t=e.querySelectorAll("textarea")).length&&(i.inputs=t);break;case"LOCATION":i.func=BX.delegate(function(e,t){return this.validateLocation(e,s,t)},this),(t=e.querySelectorAll("input.bx-ui-sls-fake[type=text]")).length?(i.inputs=t,i.action="keyup"):(t=e.querySelectorAll("div.bx-ui-slst-pool")).length&&(i.inputs=t);break;case"Y/N":i.inputs=e.querySelectorAll("input[type=checkbox]"),i.action="change",i.func=BX.delegate(function(e,t){return this.validateCheckbox(e,s,t)},this);break;case"NUMBER":i.inputs=e.querySelectorAll("input[type=text]"),i.action="blur",i.func=BX.delegate(function(e,t){return this.validateNumber(e,s,t)},this);break;case"ENUM":(t=(t=e.querySelectorAll("input[type=radio]")).length?t:e.querySelectorAll("input[type=checkbox]")).length?(i.inputs=[t],i.action="change",i.func=BX.delegate(function(e,t){return this.validateEnum(e,s,t)},this)):(t=e.querySelectorAll("option")).length&&(i.inputs=[t],i.action="click",i.func=BX.delegate(function(e,t){return this.validateSelect(e,s,t)},this));break;case"FILE":i.inputs=e.querySelectorAll("input[type=file]"),i.action="change",i.func=BX.delegate(function(e,t){return this.validateFile(e,s,t)},this);break;case"DATE":i.inputs=e.querySelectorAll("input[type=text]"),i.action="change",i.func=BX.delegate(function(e,t){return this.validateDate(e,s,t)},this)}return i}},showErrorTooltip:function(e,t,s){var i,a;e&&t&&s&&(i=BX("tooltip-"+e),s=this.uniqueText(s,"<br>"),i?a=i.querySelector("div.tooltip-inner"):(a=BX.create("DIV",{props:{className:"tooltip-inner"}}),i=BX.create("DIV",{props:{id:"tooltip-"+e,className:"bx-soa-tooltip bx-soa-tooltip-static bx-soa-tooltip-danger tooltip top"},children:[BX.create("DIV",{props:{className:"tooltip-arrow"}}),a]}),(e=t.parentNode.querySelector("div.quick-locations"))&&(t=e),BX.insertAfter(i,t)),a.innerHTML=s,"opened"!=i.getAttribute("data-state"))&&(i.setAttribute("data-state","opened"),i.style.opacity=0,i.style.display="block",new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.quad,step:function(e){i.style.opacity=e.opacity/100}}).animate())},closeErrorTooltip:function(e){var t=BX("tooltip-"+e);t&&(t.setAttribute("data-state","closed"),new BX.easing({duration:150,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.quad,step:function(e){t.style.opacity=e.opacity/100},complete:function(){t.style.display="none"}}).animate())},showValidationResult:function(e,t){if(e&&e.length&&t){var s,i,a,o=(BX.type.isElementNode(e[0])?e:e[0])[0],o=BX.findParent(o,{tagName:"DIV",className:"form-group"}).querySelector("label");for(o&&(s=o.getAttribute("for")),a=0;a<e.length;a++)i=BX.findParent(e[a],{tagName:"DIV",className:"form-group"}),t[a]&&t[a].length?BX.addClass(i,"has-error"):BX.removeClass(i,"has-error");t.length?this.showErrorTooltip(s,o,t.join("<br>")):this.closeErrorTooltip(s)}},validateString:function(e,t,s){var i,a,o;return e&&t?(i=e.value,a=[],o=BX.util.htmlspecialchars(t.NAME),s=s?BX.message("SOA_FIELD")+' "'+o+'"':BX.message("SOA_FIELD"),"Y"!==t.MULTIPLE&&("Y"===t.REQUIRED&&0===i.length&&a.push(s+" "+BX.message("SOA_REQUIRED")),i.length)&&(t.MINLENGTH&&t.MINLENGTH>i.length&&a.push(BX.message("SOA_MIN_LENGTH")+' "'+o+'" '+BX.message("SOA_LESS")+" "+t.MINLENGTH+" "+BX.message("SOA_SYMBOLS")),t.MAXLENGTH&&t.MAXLENGTH<i.length&&a.push(BX.message("SOA_MAX_LENGTH")+' "'+o+'" '+BX.message("SOA_MORE")+" "+t.MAXLENGTH+" "+BX.message("SOA_SYMBOLS")),"Y"===t.IS_EMAIL&&(e.value=i=BX.util.trim(i),i.length)&&!/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(i)&&a.push(BX.message("SOA_INVALID_EMAIL")),0<i.length)&&t.PATTERN&&t.PATTERN.length&&(new RegExp(t.PATTERN).test(i)||a.push(s+" "+BX.message("SOA_INVALID_PATTERN"))),a):[]},validateLocation:function(e,t,s){var i;return e&&t?(e=BX.findParent(e,{tagName:"DIV",className:"form-group"}),e=this.getLocationString(e),i=[],s=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD"),"Y"==t.MULTIPLE&&"Y"!==t.IS_LOCATION||"Y"!=t.REQUIRED||0!=e.length&&e!=BX.message("SOA_NOT_SPECIFIED")||i.push(s+" "+BX.message("SOA_REQUIRED")),i):[]},validateCheckbox:function(e,t,s){var i;return e&&t?(i=[],s=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD"),"Y"==t.MULTIPLE||"Y"!=t.REQUIRED||e.checked||i.push(s+" "+BX.message("SOA_REQUIRED")),i):[]},validateNumber:function(e,t,s){var i,a;return e&&t?(e=e.value,i=[],a=BX.util.htmlspecialchars(t.NAME),s=s?BX.message("SOA_FIELD")+' "'+a+'"':BX.message("SOA_FIELD"),"Y"!=t.MULTIPLE&&("Y"==t.REQUIRED&&0==e.length&&i.push(s+" "+BX.message("SOA_REQUIRED")),e.length)&&(/[0-9]|\./.test(e)||i.push(s+" "+BX.message("SOA_NOT_NUMERIC")),t.MIN&&parseFloat(t.MIN)>parseFloat(e)&&i.push(BX.message("SOA_MIN_VALUE")+' "'+a+'" '+parseFloat(t.MIN)),t.MAX&&parseFloat(t.MAX)<parseFloat(e)&&i.push(BX.message("SOA_MAX_VALUE")+' "'+a+'" '+parseFloat(t.MAX)),t.STEP)&&0<parseFloat(t.STEP)&&(a=(Math.abs(parseFloat(e)-(t.MIN&&0<parseFloat(t.MIN)?parseFloat(t.MIN):0))/parseFloat(t.STEP)).toPrecision(12))!=parseInt(a)&&i.push(s+" "+BX.message("SOA_NUM_STEP")+" "+t.STEP),i):[]},validateEnum:function(e,t,s){if(!e||!t)return[];var i,a=[],o=[],s=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");if("Y"!=t.MULTIPLE){for(i=0;i<e.length;i++)(e[i].checked||e[i].selected)&&a.push(i);"Y"==t.REQUIRED&&0==a.length&&o.push(s+" "+BX.message("SOA_REQUIRED"))}return o},validateSelect:function(e,t,s){if(!e||!t)return[];var i,a=[],o=[],s=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");if("Y"!=t.MULTIPLE){for(i=0;i<e.length;i++)e[i].selected&&a.push(i);"Y"==t.REQUIRED&&0==a.length&&o.push(s+" "+BX.message("SOA_REQUIRED"))}return o},validateFile:function(e,t,s){if(!e||!t)return[];var i,a,o,r,l=[],n=e.files||[],s=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD"),e=e.previousSibling.value;if("Y"!=t.MULTIPLE)if("Y"!=t.REQUIRED||0!=n.length||""!=e||t.DEFAULT_VALUE&&t.DEFAULT_VALUE.length)for(i=0;i<n.length;i++)a=n[i],o=BX.util.htmlspecialchars(a.name),r=1<(r=a.name.split(".")).length?r[r.length-1].toLowerCase():"",0<t.ACCEPT.length&&(0==r.length||"-1"==t.ACCEPT.indexOf(r))&&l.push(BX.message("SOA_BAD_EXTENSION")+' "'+o+'" ('+BX.util.htmlspecialchars(t.ACCEPT)+")"),a.size>parseInt(t.MAXSIZE)&&l.push(BX.message("SOA_MAX_SIZE")+' "'+o+'" ('+this.getSizeString(t.MAXSIZE,1)+")");else l.push(s+" "+BX.message("SOA_REQUIRED"));return l},validateDate:function(e,t,s){var i,a;return e&&t?(e=e.value,i=[],a=BX.util.htmlspecialchars(t.NAME),s=s?BX.message("SOA_FIELD")+' "'+a+'"':BX.message("SOA_FIELD"),"Y"!=t.MULTIPLE&&"Y"==t.REQUIRED&&0==e.length&&i.push(s+" "+BX.message("SOA_REQUIRED")),i):[]},editPropsMap:function(e){var t=BX.create("DIV",{props:{className:""},style:{marginBottom:"10px"}}),s=BX.create("DIV",{props:{id:"propsMap"},style:{width:"100%"}});t.appendChild(s),e.appendChild(t)},editPropsComment:function(e){var t=BX.create("DIV",{props:{className:""}}),s=BX.create("LABEL",{attrs:{for:"orderDescription"},props:{className:"bx-soa-customer-label"},html:this.params.MESS_ORDER_DESC}),i=BX.create("TEXTAREA",{props:{id:"orderDescription",cols:"4",className:"form-control bx-soa-customer-textarea bx-ios-fix",name:"ORDER_DESCRIPTION"},text:this.result.ORDER_DESCRIPTION||""}),s=BX.create("DIV",{props:{className:"form-group bx-soa-customer-field"},children:[s,i]});t.appendChild(s),e.appendChild(t)},editTotalBlock:function(){if(this.totalInfoBlockNode&&this.result.TOTAL){var e,t,s,i,a,o=this.result.TOTAL,r={},l="Y"===this.params.SHOW_TOTAL_ORDER_BUTTON;if(BX.cleanNode(this.totalInfoBlockNode),0===parseFloat(o.ORDER_PRICE)?(i=this.params.MESS_PRICE_FREE,r.free=!0):i=o.ORDER_PRICE_FORMATED,this.options.showPriceWithoutDiscount,Number(o.DISCOUNT_PRICE)&&this.totalInfoBlockNode.appendChild(BX.create("SPAN",{props:{className:"discount_procent"},html:`-${Math.round(Number(o.DISCOUNT_PRICE)/(Number(o.PRICE_WITHOUT_DISCOUNT_VALUE)/100))}%`})),this.options.showPayedFromInnerBudget?(this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),o.ORDER_TOTAL_PRICE_FORMATED,{total:!0})),Number(this.params.MIN_SUM_TO_PAYMENT)>Number(this.result.TOTAL.ORDER_TOTAL_PRICE)&&this.totalInfoBlockNode.appendChild(this.createMinimumSumBlock()),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_PAYED"),o.PAYED_FROM_ACCOUNT_FORMATED)),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_LEFT_TO_PAY"),o.ORDER_TOTAL_LEFT_TO_PAY_FORMATED))):(this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),o.ORDER_TOTAL_PRICE_FORMATED,{total:!0})),Number(this.params.MIN_SUM_TO_PAYMENT)>Number(this.result.TOTAL.ORDER_TOTAL_PRICE)&&this.totalInfoBlockNode.appendChild(this.createMinimumSumBlock())),this.options.showDiscountPrice&&(s=this.params.MESS_ECONOMY,o.DISCOUNT_PERCENT_FORMATED&&0<parseFloat(o.DISCOUNT_PERCENT_FORMATED)&&(s+=o.DISCOUNT_PERCENT_FORMATED),this.totalInfoBlockNode.appendChild(this.createTotalUnit(s+":",o.DISCOUNT_PRICE_FORMATED,{highlighted:!0}))),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_SUMMARY"),i,r)),this.options.showPriceWithoutDiscount&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_SUMMARY_WITHOUT_DISCOUNT"),o.PRICE_WITHOUT_DISCOUNT)),this.options.showOrderWeight&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_WEIGHT_SUM"),o.ORDER_WEIGHT_FORMATED)),this.options.showTaxList)for(t=0;t<o.TAX_LIST.length;t++)e=o.TAX_LIST[t].VALUE_MONEY_FORMATED||"",this.totalInfoBlockNode.appendChild(this.createTotalUnit(o.TAX_LIST[t].NAME+(o.TAX_LIST[t].VALUE_FORMATED?" "+o.TAX_LIST[t].VALUE_FORMATED:"")+":",e));r={},(i=(s=this.getSelectedDelivery())&&s.CALCULATE_ERRORS&&s.CALCULATE_ERRORS.length)?(a=BX.message("SOA_NOT_CALCULATED"),r.error=i):(0===parseFloat(o.DELIVERY_PRICE)?(a=this.params.MESS_PRICE_FREE,r.free=!0):a=o.DELIVERY_PRICE_FORMATED,s&&void 0!==s.DELIVERY_DISCOUNT_PRICE&&parseFloat(s.PRICE)>parseFloat(s.DELIVERY_DISCOUNT_PRICE)&&(a+='<br><span class="bx-price-old">'+s.PRICE_FORMATED+"</span>"),r.delivery=!0),this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_DELIVERY"),a,r)),0<=parseFloat(o.PAY_SYSTEM_PRICE)&&this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_PAYSYSTEM_PRICE"),"~"+o.PAY_SYSTEM_PRICE_FORMATTED)),this.result.SHOW_AUTH||"Y"!==this.params.SHOW_TOTAL_ORDER_BUTTON||this.totalInfoBlockNode.appendChild(BX.create("DIV",{props:{className:"bx-soa-cart-total-button-container"+(l?"":" visible-xs")},children:[BX.create("A",{props:{href:"javascript:void(0)",className:"btn btn-default btn-lg btn-order-save"},html:this.params.MESS_ORDER,events:{click:BX.proxy(this.clickOrderSaveAction,this)}})]})),"Y"===this.params.SHOW_COUPONS&&"Y"===this.params.SHOW_COUPONS_TOTAL&&this.editCoupons(this.totalInfoBlockNode),this.editMobileTotalBlock()}},editMobileTotalBlock:function(){},createTotalUnit:function(e,t,s){var i="bx-soa-cart-total-line";return e=e||"",t=t||"",t=(s=s||{}).error?[BX.create("A",{props:{className:"bx-soa-price-not-calc"},html:t,events:{click:BX.delegate(function(){this.animateScrollTo(this.deliveryBlockNode)},this)}})]:s.free?[BX.create("SPAN",{props:{className:"bx-soa-price-free"},html:t})]:[t],s.total&&(i+=" bx-soa-cart-total-line-total"),s.highlighted&&(i+=" bx-soa-cart-total-line-highlighted"),s.delivery&&(i+=" bx-soa-cart-total-line-delivery"),BX.create("DIV",{props:{className:i},children:[BX.create("SPAN",{props:{className:"bx-soa-cart-t"},text:e}),BX.create("SPAN",{props:{className:"bx-soa-cart-border"}}),BX.create("SPAN",{props:{className:"bx-soa-cart-d"+(s.total&&this.options.totalPriceChanged?" bx-soa-changeCostSign":"")},children:t})]})},createMinimumSumBlock:function(){var e=BX.Currency.currencyFormat(this.params.MIN_SUM_TO_PAYMENT,this.currency,!0);return BX.create("DIV",{props:{className:"minimum-sum-block"},children:[BX.create("DIV",{props:{className:"minimum-sum-block_top"},children:[BX.create("DIV",{props:{className:"minimum-sum-block_left"},children:[BX.create("DIV",{props:{className:"minimum-sum-block_name"},text:this.params.MIN_SUM_TO_PAYMENT_TITLE}),BX.create("DIV",{props:{className:"minimum-sum-block_sum"},html:e})]}),BX.create("DIV",{props:{className:"bx-soa-pp-info"}})]}),BX.create("A",{props:{className:"minimum-sum-block_link btn btn-default btn-lg",href:this.params.EMPTY_BASKET_HINT_PATH},text:this.params.ADDED_TO_ORDER})]})},basketBlockScrollCheckEvent:function(e){var e=e.target||e.srcElement,t=e.scrollLeft,s=e.scrollWidth-(t+e.clientWidth),e=e.parentNode;0==t?BX.removeClass(e,"bx-soa-table-fade-left"):BX.addClass(e,"bx-soa-table-fade-left"),0==s?BX.removeClass(e,"bx-soa-table-fade-right"):BX.addClass(e,"bx-soa-table-fade-right")},basketBlockScrollCheck:function(){for(var e,t,s,i=this.orderBlockNode.querySelectorAll("div.bx-soa-table-fade"),a=!1,o=0;o<i.length;o++)t=(e=i[o]).querySelector("div.bx-soa-item-table"),s=e.clientWidth,t=t.clientWidth||0,(a=a||s<t)?(t=(s=BX.firstChild(e)).scrollLeft,s=s.scrollWidth-(t+s.clientWidth),0==t?BX.removeClass(e,"bx-soa-table-fade-left"):BX.addClass(e,"bx-soa-table-fade-left"),0==s?BX.removeClass(e,"bx-soa-table-fade-right"):BX.addClass(e,"bx-soa-table-fade-right"),0==t&&0==s&&BX.addClass(e,"bx-soa-table-fade-right")):BX.removeClass(e,"bx-soa-table-fade-left bx-soa-table-fade-right")},totalBlockScrollCheck:function(){var e,t,s;this.totalInfoBlockNode&&this.totalGhostBlockNode&&(e=BX.GetWindowScrollPos().scrollTop,t=BX.pos(this.totalGhostBlockNode).top,BX.pos(this.orderBlockNode).bottom-this.totalBlockNode.offsetHeight<e+20?BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"):BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"),t<e&&!BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")?(s=this.totalInfoBlockNode.offsetWidth,BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=this.totalInfoBlockNode.offsetHeight+"px",this.totalInfoBlockNode.style.width=s+"px"):e<t&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=0,this.totalInfoBlockNode.style.width=""))},totalBlockResizeCheck:function(){this.totalInfoBlockNode&&this.totalGhostBlockNode&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(this.totalInfoBlockNode.style.width=this.totalGhostBlockNode.offsetWidth+"px")},totalBlockFixFont:function(){var e,t=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-line.bx-soa-cart-total-line-total"),s=[];t&&(e=BX.lastChild(t),s.push({node:e,maxFontSize:28,smallestValue:!1,scaleBy:e.parentNode})),"Y"==this.params.SHOW_TOTAL_ORDER_BUTTON&&(t=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-button-container"))&&(e=BX.lastChild(t),s.push({node:e,maxFontSize:18,smallestValue:!1})),s.length&&BX.FixFontSize.init({objList:s,onAdaptiveResize:!0})},setAnalyticsDataLayer:function(e,t){if(this.params.DATA_LAYER_NAME){var s,i,a,o,r=[];for(i in this.result.GRID.ROWS)if(this.result.GRID.ROWS.hasOwnProperty(i)){for(o=this.result.GRID.ROWS[i],a=[],i=0;i<o.data.PROPS.length;i++)a.push(o.data.PROPS[i].VALUE);r.push({id:o.data.PRODUCT_ID,name:o.data.NAME,price:o.data.PRICE,brand:(o.data[this.params.BRAND_PROPERTY+"_VALUE"]||"").split(", ").join("/"),variant:a.join("/"),quantity:o.data.QUANTITY})}switch(e){case"checkout":s={event:"checkout",ecommerce:{checkout:{products:r}}};break;case"purchase":s={event:"purchase",ecommerce:{purchase:{actionField:{id:t,revenue:this.result.TOTAL.ORDER_TOTAL_PRICE,tax:this.result.TOTAL.TAX_PRICE,shipping:this.result.TOTAL.DELIVERY_PRICE},products:r}}}}window[this.params.DATA_LAYER_NAME]=window[this.params.DATA_LAYER_NAME]||[],window[this.params.DATA_LAYER_NAME].push(s)}},changeLocation:function(){var e,t=this.result.ORDER_PROP.properties;for(e in t)"LOCATION"===t[e].TYPE&&$(`input[name='ORDER_PROP_${t[e].ID}']`).val()!=this.locationID&&($(`input[name='ORDER_PROP_${t[e].ID}']`).val(this.locationID),this.sendRequest())},isOrderSaveAllowed:function(){return!0===this.orderSaveAllowed},allowOrderSave:function(){this.orderSaveAllowed=!0},disallowOrderSave:function(){this.orderSaveAllowed=!1},initUserConsent:function(){BX.ready(BX.delegate(function(){var e=BX.UserConsent&&BX.UserConsent.load(this.orderBlockNode);e&&(BX.addCustomEvent(e,BX.UserConsent.events.save,BX.proxy(this.doSaveAction,this)),BX.addCustomEvent(e,BX.UserConsent.events.refused,BX.proxy(this.disallowOrderSave,this)))},this))}};