(i=>{i.fn.masked=function(s){return this.filter("input").each((t,e)=>new r(e,i.extend(!0,{mask:"+7 (999) 999-99-99",namespace:"masked",autoclear:!0,placeholder:"_",definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},completed:()=>{},uncompleted:()=>{}},s)))};class r{constructor(t,e){this.$input=i(t),this.options=e,this.processor=new a(this),this.processor.isComplited()||this.processor.first(),this.events=new s(this),this.events.bind(),this.state=new o(this),this.state.process()}applyCompleted(){return this.options.completed.call(this,this),this.getInput().trigger("completed",this),this}applyUncompleted(){return this.options.uncompleted.call(this,this),this.getInput().trigger("uncompleted",this),this}isAutoclearEnabled(){return this.options.autoclear}getPlaceholder(){return this.options.placeholder}getDefinitions(){return this.options.definitions}getNamespace(){return this.options.namespace}getMask(){return this.options.mask}getProcessor(){return this.processor}getEvents(){return this.events}getState(){return this.state}getInput(){return this.$input}}class s{constructor(t){this.masked=t}bind(){this.masked.getInput().on(this.addNamespace("beforeinput"),t=>this.beforeinput(t)),this.masked.getInput().on(this.addNamespace("input"),t=>this.input(t)),this.masked.getInput().on(this.addNamespace("focus"),t=>this.focus(t)),this.masked.getInput().on(this.addNamespace("blur"),t=>this.blur(t))}focus(t){this.masked.getProcessor().needReset()&&(this.masked.getProcessor().reset(),this.masked.getState().process())}beforeinput(t){this.masked.getProcessor().updateCache()}input(t){this.masked.getProcessor().updateCache().isComplited()||(this.masked.getProcessor().correct(),this.masked.getState().process())}blur(t){this.masked.getProcessor().needClear()&&(this.masked.getProcessor().clear(),this.masked.getState().process())}addNamespace(t){return t+"."+this.masked.getNamespace()}}class o{constructor(t){this.masked=t,this.completed=!1}process(){return this.masked.getProcessor().isComplited()!==this.getComplited()&&this.reverse(),this}reverse(){return(this.completed=!this.completed)?this.masked.applyCompleted():this.masked.applyUncompleted(),this}getComplited(){return this.completed}}class a{constructor(t){this.masked=t,this.formatter=new n(this.masked),this.input=new h(this),this.caret=new l(this)}first(){this.getInput().setLastValue(this.getFormatter().getDefaultValue()),this.getCaret().setVirtualPosition(this.getFormatter().getLastPosition());var t=new e(this);return t.process(),t.existEditedPositions()&&this.getInput().setValue(t.getResult()),this}correct(){var t=new e(this);return t.process(),this.getInput().setValue(t.getResult()),this.getCaret().setPosition(t.getLastEditedPosition()),this}reset(){return this.getInput().setValue(this.getFormatter().getDefaultValue()),this.getCaret().setPositionWithDelay(this.getFormatter().getFirstAvailablePosition()),this}clear(){return this.getInput().setValue(""),this}isComplited(){return this.getFormatter().getFinalExpression().test(this.getInput().getValue())}isEmpty(){return""===this.getInput().getValue()||this.getInput().getValue()===this.getFormatter().getDefaultValue()}needReset(){return!this.isComplited()&&this.isEmpty()}needClear(){return this.getMasked().isAutoclearEnabled()?!this.isComplited():!this.isComplited()&&this.isEmpty()}updateCache(){return this.getInput().readValue(),this.getCaret().readPosition(),this}getInputNative(){return this.masked.getInput().get(0)}getFormatter(){return this.formatter}getMasked(){return this.masked}getCaret(){return this.caret}getInput(){return this.input}}class e{constructor(t){this.processor=t,this.initValues()}initValues(){return this.mask=this.processor.getFormatter().getDefaultValueArray(),this.value=this.processor.getInput().getValueArray(),this.lastValue=this.processor.getInput().getLastValueArray(),this.caretPosition=this.processor.getCaret().getPosition(),this.caretLastPosition=this.processor.getCaret().getLastPosition(),this.lastEditedPosition=this.caretLastPosition[0],this.updateEditedPositions(),this.result=this.lastValue,this}updateEditedPositions(){return this.editedPositions=[],i.each(this.lastValue,(t,e)=>{this.processor.getFormatter().isAllowedCharInPosition(t,e)&&(this.editedPositions[t]=e)}),this}process(){return this.clearSelected(),this.isInput()?this.input():this.isBackspace()?this.backspace():this.isDelete()?this.delete():this}clearSelected(){i.each(this.getSelectedPositions(),(t,e)=>{this.lastValue[e]=this.mask[e],this.result[e]=this.mask[e]}),this.updateEditedPositions()}backspace(){var t=this.getPrevEditedPosition();return-1!==t?(this.result[t]=this.mask[t],this.lastEditedPosition=t):(t=this.processor.getFormatter().getFirstAvailablePosition(),this.lastEditedPosition=this.lastEditedPosition>t?this.lastEditedPosition-1:t),this}delete(){var t=this.getNextEditedPosition();return-1!==t&&(this.result[t]=this.mask[t]),this}input(s=0){var t=this.getInputChars();return this.isPaste()&&!this.existEditedPositions()&&(this.caretLastPosition[0]=0),i.each(t,(t,e)=>{this.inputChar(t-s,e)||s++}),this}inputChar(t,e){var t=this.caretLastPosition[0]+t;return this.mask[t]===e?(this.lastEditedPosition=t+1,!0):!(-1===(t=this.getNearestAllowedPosition(t))||!this.processor.getFormatter().isAllowedCharInPosition(t,e)||(this.result[t]=e,this.lastEditedPosition=t+1,this.editedPositions[t]=e,0))}isInput(){return 0<this.getInputChars().length}isPaste(){return 1<this.getInputChars().length}isBackspace(){return this.value.length<this.lastValue.length&&this.caretPosition[0]!==this.caretLastPosition[0]}isDelete(){return this.value.length<this.lastValue.length&&this.caretPosition[0]===this.caretLastPosition[0]}existEditedPositions(){return 0<this.editedPositions.length}getNearestAllowedPosition(s){return this.processor.getFormatter().getAllowedPositions().findIndex((t,e)=>void 0!==t&&s<=e&&void 0===this.getEditedPositions()[e])}getNextEditedPosition(){return this.getEditedPositions().findIndex((t,e)=>void 0!==t&&e>=this.lastEditedPosition)}getPrevEditedPosition(){let t=this.getEditedPositions().length;for(;t--;)if(void 0!==this.getEditedPositions()[t]&&t<this.lastEditedPosition)return t;return-1}getSelectedPositions(e=[]){for(let t=0;t<this.processor.getCaret().getDelta();t++)e.push(t+this.caretLastPosition[0]);return e}getInputChars(){return this.value.slice(this.caretLastPosition[0],this.caretPosition[0])}getLastEditedPosition(){return this.lastEditedPosition}getEditedPositions(){return this.editedPositions}getResult(){return this.result.join("")}}class n{constructor(t){this.masked=t,this.initAllowedPositions().initFinalExpression().initDefaltValue()}initAllowedPositions(){return this.allowedPositions=[],i.each(this.getMaskArray(),(t,e)=>{this.isDefinition(e)&&(this.allowedPositions[t]=e)}),this}initFinalExpression(s=["^"]){return i.each(this.getMaskArray(),(t,e)=>{if(this.isDefinition(e))return s.push(this.getDefinitionExpression(e)),!0;s.push(this.addSlashesForRegexp(e))}),s.push("$"),this.finalExpression=new RegExp(s.join("")),this}initDefaltValue(s=[]){return i.each(this.getMaskArray(),(t,e)=>{s[t]=this.isAllowedPosition(t)?this.getMasked().getPlaceholder():e}),this.defaultValue=s.join(""),this}isAllowedCharInPosition(t,e){return!!this.isAllowedPosition(t)&&new RegExp(this.getDefinitionExpression(this.getAllowedPositions()[t])).test(e)}isAllowedPosition(t){return void 0!==this.getAllowedPositions()[t]}isDefinition(t){return void 0!==this.getMasked().getDefinitions()[t]}addSlashesForRegexp(t){return t.replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\\/g,"\\").replace(/\^/g,"\\^").replace(/\$/g,"\\$").replace(/\./g,"\\.").replace(/\|/g,"\\|").replace(/\?/g,"\\?").replace(/\*/g,"\\*").replace(/\+/g,"\\+").replace(/\(/g,"\\(").replace(/\)/g,"\\)")}getFirstAvailablePosition(){return this.allowedPositions.findIndex(t=>t)}getDefinitionExpression(t){return this.getMasked().getDefinitions()[t]}getLastPosition(){return this.getDefaultValueArray().length}getFinalExpression(){return this.finalExpression}getAllowedPositions(){return this.allowedPositions}getDefaultValueArray(){return this.getDefaultValue().split("")}getDefaultValue(){return this.defaultValue}getMaskArray(){return this.getMasked().getMask().split("")}getMasked(){return this.masked}}class h{constructor(t){this.processor=t,this.target=this.processor.getMasked().getInput(),this.readValue()}readValue(){return this.value=this.updateLastValue().getTarget().val(),this}updateLastValue(){return this.setLastValue(this.getValue()),this}setLastValue(t){return void 0!==t?this.lastValue=t:this.lastValue="",this}setValue(t){return this.updateLastValue(),this.value=t,this.getTarget().val(t),this}getTarget(){return this.target}getLastValueArray(){return this.lastValue.split("")}getLastValue(){return this.lastValue}getValueArray(){return this.value.split("")}getValue(){return this.value}}class l{constructor(t){this.processor=t,this.readPosition()}readPosition(){this.updateLastPosition(),this.position=[this.processor.getInputNative().selectionStart,this.processor.getInputNative().selectionEnd]}updateLastPosition(){return void 0!==this.position?this.lastPosition=this.position:this.lastPosition=[0,0],this}setVirtualPosition(t){this.position=t}setPosition(t){this.updateLastPosition(),this.position=[t,t],this.processor.getInputNative().setSelectionRange(t,t)}setPositionWithDelay(t){setTimeout(()=>{this.setPosition(t)},0)}getDelta(){return this.getLastPosition()[1]-this.getLastPosition()[0]}getLastPosition(){return this.lastPosition}getPosition(){return this.position}}})($);