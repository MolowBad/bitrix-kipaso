var DwBasket={};$(function(){let m={order:"DwBasketOrder",basket:"DwBasket",personType:"personSelect",personTypeModules:"personTypeModules",storesSwitch:"storeSelect",storesContainer:"storeSelectContainer",orderForm:"orderForm",orderFormActive:"orderForm.active",budgetContainer:"payFromBudget",budget:"budgetSwitch",quantityField:"qty",extraService:"extraServiceSwitch",extraServiceItem:"extraServicesItem",extraServiceItems:"extraServiceItems",extraServiceItemSum:"extraServiceItemSum",extraServiceItemContainer:"extraServicesItemContainer",delivery:"deliverySelect",deliverySum:"deliverySum",deliveryProps:"deliveryProps",deliveryDescription:"deliveryDescription",deliveryPeriod:"deliveryPeriod",deliveryPeriodDescription:"deliveryPeriodDescription",deliveryModulesContainer:"deliveryModulesContainer",deliveryModulesContainerDesc:"deliveryModulesContainerDesc",paysystem:"paySelect",paysystemProps:"payProps",locationField:"location",locationSwitchLink:"locationSwitchLink",locationSwitchContainer:"locationSwitchContainer",couponButton:"couponActivate",couponField:"couponField",confirmForm:"confirmForm",confirmSend:"confirmSend",confirmField:"confirmCode",confirmTimer:"confirmTimer",confirmReplay:"confirmReplay",confirmErrors:"confirmErrors",confirmErrorItem:"confirmErrorItem",confirmSubstrate:"confirmSubstrate",remove:"delete",minus:"minus",plus:"plus",productItemList:"productList",productItem:"parent",productPrice:"priceContainer",productDiscount:"discountContainer",propertyItem:"propItem",dropDownSelected:"dropDownSelected",clearAll:"clearAllBasketItems",giftContainer:"giftContainer",dropDownItems:"dropDownItems",dropDownItem:"dropDownItem",minPayment:"minimumPayment",orderComment:"orderComment",fastBuy:"fastBayContainer",dropDownActive:"selected",dropDownOpened:"opened",countItems:"countItems",orderAreas:"orderAreas",orderMove:"orderMove",basketSum:"basketSum",goToOrder:"goToOrder",orderSum:"orderSum",propActive:"active",propHidden:"hidden",dropDown:"dropDown",errorWindowClose:"basketErrorClose",errorWindowMessage:"errorMessage",errorWindow:"basketError",error:"error",orderMake:"orderMake"},s={maxQuantity:"error1",orderErrors:"error2",couponError:"error3"};var c=0,p=0,f={},v={calculate:{},binding:{keypress:{},keydown:{},mouseup:{},change:{},submit:{},input:{},click:{},focus:{},keyup:{},blur:{}},event:{},tools:{},commit:{basket:{},location:{}},flags:{location:{open:!1},dropDown:{open:!1}},check:{},price:{},ajax:{},push:{},pull:{}};v.binding.click.stop=function(e){return e.stopImmediatePropagation()},v.binding.click.closeout=function(e){!0===v.flags.location.open&&v.tools.resetLocation(e),!0===v.flags.dropDown.open&&v.tools.closeDropDown()},v.binding.click.openDropDown=function(e){var t=$(this).siblings("."+m.dropDownItems);t.find("."+m.dropDownItem);return t.hasClass(m.dropDownOpened)?v.tools.closeDropDown():(t.addClass(m.dropDownOpened),v.flags.dropDown.open=!0),e.preventDefault()},v.binding.click.selectDropDown=function(e){var t=$(this),o=t.parents("."+m.dropDown),r=o.find("."+m.dropDownItem),n=o.find("."+m.dropDownSelected),i=o.find("select"),a=t.data("value"),s=t.hasClass(m.dropDownActive);o.data("trigger-id");return r.removeClass(m.dropDownActive),t.addClass(m.dropDownActive),n.html(t.html()),o.find("."+m.dropDownItems).removeClass(m.dropDownOpened),v.flags.dropDown.open=!1,0==s&&(void 0!==i&&0<i.length&&(i.find("option").prop("selected",!1),i.find('option[value="'+a+'"]').prop("selected",!0),i.trigger("change")),o.trigger("change")),e.preventDefault()},v.binding.click.confirmSend=function(e){var t=$(this),o=$("."+m.confirmErrors),r=$("."+m.confirmReplay),n=$("."+m.confirmField),i=$("."+m.confirmForm),a=new FormData,s=n.val(),n=n.data("order-id"),c=t.data("success");return a.append("siteId",siteId),a.append("orderId",n),a.append("actionType","smsConfirm"),void 0!==s&&""!=s&&4==s.length&&(a.append("smsCode",s),a=v.push.params(a),v.tools.removeError(t),v.tools.removeError(i),v.tools.clear(o),o.removeClass("opened"),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",a,"post","json",function(e){!0===e.status?(i.addClass("success"),v.tools.hideByFlag(r,!0),t.text(c)):!0===e.error&&"object"==typeof e.errors&&($.each(e.errors,function(){"string"==typeof this&&o.append($("<div/>",{class:m.confirmErrorItem}).html(this))}),o.addClass("opened"),v.tools.addError(t),v.tools.addError(i),console.error(e));v.tools.stopLoader(t)},!1)),e.preventDefault()},v.binding.click.confirmReplay=function(){var t=$(this),o=$("."+m.confirmErrors),e=new FormData,r=t.data("order-id");return e.append("siteId",siteId),e.append("orderId",r),e.append("actionType","smsReplay"),v.tools.clear(o),o.removeClass("opened"),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",e,"post","json",function(e){!0===e.status?(v.tools.startTimer("."+m.confirmTimer,"."+m.confirmReplay),t.addClass("success"),t.removeClass("ready")):!0===e.error&&"object"==typeof e.errors&&($.each(e.errors,function(){"string"==typeof this&&o.append($("<div/>",{class:m.confirmErrorItem}).html(this))}),o.addClass("opened"),console.error(e));v.tools.stopLoader(t)},!1),event.preventDefault()},v.binding.click.orderMake=function(e){var t=$(this),o=new FormData,r=(o.append("actionType","orderMake"),o.append("siteId",siteId),v.pull.getOrderFields());return v.check.required(r)&&(o=v.push.serializeFields(r,o),o=v.push.orderComment(o),o=v.push.fields(o),o=v.push.params(o),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",o,"post","json",function(e){!0===e.status&&null!=typeof e.orderResult.orderId?("undefined"!=typeof globalSettings&&void 0!==globalSettings.TEMPLATE_METRICA_ORDER&&void 0!==globalSettings.TEMPLATE_METRICA_ID&&void 0!==window["yaCounter"+globalSettings.TEMPLATE_METRICA_ID]&&window["yaCounter"+globalSettings.TEMPLATE_METRICA_ID].reachGoal(globalSettings.TEMPLATE_METRICA_ORDER),window.location.href=v.tools.addParamToUrl({orderId:e.orderResult.orderId})):!0===e.error&&(v.tools.addError(t),v.tools.pushAjaxErrors(e),console.error(e));v.tools.stopLoader(t)},!1)),e.preventDefault()},v.binding.click.setCoupon=function(e){var t,o=$("."+m.couponField),r=$(this),n=o.val();return"undefined"!=n&&""!=n?((t=new FormData).append("actionType","setCoupon"),t.append("coupon",n),t.append("siteId",siteId),v.tools.launchLoader(r),v.ajax.sendData(ajaxDir+"/ajax.php",t,"post","json",function(e){!0===e.status&&!0===e.success?window.location.reload():!0===e.error&&(v.tools.addError(o),v.tools.pushAjaxErrors(e,"couponError"),console.error(e));v.tools.stopLoader(r)},!1)):v.tools.addError(o),e.preventDefault()},v.binding.click.clearAll=function(e){var t=$(this),o=new FormData;return o.append("actionType","clearAll"),o.append("siteId",siteId),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",o,"post","json",function(e){!0===e.status?window.location.reload():!0===e.error&&(v.tools.pushAjaxErrors(e),console.error(e));v.tools.stopLoader(t)},!1),e.preventDefault()},v.binding.click.deleteItem=function(e){var t=$(this),o=t.data("id"),r=new FormData;return r.append("actionType","removeItem"),r.append("basketId",o),r.append("siteId",siteId),r=v.push.params(r),r=v.push.fields(r),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",r,"post","json",function(e){!0===e.status?t.parents("."+m.productItemList).find("."+m.productItem).length<=1?window.location.reload():(t.parents("."+m.productItem).remove(),v.commit.basket.proccesing(e)):!0===e.error&&(v.tools.pushAjaxErrors(e),console.error(e))},!1),e.preventDefault()},v.binding.click.quantityMinus=function(e){var t=$(this).parents("."+m.productItem).find("."+m.quantityField),o=parseFloat(t.data("ratio")),r=parseFloat(t.val());return o<r&&(t.val(+(r-o).toFixed(5)),t.trigger("change")),e.preventDefault()},v.binding.click.quantityPlus=function(e){var t=$(this).parents("."+m.productItem).find("."+m.quantityField),o=parseFloat(t.data("ratio")),o=parseFloat(t.val())+o;return t.val(+o.toFixed(5)),t.trigger("change"),e.preventDefault()},v.binding.click.locationLink=function(e){var t=$(this),o=t.parents("."+m.locationSwitchContainer),r=o.siblings("."+m.locationField),n=t.data("path"),t=t.data("id");return r.val(n),r.data("location",t),v.tools.closeLocationDropdown(o),v.commit.basket.flush(),e.preventDefault()},v.binding.click.orderMove=function(){var e=$("."+m.order),t=$("."+m.minPayment),o=!0;if("object"==typeof e&&e.is(":visible")?v.tools.scrollTo(e):"object"!=typeof t||$.isEmptyObject(t)||(t.is(":visible")?v.tools.scrollTo(t):o=!1),!0===o)return event.preventDefault()},v.binding.click.closeErrorWindow=function(){var e=$(this).parents("."+m.errorWindow);return v.tools.closeWindow(e),event.preventDefault()},v.binding.submit.confirmForm=function(e){return $("."+m.confirmSend).trigger("click"),e.preventDefault()},v.binding.keyup.location=function(e){clearTimeout(c),c=setTimeout(v.commit.location.pushComponent,400)},v.binding.input.confirm=function(e){var t=$(this),o=(o=t.val()).replace(/[^0-9]/gim,"").substr(0,4);if(t.val(o),void 0!==o&&o.length<=4)for(var r=$("."+m.confirmSubstrate);o.length<4;)o+="0";r.html(o)},v.binding.keypress.quantity=function(e){if(-1===[44,46,48,49,50,51,52,53,54,55,56,57].indexOf(e.which))return e.preventDefault()},v.binding.focus.location=function(e){var t=$(this),o=t.val().toString(),r=t.data("location");t.data("last-value",o),t.data("last-id",r),t.val(""),t.data("location","")},v.binding.focus.coupon=function(e){var t=$(this);v.tools.removeError(t)},v.binding.blur.location=function(e){return!1===v.flags.location.open&&v.tools.resetLocation(e),!1},v.binding.change.quantity=function(e){var t=$(this),o=t.data("id"),r=parseFloat(t.data("max-quantity")),n=parseFloat(t.data("ratio")),i=parseFloat(t.val()),a=+(i/n).toFixed(5);v.tools.removeError(t),r<i?(i=r,t.val(i),v.tools.addError(t),v.tools.openWindow(s.maxQuantity)):(isNaN(i)||i<n?i=n:(0^a)!=a?i=Math.ceil(i/n)*n:t.data("last-value",i),t.val(i)),clearTimeout(c),c=setTimeout(function(){v.commit.basket.updateProduct(o,i)},400)},v.binding.change.person=function(e){var t=$(this),o=$("."+m.orderForm),r=$("."+m.orderAreas),n=$("."+m.personTypeModules),t=parseInt(t.val());n.filter('[data-id="'+t+'"]').prop("checked",!0),p=0,v.tools.hideByFlag(r,!1,"active"),v.tools.hideByFlag(r.filter('[data-person-id="'+t+'"]'),!0,"active"),v.tools.hideByFlag(o,!1,"active"),v.tools.hideByFlag(o.filter('[data-id="'+t+'"]'),!0,"active"),v.commit.basket.flush()},v.binding.change.delivery=function(e){v.commit.basket.flush()},v.binding.change.paysystem=function(e){v.commit.basket.flush()},v.binding.change.budget=function(e){v.commit.basket.realtime()},v.binding.change.extraService=function(e){var t,o=$(this),r=$("."+m.basket).find("."+m.delivery).find("option:selected"),n=o.attr("type"),i=o.prop("tagName").toLowerCase(),a={current:parseFloat(o.val()),default:parseFloat(o.data("default")),price:parseFloat(o.data("price")),last:parseFloat(o.data("last"))},r={price:parseFloat(r.data("price")),name:r.data("name")},s={},c={};"text"==n?(t=o.parents("."+m.extraServiceItem).find("."+m.extraServiceItemSum),(isNaN(a.current)||a.current<0)&&(a.current=a.default),s.sum=a.current*a.price,c.sum=a.last*a.price,r.sum=r.price-c.sum+s.sum,t.html(v.price.format(s.sum,!1,!1,!1,!0)),o.val(a.current).data("last",a.current)):"checkbox"==n?r.sum=o.is(":checked")?r.price+a.price:r.price-a.price:"select"==i&&(a.current=parseFloat(o.find("option:selected").data("price")),r.sum=r.price-a.last+a.current,o.data("last",a.current)),v.commit.basket.flush()},v.commit.basket.updateProduct=function(e,t){var o,r;"number"==typeof e&&"number"==typeof t?(o=$("."+m.basket),(r=new FormData).append("actionType","updateItem"),r.append("basketId",e),r.append("quantity",t),r.append("siteId",siteId),r=v.push.params(r),r=v.push.fields(r),v.tools.launchLoader(o,"wait"),v.ajax.sendData(ajaxDir+"/ajax.php",r,"post","json",function(e){!0===e.status?v.commit.basket.proccesing(e):!0===e.error&&(v.tools.pushAjaxErrors(e),console.error(e));v.tools.stopLoader(o,"wait")},!1)):console.error("check transmitted data")},v.commit.basket.flush=function(){var t=$("."+m.basket),e=new FormData;e.append("actionType","getCompilation"),e.append("siteId",siteId),e=v.push.fields(e),e=v.push.params(e),v.tools.launchLoader(t,"wait"),v.ajax.sendData(ajaxDir+"/ajax.php",e,"post","json",function(e){!0===e.status?v.commit.basket.proccesing(e):!0===e.error&&(v.tools.pushAjaxErrors(e),console.error(e));v.tools.stopLoader(t,"wait")},!1)},v.commit.basket.proccesing=function(e){v.commit.basket.setCompilation(e),v.commit.basket.items(),v.commit.basket.deliveries(),v.commit.basket.paysystems(),v.commit.basket.minOrderPrice(),v.commit.basket.gifts(e),v.commit.basket.realtime(),v.event.trigger("processing",e)},v.commit.basket.items=function(){var e,n;"object"!=typeof f.items||$.isEmptyObject(f.items)||(e=f.items,n=$("."+m.productItem),$.each(e,function(e,t){var o=n.filter('[data-id="'+t.PRODUCT_ID+'"]'),r=o.find("."+m.productPrice),o=o.find("."+m.productDiscount).addClass("hidden");r.html(t.PRICE_FORMATED),r.data("price",t.PRICE),0<t.DISCOUNT&&o.html(t.BASE_PRICE_FORMATED).removeClass("hidden")}))},v.commit.basket.deliveries=function(){var n,i,a,s,c,d,l,e;if("object"==typeof f.order.DELIVERIES&&!$.isEmptyObject(f.order.DELIVERIES))return e=(n=$("."+m.propActive+" ."+m.delivery)).parents("."+m.dropDown),i=e.find("."+m.dropDownItems),a=e.find("."+m.dropDownSelected),s=!1,c=parseInt(n.val()),d=0,l=f.order.DELIVERIES,e=v.tools.sortByIndex(l),p=v.pull.getLastDeliveryId(),v.tools.clear(n),v.tools.clear(i),$.each(e,function(e,t){var t=l[t],o=$("<option/>").val(t.ID),r=$("<div/>",{class:m.dropDownItem}).data("value",t.ID);o.data({price:t.PRICE,name:t.NAME}),o.html(t.NAME+" "+t.PRICE_FORMATED),r.html(t.NAME+" "+t.PRICE_FORMATED),c==t.ID&&(o.attr("selected","selected"),r.addClass(m.dropDownActive),a.html(t.NAME+" "+t.PRICE_FORMATED),d=t.ID),0==s&&(s=r),n.append(o),i.append(r)}),c=parseInt(n.val()),0!=d||""==c||void 0===(e=l[c])||$.isEmptyObject(e)||(s.addClass(m.dropDownActive),a.html(e.NAME+" "+e.PRICE_FORMATED)),v.commit.basket.deliveryStores(c),v.commit.basket.deliveryProperties(c),p!=c&&(v.commit.basket.deliveryServices(c),v.commit.basket.deliveryPeriod(c),v.commit.basket.deliveryDescription(c)),p=c},v.commit.basket.deliveryStores=function(n){if("number"!=typeof n||isNaN(n)||"object"!=typeof f.order.DELIVERIES||"object"!=typeof f.stores)return!1;var e=$("."+m.propActive+" ."+m.storesContainer),i=e.find("."+m.storesSwitch),t=i.parents("."+m.dropDown),a=t.find("."+m.dropDownItems),s=t.find("."+m.dropDownSelected),c=!1,d=!0,l=!1,p=parseInt(i.val()),u=(v.tools.clear(i),v.tools.clear(a),f.order.DELIVERIES),t=f.stores;"object"!=typeof u[n].STORES||$.isEmptyObject(u[n].STORES)||($.each(t,function(e,t){var o,r;-1!=$.inArray(t.ID,u[n].STORES)&&(o=$("<option/>").val(t.ID),r=$("<div/>",{class:m.dropDownItem}).data("value",t.ID),o.html(t.TITLE+" - "+t.ADDRESS+" - "+t.PRODUCTS_STATUS),r.html(t.TITLE+" - "+t.ADDRESS+" - "+t.PRODUCTS_STATUS),p==t.ID&&(o.attr("selected","selected"),r.addClass(m.dropDownActive),s.html(t.TITLE+" - "+t.ADDRESS+" - "+t.PRODUCTS_STATUS),l=t.ID),0==c&&(c=r),i.append(o),a.append(r),d=!1)}),p=parseInt(i.val()),0==l&&""!=p&&(t=t[p],c.addClass(m.dropDownActive),s.html(t.TITLE+" - "+t.ADDRESS+" - "+t.PRODUCTS_STATUS))),v.tools.hideByFlag(e,d)},v.commit.basket.deliveryServices=function(e){if("number"!=typeof e||1==isNaN(e)||e<=0)return!1;void 0!==f.order.DELIVERIES[e].EXTRA_SERVICES_HTML&&(t=f.order.DELIVERIES[e].EXTRA_SERVICES_HTML);var t,e=$("."+m.propActive+" ."+m.extraServiceItems),o=void 0===t||""==t;v.tools.hideByFlag(e,o),!1==o?e.html(t):v.tools.clear(e)},v.commit.basket.deliveryProperties=function(e){if("number"!=typeof e||"object"!=typeof f.order.PROPERTIES)return!1;var t=$("."+m.propActive+" ."+m.deliveryProps),e=f.order.PROPERTIES.PROPERTIES;v.tools.hideByFlag(t,!0),$.each(e,function(){"object"!=typeof this.RELATION||$.isEmptyObject(this.RELATION)||(this.DELIVERY_RELATION,"Y"===this.DELIVERY_RELATION&&v.tools.hideByFlag(t.filter('[data-property-id="'+this.ID+'"]')))})},v.commit.basket.deliveryPeriod=function(e){if("number"!=typeof e||isNaN(e)||"object"!=typeof f.order.DELIVERIES)return!1;var t=$("."+m.propActive+" ."+m.deliveryPeriod),o=t.find("."+m.deliveryPeriodDescription),r=f.order.DELIVERIES[e].PERIOD_DESCRIPTION;v.tools.clear(o),"object"==typeof f.order.DELIVERIES[e]&&""!=r&&o.html(r),v.tools.hideByFlag(t,""==r)},v.commit.basket.deliveryDescription=function(e){if("number"!=typeof e||isNaN(e)||"object"!=typeof f.order.DELIVERIES)return!1;var t=$("."+m.propActive+" ."+m.deliveryDescription),o=$("."+m.propActive+" ."+m.deliveryModulesContainer),r=o.find("."+m.deliveryModulesContainerDesc),n=f.order.DELIVERIES[e].DESCRIPTION;v.tools.clear(t),v.tools.clear(o),o.append(r),"object"==typeof f.order.DELIVERIES[e]&&""!=n&&t.html(n),v.tools.hideByFlag(t,""==n)},v.commit.basket.gifts=function(e){var t=$("."+m.giftContainer),e=void 0!==e.gifts?e.gifts:"";t.html(e)},v.commit.basket.paysystems=function(){"object"==typeof f.order.PAYSYSTEMS&&!$.isEmptyObject(f.order.PAYSYSTEMS)||(f.order.PAYSYSTEMS={0:{ID:0,NAME:basketLang["empty-paysystems"]}});var n=$("."+m.propActive+" ."+m.paysystem),e=n.parents("."+m.dropDown),i=e.find("."+m.dropDownItems),a=e.find("."+m.dropDownSelected),s=!1,c=parseInt(n.val()),d=0,l=f.order.PAYSYSTEMS,e=v.tools.sortByIndex(l);v.tools.clear(n),v.tools.clear(i),$.each(e,function(e,t){var t=l[t],o=$("<option/>").val(t.ID),r=$("<div/>",{class:m.dropDownItem}).data("value",t.ID);o.html(t.NAME),r.html(t.NAME),c==t.ID&&(o.attr("selected","selected"),r.addClass(m.dropDownActive),a.html(t.NAME),d=t.ID),0==s&&(s=r),n.append(o),i.append(r)}),c=parseInt(n.val()),0!=d||""==c||void 0===(e=l[c])||$.isEmptyObject(e)||(s.addClass(m.dropDownActive),a.html(e.NAME)),v.commit.basket.payProperties(),v.commit.basket.payInner()},v.commit.basket.payProperties=function(){if("object"!=typeof f.order.PROPERTIES)return!1;var e=$("."+m.propActive+" ."+m.paysystemProps),t=f.order.PROPERTIES.PROPERTIES;v.tools.hideByFlag(e,!0),$.each(t,function(){"object"!=typeof this.RELATION||$.isEmptyObject(this.RELATION)||(this.PAYSYSTEM_RELATION,"Y"===this.PAYSYSTEM_RELATION&&v.tools.hideByFlag(e.filter('[data-property-id="'+this.ID+'"]')))})},v.commit.basket.payInner=function(){var e=$("."+m.budgetContainer),t=$("."+m.budget),o={container:!0};$.isEmptyObject(f.order.INNER_PAYMENT)||(o.container=!1,$.isEmptyObject(f.order.INNER_PAYMENT.RANGE.MAX)&&t.data("max",f.order.INNER_PAYMENT.RANGE.MAX)),!0===o.container&&t.removeAttr("checked"),v.tools.hideByFlag(e,o.container)},v.commit.basket.minOrderPrice=function(){var e,t,o,r;void 0!==f.min_order_amount&&(e=$("."+m.order),t=$("."+m.fastBuy),o=$("."+m.goToOrder),r=$("."+m.minPayment),v.tools.hideByFlag(e,!f.min_order_amount),v.tools.hideByFlag(t,!f.min_order_amount),v.tools.hideByFlag(o,!f.min_order_amount),v.tools.hideByFlag(r,f.min_order_amount))},v.commit.basket.realtime=function(){var e={fields:{},calculate:{}};e.fields.basket=$("."+m.basket),e.fields.budget=e.fields.basket.find("."+m.propActive+" ."+m.budget),e.fields.delivery=e.fields.basket.find("."+m.propActive+" ."+m.delivery),e.fields.basketSum=e.fields.basket.find("."+m.basketSum),e.fields.deliverySum=e.fields.basket.find("."+m.deliverySum),e.fields.basketItems=e.fields.basket.find("."+m.productItem),e.fields.orderSumContainer=e.fields.basket.find("."+m.orderSum),e.fields.countItemsContainer=e.fields.basket.find("."+m.countItems),e.calculate.amount=v.calculate.getAmountProducts(e.fields.basketItems),e.calculate.basketSum=v.calculate.getBasketSum(e.fields.basketItems),e.calculate.orderSum=v.calculate.getOrderSum(e.fields.basketItems,e.fields.delivery,e.fields.budget,e.calculate.basketSum),e.calculate.deliverySum=v.calculate.getDeliverySum(e.fields.delivery),e.fields.countItemsContainer.html(e.calculate.amount),e.fields.orderSumContainer.html(v.price.format(e.calculate.orderSum,!1,!1,!1,!0)),e.fields.deliverySum.html(v.price.format(e.calculate.deliverySum,!1,!1,!1,!0)),e.fields.basketSum.html(v.price.format(e.calculate.basketSum,!1,!1,!1,!0))},v.commit.basket.setCompilation=function(e){return f="object"!=typeof e||$.isEmptyObject(e)||"object"!=typeof e.compilation||$.isEmptyObject(e)?{}:e.compilation},v.commit.location.pushComponent=function(){var t=$("."+m.propActive+" ."+m.locationField),o=t.siblings("."+m.locationSwitchContainer),e=t.val().toString(),r=new FormData;if(""==e)return!1;r.append("actionType","pushLocation"),r.append("value",e),r.append("siteId",siteId),v.tools.launchLoader(t),v.ajax.sendData(ajaxDir+"/ajax.php",r,"post","json",function(e){"string"==typeof e.component&&""!=e.component?(v.flags.location.open=!0,o.html(e.component)):!0===e.error&&console.error(e);v.tools.stopLoader(t)},!1)},v.calculate.getOrderSum=function(e,t,o,r){return void 0===r&&(r=0),"object"==typeof t&&(r+=v.calculate.getDeliverySum(t)),"object"==typeof o&&(r-=v.calculate.getBudgetMaxSum(o)),0<=r?r:0},v.calculate.getBasketSum=function(e){var t,o,r=0;return"object"==typeof e&&(t=e.find("."+m.productPrice),o=e.find("."+m.quantityField),t.each(function(e){var t=parseFloat($(this).data("price")),e=parseFloat(o.eq(e).val());r+=t*e})),r},v.calculate.getAmountProducts=function(e,t){return void 0===t&&(t=0),"object"!=typeof e||$.isEmptyObject(e)||e.find("."+m.quantityField).each(function(){t+=parseFloat($(this).val())}),t},v.calculate.getDeliverySum=function(e){if("object"==typeof e&&!$.isEmptyObject(e)){e=parseFloat(e.find("option:selected").data("price"));if(!isNaN(e)&&0<e)return e}return 0},v.calculate.getBudgetMaxSum=function(e){if("object"==typeof e&&!$.isEmptyObject(e)&&e.is(":checked")){var t=parseFloat(e.data("account-balance")),e=parseFloat(e.data("max"));if(isNaN(e)||void 0===e||e<t&&(t=e),0<t)return t}return 0},v.push.serializeFields=function(e,o){return void 0===o&&(o={}),void 0===e||$.isEmptyObject(e)||$.each(e,function(){var e=$(this),t={multiple:e.prop("multiple"),tagName:e.prop("tagName").toLowerCase(),checked:e.prop("checked"),type:e.attr("type"),name:e.attr("name").toLowerCase(),id:e.data("id"),val:e.val()};"undefined"===t.id&&console.error("undefined id"),"input"==t.tagName?"text"==t.type||"date"==t.type||"number"==t.type&&""!=t.val||"checkbox"==t.type||"radio"==t.type&&1==t.checked?o.append("properties["+t.id+"]",t.val):"file"==t.type&&""!=t.val&&(1<e[0].files.length?$.each(e[0].files,function(){o.append("properties["+t.id+"][]",this)}):o.append("properties["+t.id+"]",e[0].files[0])):"textarea"==t.tagName&&""!=t.val?o.append("properties["+t.id+"]",t.val):"select"==t.tagName&&(1==t.multiple?0<(e=e.find("option:selected")).length&&$.each(e,function(){o.append("properties["+t.id+"][]",$(this).val())}):o.append("properties["+t.id+"]",t.val))}),o},v.push.fields=function(e){return e=v.push.formData(e,v.pull.getExtraServices(),"extraServices"),e=v.push.formData(e,v.pull.getPersonTypeId(),"personTypeId"),e=v.push.formData(e,v.pull.getInnerPayment(),"innerPayment"),e=v.push.formData(e,v.pull.getPaysystemId(),"paysystemId"),e=v.push.formData(e,v.pull.getDeliveryId(),"deliveryId"),e=v.push.formData(e,v.pull.getLocationId(),"locationId"),e=v.push.formData(e,v.pull.getStoreId(),"store")},v.push.params=function(e){return e="object"==typeof basketParams?v.push.formData(e,basketParams,"params"):e},v.push.orderComment=function(e){var t=$("."+m.propActive+" ."+m.orderComment);return"object"!=typeof t||$.isEmptyObject(t)||null!=(t=t.val())&&""!=t&&(e=v.push.formData(e,t.toString(),"comment")),e},v.push.formData=function(e,t,o){if("object"==typeof t)for(var r in t)"object"==typeof t[r]?v.push.formData(e,t[r],o+"["+r+"]"):e.append(o+"["+r+"]",t[r]);else e.append(o,t);return e},v.pull.getOrderFields=function(){var e=$([]),t=$("."+m.basket);return e.push.apply(e,t.find("."+m.propActive+" ."+m.propertyItem+':not(".'+m.propHidden+'") input')),e.push.apply(e,t.find("."+m.propActive+" ."+m.propertyItem+':not(".'+m.propHidden+'") select')),e.push.apply(e,t.find("."+m.propActive+" ."+m.propertyItem+':not(".'+m.propHidden+'") textarea')),e},v.pull.getLocationId=function(){var e=$("."+m.propActive+" ."+m.locationField),e=parseFloat(e.data("location"));return isNaN(e)?0:e},v.pull.getStoreId=function(){return v.tools.getFieldValue("."+m.propActive+" ."+m.storesContainer+':not(".'+m.propHidden+'") .'+m.storesSwitch)},v.pull.getInnerPayment=function(){return v.tools.getFieldValue("."+m.propActive+" ."+m.budgetContainer+':not(".'+m.propHidden+'") .'+m.budget)},v.pull.getPaysystemId=function(){return v.tools.getFieldValue("."+m.propActive+" ."+m.paysystem)},v.pull.getDeliveryId=function(){return v.tools.getFieldValue("."+m.propActive+" ."+m.delivery)},v.pull.getPersonTypeId=function(){return v.tools.getFieldValue("."+m.personType)},v.pull.getExtraServices=function(){var e=$("."+m.propActive+" ."+m.extraServiceItemContainer+':not(".'+m.propHidden+'")').find("."+m.extraService),t=($("."+m.propActive+" ."+m.delivery),[]);v.pull.getDeliveryId(),v.pull.getLastDeliveryId();return"object"==typeof e&&0<e.length&&$.each(e,function(){var e=$(this),e={value:v.tools.getFieldValue(e,!1),id:e.data("id")};""!=e.value&&t.push(e)}),t},v.pull.getLastDeliveryId=function(){var e;return p=0!=p||"object"!=typeof(e=$("."+m.propActive+" ."+m.delivery))||$.isEmptyObject(e)?p:parseInt(e.data("default"))},v.check.required=function(e){var t=!0;return void 0!==e||$.isEmptyObject(e)||(e=v.pull.getOrderFields()),$.each(e,function(){var e=$(this);"Y"!=e.data("required")||v.check.filling(e)||(v.tools.addError(e),!0===t&&(t=v.tools.scrollTo(e)))}),t},v.check.filling=function(e){if(void 0!==e&&!$.isEmptyObject(e)){e={tagName:e.prop("tagName").toLowerCase(),checked:e.prop("checked"),mail:e.data("mail"),type:e.attr("type"),name:e.attr("name"),val:e.val()};if("undefined"!=e.mail&&"Y"==e.mail&&!v.tools.validateEmail(e.val))return!1;if("checkbox"==e.type&&1==e.checked||"textarea"==e.tagName&&""!=e.val||"number"==e.type&&""!=e.val||"text"==e.type&&""!=e.val||"date"==e.type&&""!=e.val||"file"==e.type&&""!=e.val)return!0}return!1},v.price.format=function(e,t,o,r,n){var i;return t=void 0!==t?t:2,o=void 0!==o?o:".",r=void 0!==r?r:" ",n=void 0!==n&&n,null!=e&&""!==e&&(!1===o&&void 0!==siteCurrency.DEC_POINT&&(o=siteCurrency.DEC_POINT),!1===t&&void 0!==siteCurrency.DECIMALS&&(t=siteCurrency.DECIMALS),!1===r&&void 0!==siteCurrency.THOUSANDS_VARIANT&&(r=v.price.thousandsVariant(siteCurrency.THOUSANDS_VARIANT)),r=(e=e.toString().split("."))[0].replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1"+r),i="",void 0!==e[1]&&0<t&&(i=o+e[1].substr(0,t)),!0===n?v.price.langFormat(r+i):r+i)},v.price.langFormat=function(e){return siteCurrency.FORMAT_STRING.toString().replace("#",e)},v.price.thousandsVariant=function(e){return e=void 0!==e?e:"N",siteCurrency.SEPARATORS[e]},v.ajax.sendData=function(e,t,o,r,n,i,a){i=void 0!==i&&i,a=void 0!==a&&a,$.ajax({contentType:a,dataType:r,processData:!1,cache:!1,url:e,type:o,data:t,success:n,beforeSend:function(e,t){v.tools.launchLoader(i)},complete:function(e,t){v.tools.stopLoader(i)},error:function(e,t,o){console.error({httpResponse:e.responseText,status:e.statusText}),console.error(e,t,o)}})},v.event.trigger=function(e,t){t=void 0!==t?t:[],""!=(e=void 0!==e?e:"")&&$(document).trigger("DwBasket."+e,t)},v.tools.resetLocation=function(e){var t=$("."+m.propActive+" ."+m.locationField),o=t.siblings("."+m.locationSwitchContainer),r=t.val().toString(),n=t.data("location").toString();v.tools.closeLocationDropdown(o),""!=r&&""!=n||(o=t.data("last-id"),r=t.data("last-value"),t.data("location",o),t.val(r))},v.tools.closeLocationDropdown=function(e){"object"==typeof(e=void 0!==e?e:null)&&!0===v.flags.location.open&&(v.flags.location.open=!1,v.tools.clear(e))},v.tools.getFieldValue=function(e,t){if(t=void 0===t||t,"string"==typeof e&&""!==e||"object"==typeof e&&0<e.length){e="object"==typeof e?e:$(e);if("object"==typeof e&&0<e.length){e={tagName:e.prop("tagName").toLowerCase(),checked:e.prop("checked"),type:e.attr("type"),val:e.val()};if("select"==e.tagName&&null!=e.val&&""!==e.val)return e.val.toString();if("input"!=e.tagName||"checkbox"!=e.type&&"radio"!=e.type){if("input"==e.tagName&&("text"==e.type||"number"==e.type)&&""!=e.val)return e.val.toString()}else{if(1==e.checked)return e.val.toString();if(!1===t)return"N"}}}return 0},v.tools.startTimer=function(e,t,o){var r,n,i;t=void 0!==t&&t,o=void 0!==o?o:60,void 0!==e&&""!=e&&(r=$(e),v.tools.hideByFlag(r,!1),n={current:new Date,end:new Date(Date.now()+1e3*o)},"object"!=typeof r||$.isEmptyObject(r)||"number"==typeof o&&0<o&&(i=setInterval(function(){n.current=new Date,n.end.getTime()>n.current.getTime()?(n.remaining=new Date(n.end.getTime()-n.current.getTime()),n.minutes=Math.floor(n.remaining/1e3/60%60),n.seconds=Math.floor(n.remaining/1e3%60),r.text(n.minutes+":"+n.seconds)):(v.tools.hideByFlag(r,!0),clearInterval(i),0!=t&&$(t).addClass("ready"))},900)))},v.tools.clear=function(e){if("object"==typeof e)return e.html("")},v.tools.hideByFlag=function(e,t,o){if(t=void 0!==t&&t,o=void 0!==o?o:"hidden","object"==typeof e)return!0===t?e.addClass(o):e.removeClass(o)},v.tools.launchLoader=function(e,t){if(t=void 0!==t?t:"loading","object"==typeof e)return e.addClass(t)},v.tools.stopLoader=function(e,t){if(t=void 0!==t?t:"loading","object"==typeof e)return e.removeClass(t)},v.tools.addError=function(e,t){if(t=void 0!==t?t:m.error,"object"==typeof e)return e.addClass(t)},v.tools.removeError=function(e,t){if(t=void 0!==t?t:m.error,"object"==typeof e)return e.removeClass(t)},v.tools.addParamToUrl=function(e){e=void 0!==e?e:{};var o=window.location.href,r=-1===o.indexOf("?")?"?":"&";return"object"!=typeof e||$.isEmptyObject(e)||$.each(e,function(e,t){r=-1===(o=o+r+e+"="+t).indexOf("?")?"?":"&"}),o},v.tools.validateEmail=function(e){return"string"==typeof e&&""!=e&&/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/.test(String(e).toLowerCase())},v.tools.scrollTo=function(e){return"object"==typeof e&&$([document.documentElement,document.body]).animate({scrollTop:e.offset().top-300},600),!1},v.tools.pushAjaxErrors=function(e,t){var o,r;return t=void 0!==t?t:"orderErrors","object"!=typeof(e=void 0!==e?e:{})||$.isEmptyObject(e)||(r=(o=$("."+s[t])).find("."+m.errorWindowMessage),$.isEmptyObject(o))||$.isEmptyObject(r)||(r.html(function e(t,o){o=void 0!==o?o:"";var r=" &bull; ";"string"==typeof t&&""!=t?o+=(""!=o?r:"")+t:"object"==typeof t&&$.each(t,function(){o=e(this,o)});return o}(e)),v.tools.openWindow(s[t])),!1},v.tools.sortByIndex=function(e){var o={};return void 0===e||$.isEmptyObject(e)||$.each(e,function(e,t){void 0!==t.INDEX&&(o[t.INDEX]=t.ID)}),o},v.tools.openWindow=function(e){void 0===e||""==e||"object"!=typeof(e=$("."+e))||$.isEmptyObject(e)||e.css({display:"block"})},v.tools.closeWindow=function(e){"object"!=typeof e||$.isEmptyObject(e)||e.css({display:"none"})},v.tools.getNamesFromCluster=function(){return m},v.tools.closeDropDown=function(){!0===v.flags.dropDown.open&&($("."+m.dropDownItems).removeClass(m.dropDownOpened),v.flags.dropDown.open=!1)},DwBasket=v,$(document).on("click","."+m.order+" ."+m.dropDownSelected,v.binding.click.openDropDown),$(document).on("click","."+m.order+" ."+m.dropDownItem,v.binding.click.selectDropDown),$(document).on("click","."+m.order+" ."+m.dropDown,v.binding.click.stop),$(document).on("click","."+m.errorWindowClose,v.binding.click.closeErrorWindow),$(document).on("click","."+m.locationSwitchLink,v.binding.click.locationLink),$(document).on("click","."+m.locationSwitchContainer,v.binding.click.stop),$(document).on("click","."+m.confirmReplay,v.binding.click.confirmReplay),$(document).on("click","."+m.confirmSend,v.binding.click.confirmSend),$(document).on("click","."+m.couponButton,v.binding.click.setCoupon),$(document).on("click","."+m.remove,v.binding.click.deleteItem),$(document).on("click","."+m.minus,v.binding.click.quantityMinus),$(document).on("click","."+m.plus,v.binding.click.quantityPlus),$(document).on("click","."+m.orderMake,v.binding.click.orderMake),$(document).on("click","."+m.orderMove,v.binding.click.orderMove),$(document).on("click","."+m.clearAll,v.binding.click.clearAll),$(document).on("click","",v.binding.click.closeout),$(document).on("submit","."+m.confirmForm,v.binding.submit.confirmForm),$(document).on("keyup","."+m.locationField,v.binding.keyup.location),$(document).on("input","."+m.confirmField,v.binding.input.confirm),$(document).on("keypress","."+m.quantityField,v.binding.keypress.quantity),$(document).on("keypress","."+m.extraService,v.binding.keypress.quantity),$(document).on("focus","."+m.locationField,v.binding.focus.location),$(document).on("focus","."+m.couponField,v.binding.focus.coupon),$(document).on("blur","."+m.locationField,v.binding.blur.location),$(document).on("change","."+m.extraService,v.binding.change.extraService),$(document).on("change","."+m.quantityField,v.binding.change.quantity),$(document).on("change","."+m.paysystem,v.binding.change.paysystem),$(document).on("change","."+m.personType,v.binding.change.person),$(document).on("change","."+m.delivery,v.binding.change.delivery),$(document).on("change","."+m.budget,v.binding.change.budget)});