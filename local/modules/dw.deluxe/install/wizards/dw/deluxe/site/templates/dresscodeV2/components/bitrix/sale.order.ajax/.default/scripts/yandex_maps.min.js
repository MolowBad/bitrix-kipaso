BX.namespace("BX.Sale.OrderAjaxComponent.Maps"),BX.Sale.OrderAjaxComponent.Maps={init:function(t){return this.context=t||{},this.pickUpOptions=this.context.options.pickUpMap,this.propsOptions=this.context.options.propertyMap,this.maxWaitTimeExpired=!1,this},initializePickUpMap:function(t){ymaps&&(this.pickUpMap=new ymaps.Map("pickUpMap",{center:t?[t.GPS_N,t.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom},{autoFitToViewport:"always"}),this.pickUpMap.behaviors.disable("scrollZoom"),this.pickUpMap.events.add("click",BX.delegate(function(){this.pickUpMap.balloon.isOpen()&&this.pickUpMap.balloon.close()},this)))},pickUpMapFocusWaiter:function(){this.pickUpMap&&this.pickUpMap.geoObjects?this.setPickUpMapFocus():setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)},setPickUpMapFocus:function(){var t,e,s=this.pickUpMap.geoObjects.getBounds();s&&s.length&&(t=s[1][0]-s[0][0],e=s[1][1]-s[0][1],s[0][0]-=t/10,s[0][1]-=e/10,s[1][0]+=t/10,s[1][1]+=e/10,this.pickUpMap.setBounds(s,{checkZoomRange:!0}))},showNearestPickups:function(e,t){var s,i;ymaps&&(s=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto",i=this.pickUpOptions.geoLocationMaxTime||5e3,ymaps.geolocation.get({provider:s,timeOut:i}).then(BX.delegate(function(t){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,t.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon"),this.pickUpMap.geoObjects.add(t.geoObjects),e(t))},this),BX.delegate(function(){this.maxWaitTimeExpired||(this.maxWaitTimeExpired=!0,t())},this)))},buildBalloons:function(t){if(ymaps){var s=this;this.pickUpPointsJSON=[];for(var e=0;e<t.length;e++){var i=this.getStoreInfoHtml(t[e]),i=(this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[t[e].GPS_N,t[e].GPS_S]},properties:{storeId:t[e].ID}}),new ymaps.Placemark([t[e].GPS_N,t[e].GPS_S],{hintContent:BX.util.htmlspecialchars(t[e].TITLE)+"<br />"+BX.util.htmlspecialchars(t[e].ADDRESS),storeTitle:t[e].TITLE,storeBody:i,id:t[e].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass('<h3>{{ properties.storeTitle }}</h3>{{ properties.storeBody|raw }}<br /><a class="btn btn-sm btn-default" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var t=document.querySelector("a[data-store]");t&&BX.bind(t,"click",this.selectStoreByClick)},clear:function(){var t=document.querySelector("a[data-store]");t&&BX.unbind(t,"click",this.selectStoreByClick),this.constructor.superclass.clear.call(this)},selectStoreByClick:function(t){var e=t.target||t.srcElement;s.pickUpMap.container.isFullscreen()&&s.pickUpMap.container.exitFullscreen(),s.context.selectStore(e.getAttribute("data-store")),s.context.clickNextAction(t),s.pickUpMap.balloon.close()}})}));BX("BUYER_STORE").value===t[e].ID&&i.options.set("preset","islands#redDotIcon"),this.pickUpMap.geoObjects.add(i)}}},selectBalloon:function(e){this.pickUpMap&&this.pickUpMap.geoObjects&&this.pickUpMap.geoObjects.each(BX.delegate(function(t){t.properties.get("id")&&t.options.unset("preset"),t.properties.get("id")===e&&(t.options.set({preset:"islands#redDotIcon"}),this.pickUpMap.panTo([t.geometry.getCoordinates()]))},this))},pickUpFinalAction:function(){var e;this.pickUpMap&&this.pickUpMap.geoObjects&&(e=BX("BUYER_STORE"),this.pickUpMap.geoObjects.each(function(t){t.properties.get("id")===e.value?t.options.set({preset:"islands#redDotIcon"}):0<parseInt(t.properties.get("id"))&&t.options.unset("preset")}))},initializePropsMap:function(t){ymaps&&(this.propsMap=new ymaps.Map("propsMap",{center:[t.lat,t.lon],zoom:t.zoom},{autoFitToViewport:"always"}),this.propsMap.behaviors.disable("scrollZoom"),this.propsMap.events.add("click",BX.delegate(function(t){var o,t=t.get("coords");0===this.propsMap.geoObjects.getLength()?((o=new ymaps.Placemark([t[0],t[1]],{},{draggable:!0,preset:"islands#redDotIcon"})).events.add(["parentchange","geometrychange"],function(){var t,e,s=BX("orderDescription"),i=o.geometry.getCoordinates();s&&(-1===(e=s.value.indexOf(BX.message("SOA_MAP_COORDS")+":"))?s.value=BX.message("SOA_MAP_COORDS")+": "+i[0]+", "+i[1]+"\r\n"+s.value:(i=BX.message("SOA_MAP_COORDS")+": "+i[0]+", "+i[1],t=s.value.substring(0,e),e=s.value.substring(e+i.length),s.value=t+i+e))}),this.propsMap.geoObjects.add(o)):this.propsMap.geoObjects.get(0).geometry.setCoordinates([t[0],t[1]])},this)))},canUseRecommendList:function(){return this.pickUpPointsJSON&&this.pickUpPointsJSON.length},getRecommendedStoreIds:function(t){if(!t)return[];var e=[],s=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var i=0;i<s;i++){var o=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON}),p=o.getClosestTo(t),a=p.properties.get("storeId");this.storeQueryResult[a]=p,e.push(a),this.pickUpPointsJSON.splice(o.indexOf(p),1)}return e},getDistance:function(t,e){return!(!t||!e)&&(e=this.storeQueryResult[e],t=ymaps.coordSystem.geo.getDistance(t.geometry.getCoordinates(),e.geometry.getCoordinates()),Math.round(t/100)/10)},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(t){var e="";return t.ADDRESS&&(e+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(t.ADDRESS)+"<br />"),t.PHONE&&(e+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(t.PHONE)+"<br />"),t.SCHEDULE&&(e+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(t.SCHEDULE)+"<br />"),t.DESCRIPTION&&(e+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(t.DESCRIPTION)+"<br />"),e}};