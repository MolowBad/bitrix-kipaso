$(function(){var e,o;function i(){var o=ymaps.geolocation;o.city?$.getJSON(geoPositionAjaxDir+"/ajax.php",{act:"userPosition",latitude:o.latitude,longitude:o.longitude,city:o.city,country:o.country,isHighAccuracy:o.isHighAccuracy,region:o.region,zoom:o.zoom},function(o){("Y"!=o.ERROR?($('.geo-location-window-list-item-link[data-id="'+o.locationID+'"]').trigger("click"),$(".user-geo-position-value-link, .geo-location-window-city-value, .geo-location-ref-window-city-value").html(o.city),$(".geo-location-window-search-input").val(o.city).data("id",o.locationID),$(".geo-location-window-button").removeClass("disabled"),a):n)()}):n()}$resContainer=$(".geo-location-window-search-values"),"getPositionIncludeApi"in window&&!0===getPositionIncludeApi&&("YANDEX"==geoPositionEngine?((o=document.createElement("script")).src="//api-maps.yandex.ru/2.0/?load=package.standard&lang=ru-RU","undefined"!=typeof geoPositionYandexKey&&""!=geoPositionYandexKey&&(o.src+="&apikey="+geoPositionYandexKey),o.className="yaMapLoaderScript",document.body.appendChild(o),o.onload=function(){"object"==typeof ymaps&&"function"==typeof ymaps.ready&&ymaps.ready(i)},setTimeout(function(){"object"!=typeof ymaps&&$(".yaMapLoaderScript").remove()},1e3)):(o="undefined"!=typeof geoPositionKey&&""!=geoPositionKey?"//api.sypexgeo.net/"+geoPositionKey+"/json/":"//api.sypexgeo.net/",$.getJSON(o,function(o){void 0!==o.city.name_ru?$.getJSON(geoPositionAjaxDir+"/ajax.php",{act:"userPosition",latitude:o.city.lat,longitude:o.city.lon,city:o.city.name_ru,country:o.country.name_ru,isHighAccuracy:!1,region:o.region.name_ru,zoom:!1},function(o){("Y"!=o.ERROR?($('.geo-location-window-list-item-link[data-id="'+o.locationID+'"]').trigger("click"),$(".user-geo-position-value-link, .geo-location-window-city-value, .geo-location-ref-window-city-value").html(o.city),$(".geo-location-window-search-input").val(o.city).data("id",o.locationID),$(".geo-location-window-button").removeClass("disabled"),a):n)()}):n()})));function t(o){var i=(e=$(this)).data("id"),e=e.data("parse-value");return $(".geo-location-window-search-input").val(e).data("id",i),$(".geo-location-window-city-value").html(e),$(".geo-location-window-list").find(".geo-location-window-list-item-link").removeClass("selected").each(function(o,e){e=$(e);if(e.data("id")==i)return e.addClass("selected"),!1}),$(".geo-location-window-button").removeClass("disabled").addClass("modifed"),$resContainer.empty(),o.preventDefault()}var n=function(){"Y"!=(o=>{var e=" "+document.cookie,o=" "+o+"=",i=null,t=0,n=0;return 0<e.length&&-1!=(t=e.indexOf(o))&&(t+=o.length,-1==(n=e.indexOf(";",t))&&(n=e.length),i=unescape(e.substring(t,n))),i})("locationWindowClose")&&$("#geo-location-window").removeClass("hidden").appendTo("body")},a=function(){var o=$(".user-geo-position .user-geo-position-value-link"),e=$("#geo-location-ref-window"),i=$(window);if("Y"==e.data("disabled"))return!1;var t=e.width(),i=i.innerWidth(),n={left:o.offset().left-t/2,top:o.offset().top+42};e.appendTo($("body")),i<=1024||t+o.offset().left>i?e.addClass("visible centred"):e.addClass("visible").css({left:n.left,top:n.top})};$(document).on("keyup",".geo-location-window-search-input",function(o){var i=$(this),t=i.val();1<t.length&&!clearTimeout(e)&&(e=setTimeout(function(){var e,o;o=t,(e=i).addClass("loading"),$resContainer.empty(),$.getJSON(geoPositionAjaxDir+"/ajax.php?act=locSearch&query="+encodeURI(o),function(o){e.removeClass("loading"),"Y"!=o.ERROR&&$.each(o,function(o,e){$resContainer.append($("<div />",{class:"geo-location-list-item"}).append($("<a />",{class:"geo-location-list-item-link"}).html(e.COUNTRY_NAME+", "+e.CITY_NAME).attr("href","#").data("id",e.ID).data("parse-value",e.CITY_NAME)))})})},350))}),$(document).on("click",".geo-location-list-item-link",t),$(document).on("click",".geo-location-window-list-item-link",t),$(document).on("click",".geo-location-window-button",function(o){$(this).addClass("loading");return $.getJSON(geoPositionAjaxDir+"/ajax.php",{act:"setLocation",locationID:$(".geo-location-window-search-input").data("id")},function(o){"Y"==o.SUCCESS&&window.location.reload()}),o.preventDefault()}),$(document).on("click",".geo-location-window-exit",function(o){var e=new Date((new Date).getTime()+128e6);return document.cookie="locationWindowClose=Y; path=/; expires="+e.toUTCString(),$("#geo-location-window").hide(),o.preventDefault()}),$(document).on("click",".get-location-ref-window-confirm-button",function(){$(this).addClass("loading");return window.location.reload(),event.preventDefault()}),$(document).on("click",".user-geo-position-value-link, .get-location-ref-window-change-button",function(o){return $("#geo-location-window").removeClass("hidden").appendTo("body").show(),o.preventDefault()})});